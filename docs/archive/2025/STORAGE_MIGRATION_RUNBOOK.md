
# دليل تشغيل مهاجرات التخزين

> تاريخ الإنشاء: 6 أكتوبر 2025  
> آخر تحديث: 7 أكتوبر 2025  
> هذا الدليل يوضح كيفية تشغيل دالة `runStorageMigrations` لمراجعة مفاتيح التخزين، إعادة ترميز البيانات المتقادمة، وتوثيق النتائج.

## متى نُشغِّل المهاجرات؟

- بعد أي تغيير في مخطط البيانات (`schemaVersion`) ضمن `storageSchema.ts`.
- مباشرة بعد تدوير مفاتيح التشفير أو ترحيل `SecureStore` إلى جهاز جديد.
- عقب اكتشاف بيانات نصية غير مشفرة في `electron-store` أو أثناء التحقيق في تذاكر الأمان.
- قبل إصدار نسخة إنتاجية رئيسية لضمان توافق جميع القيم مع أحدث مخطط.

## المتطلبات المسبقة

1. الحصول على نسخة احتياطية حديثة لجميع المفاتيح الحساسة (راجع قسم النسخ الاحتياطية في `SECURITY_GUIDE.md`). يوصى بتشغيل `npm run backup:export -- --output=./backups/pre-migration.json` قبل بدء العمل لتأمين نسخة قابلة للاسترجاع.
2. إيقاف أي مهام مزامنة أو عمليات كتابة كثيفة لتجنب تضارب البيانات أثناء الترحيل.
3. التأكد من تثبيت بيئة التشغيل بامتيازات تسمح بالوصول إلى `SecureStore` وملف `electron-store`.

## خطوات التنفيذ

1. **تهيئة السياق**  
   نفِّذ المهاجرات من العملية الرئيسية لـ Electron أو من سكربت صيانة Node.js مع تهيئة `window.electronAPI` عبر قناة IPC. في بيئة الاختبار، يمكن استدعاء الدالة مباشرة بعد استيراد `src/utils/storage.ts`.

1. **تصفية التخزين قبل البدء**  
   نفّذ `prepareStorageForSuspend()` لضمان كتابة جميع القيم المعلقة إلى `SecureStore`/`electron-store` قبل الشروع في المهاجرات، واحتفظ بإخراج الدالة (إحصائيات `persisted`, `errors`) ضمن سجل التنفيذ. تُعيد الدالة نفس القناة المستخدمة أثناء التعليق (`system-lifecycle`) وتوفر تقريرًا سريعًا عن حالة التخزين.

1. **استدعاء الدالة**  
   شغّل الدالة التالية:

   ```ts
   import { runStorageMigrations } from '@/utils/storage';

   const report = await runStorageMigrations();
   console.table(
     report.entries.map(({ key, action, beforeVersion, afterVersion }) => ({ key, action, beforeVersion, afterVersion }))
   );
   ```

   استخدم المعامل `{ keys: [...] }` لتقييد النطاق أثناء التجارب.

1. **مراجعة التقرير**  
   يحتوي التقرير على الحقول التالية:

| الحقل | الوصف |
| --- | --- |
| `entries` | مصفوفة بنتيجة كل مفتاح تتضمن الإجراء (`upgraded`, `noop`, `removed-invalid`, `skipped`) والإصدارات قبل/بعد |
| `failures` | قائمة بالإخفاقات (إن وُجدت) مع الرسالة التفصيلية |
| `startedAt` / `finishedAt` | طوابع زمنية ISO8601 تساعد في تتبع مدة التنفيذ |

   خزِّن التقرير ضمن سجل التدقيق أو أرفقه بتذكرة المتابعة.

1. **معالجة الحالات الخاصة**  
   - إذا ظهرت حالة `removed-invalid`، يتم استرجاع البيانات من أحدث نسخة احتياطية ثم إعادة تشغيل المهاجرات للتأكد من سلامة المدخلات.
   - عند وجود مدخلات في `failures`, عالج السبب (مثلاً فشل الوصول إلى `SecureStore`) ثم أعد المحاولة.
   - تتم إضافة كل عملية ناجحة أو فاشلة تلقائيًا إلى `auditLog`، لكن يُنصح بتوثيق الملاحظات التكميلية (مثل رقم التذكرة أو اسم المنفذ) في تقرير التنفيذ.

1. **التوثيق والإنهاء**  
   حدِّث `DATA_INVENTORY.md` ودفاتر التشغيل ذات الصلة عند نجاح العملية، ثم فعِّل مراقبة السجلات لمدة 24 ساعة للتأكد من عدم ظهور أخطاء لاحقة في التخزين.

## خطة التراجع (Rollback)

| السيناريو | الإجراء |
| --- | --- |
| فقدان بيانات بعد `removed-invalid` | أعد تحميل النسخة الاحتياطية إلى `SecureStore`/`electron-store` ثم شغِّل المهاجرات مرة أخرى للتحقق |
| فشل شامل (انقطاع الطاقة/النظام) | استرجع نسخة النسخ الاحتياطي، تحقق يدويًا من الاتساق، ثم أعد تشغيل المهاجرات في نافذة صيانة جديدة |
| ظهور قيم غير متوقعة بعد `upgraded` | افحص `storageSchema.ts` بحثًا عن منطق التطبيع، عدِّل إن لزم، ثم أعد التشغيل مع تفعيل الاختبارات الآلية |

## اختبارات التحقق

- `tests/utils/storageSchema.test.ts`: يؤكد سلامة التطبيع ومخطط الأظرف لكل مفتاح.
- `tests/utils/storageMigration.test.ts`: يتحقق من إعادة الترميز للمفاتيح الحساسة وغير الحساسة وتوثيق نتائج التقرير.
- قبل الدمج، يجب تشغيل `npm run -s test -- tests/utils/storageMigration.test.ts` على الأقل لضمان عدم ظهور حالات كسر جديدة.

> **تنبيه:** تشغيل المهاجرات في بيئة الإنتاج يجب أن يتم أثناء نافذة صيانة معلنة، مع فريق الأمان أو البنية التحتية على استعداد لمعالجة أي أحداث طارئة.
