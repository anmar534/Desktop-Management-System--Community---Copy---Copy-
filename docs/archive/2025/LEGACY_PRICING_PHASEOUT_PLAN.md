# خطة التخلص المرحلي من البقايا القديمة (Legacy Pricing & Storage)

تاريخ: 2025-09-20

## الهدف

الوصول إلى قاعدة شيفرة خالية من أي مسارات ترحيل أو حراس legacy غير ضرورية، مع ضمان عدم فقدان بيانات المستخدمين، والحفاظ على ثبات النتائج الحسابية للمحرك.

## نطاق البقايا الحالية

1. ترحيل تسعير: محاولات قراءة `tender-pricing-{id}` داخل `pricingService`.
2. ترحيل مصاريف: استدعاءات `expensesService.migrateFromLegacy(...)` في:
   - `purchaseOrderService`
   - `useExpenses`
3. حارس التخزين: `installLegacyStorageGuard` مثبّت في `main.tsx`.
4. ملفات ترحيل عامة: `localStorageMigration.ts` (مرشح للأرشفة).
5. اختبارات تحاكي legacy (محاكاة حساب authoring):
   - `tests/pricing/authoringEngineParity.test.ts`
   - `test/hook.pricingDomainParity.test.ts`
6. تعليقات تاريخية داخل: `pricingHelpers.ts`, `pricingRuntimeMonitor.test.ts`.

## التصنيف حسب الإجراء

| التصنيف | العناصر | الإجراء | ملاحظات |
|---------|---------|---------|---------|
| حذف قريب | استدعاءات `migrateFromLegacy` المتكررة | استبدال بحارس (مرة واحدة) + تعطيل افتراضي | بعد تأكيد عدم وجود بيانات خارج unified |
| تعطيل تدريجي | ترحيل التسعير | عزل في دالة مستقلة + عدّاد + تحذير | ثم إزالة كاملة بعد إصدار لاحق |
| نقل للأرشيف | `localStorageMigration.ts` | نقل إلى `docs/archive/` | إبقاء مرجع تاريخي |
| إعادة تسمية/تحييد | اختبارات parity legacy | (منجز) إعادة تسمية وإزالة كلمة legacy | الحفاظ على القيمة التحليلية |
| إبقاء مؤقت | `installLegacyStorageGuard` | نقل لاحقاً لبيئة dev/test فقط | بعد شهر من الاستقرار |

## خارطة الطريق (Roadmap)

### المرحلة 0 (فورية)

1. إضافة ثابت `ENABLE_LEGACY_MIGRATIONS = false`.
2. تغليف `expensesService.migrateFromLegacy` بشرط ينفّذ مرة واحدة فقط إذا كان العلم مفعلاً.
3. إضافة TODO فوق مسار ترحيل التسعير.

### المرحلة 1

1. استخراج منطق ترحيل التسعير إلى `attemptLegacyPricingImport(tenderId)` مع تحذير.
2. اختبار جديد: التأكد أن `localStorage` لا يحوي أي مفتاح يبدأ بـ `tender-pricing-` وقت التشغيل (في بيئة الاختبار).
3. (منجز) إعادة تسمية `authoringEngineParity.test` إلى `authoringArithmeticParity.test.ts`.

### المرحلة 2

1. نقل الحارس إلى `src/legacy/legacyStorageGuard.ts` واستدعاؤه شرطياً في التطوير فقط.
2. نقل `localStorageMigration.ts` إلى `docs/archive/LOCAL_STORAGE_MIGRATION_LEGACY.ts` (أو حذفه إذا غير مستخدم).

### المرحلة 3 (إصدار لاحق)

1. إزالة دالة الاستيراد legacy للتسعير.
2. حذف جميع الأعلام / الثوابت المتعلقة بالترحيل.
3. تنظيف التعليقات التاريخية (نقلها للوثائق فقط).

## اعتبارات المخاطر

| خطر | تخفيف |
|-----|--------|
| فقدان بيانات مستخدم عاد من نسخة قديمة جداً | إبقاء المرحلة 0 لمدة إصدار واحد قبل حذف كامل |
| فشل غير متوقع في الاختبارات بسبب تغيير التوقيت | تنفيذ التعديلات على دفعات + تشغيل كامل للاختبارات بعد كل دفعة |
| انخفاض traceability بعد إزالة التعليقات | أرشفة التعليقات في هذا الملف وملفات الأرشيف |

## مؤشرات النجاح

1. لا توجد أي مكالمة runtime لـ `migrateFromLegacy` في سجلات الإنتاج.
2. لا تظهر مفاتيح legacy في تقارير التفتيش (أداة فحص/اختبار جديدة).
3. ثبات نتائج اختبارات parity بعد إعادة التسمية.

## متابعة

هذا الملف يُحدَّث مع كل مرحلة. عند إتمام المرحلة 3 يُنقل إلى `docs/archive`.
