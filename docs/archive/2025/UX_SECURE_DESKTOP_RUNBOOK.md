# UX Runbook – Secure Desktop Actions

> آخر تحديث: 8 أكتوبر 2025  
> النطاق: واجهة سطح المكتب بعد إغلاق المهمة S1.9

يغطي هذا الدليل آلية التعامل مع القناة الموحدة `desktop-secure-action` داخل الواجهة، مع التركيز على التدفقات التي تطلب أذونات التصدير أو تتكامل مع الجسر الأمني. الهدف هو منح فريق تجربة المستخدم والدعم التشغيلي خطوات واضحة لضمان سلوك متسق عند نجاح أو رفض الطلبات الحساسة.

## 1. نظرة عامة تشغيلية

- جميع طلبات الإشعارات، السحب والإفلات، والتصدير تمر عبر `authorizeDesktopNotification`, `authorizeDragAndDrop`, و`authorizeExport` في `desktopSecurity.ts`.
- أي رفض من العملية الرئيسية يولد رسالة صديقة للمستخدم في الواجهة بالإضافة إلى إدخال في سجل التدقيق (`app_security_audit_log`).
- يجب عدم استخدام روابط تنزيل عشوائية أو مسارات محلية؛ يتم إنشاء الملفات عبر Blob داخل الواجهة بعد الحصول على التفويض.

## 2. تدفقات التصدير المغطاة

| التدفق | نقطة الدخول | التنسيق | بيانات التعريف المرفقة | رسالة الواجهة عند الرفض |
| --- | --- | --- | --- | --- |
| تصدير CSV/JSON القياسي | صفحات التقارير والجداول التي تستدعي `exportToCSV/JSON` | CSV / JSON | `origin`, `rows`, `bytes` | "تم إلغاء التصدير بواسطة سياسات الأمان." |
| تحليل كشف الحساب البنكي | `Settings` → `BankStatementAnalyzer` | CSV (متوافق مع Excel) | إجمالي المعاملات، المشاريع، التصنيفات | "تم إلغاء تصدير التحليل البنكي بواسطة سياسات الأمان." |
| النسخ الاحتياطية النظامية | أدوات الصيانة التي تستدعي `exportBackupToFile` | JSON | رقم الإصدار، قائمة الأقسام | "لم يتم إنشاء ملف النسخة الاحتياطية. الرجاء التحقق من السياسات الأمنية." |

## 3. خطوات التحقق قبل الإطلاق

1. **تأكد من جاهزية التخزين**: انتظر حدث `system-storage-ready` أو تحقق من عدم ظهور حوار "جاري التحميل" قبل بدء التصدير.
2. **جمع المعطيات المطلوبة**:
   - للتحليل البنكي يلزم تحميل كشف بنكي صالح وتوليد التحليل (يظهر زر التصدير فقط بعد التحليل).
   - للنسخ الاحتياطية تأكد من توفر بيانات إيجابية في لوحة الإعدادات.
3. **نفّذ طلب التصدير**: الضغط على زر التصدير المعني. يجب أن يظهر التنزيل مباشرة في حال الموافقة.
4. **سجّل النتيجة**: في حال الرفض، التقط رسالة الواجهة ودوّنها مع معرف المستخدم والتاريخ.

## 4. إجراءات الدعم عند الرفض

1. افتح سجل التدقيق عبر أدوات المراقبة (`getAuditEvents` أو لوحة الإدارة) وابحث عن إدخالات `security.desktop.export-denied`.
2. راجع سبب الرفض الوارد في الحقل `metadata.reason` (قد يتضمن حجمًا يتجاوز الحد أو اسم ملف غير آمن).
3. قدّم للمستخدم توصيات فورية:
   - **أعد تسمية الملف** بحيث يخلو من الرموز الخاصة (`<>:"/\\|?*`).
   - **قلّص حجم البيانات** إذا تخطت الحدود (50 ميجابايت للتجميع الكامل أو 250 ألف صف للتقارير).
   - في حال استمرار الرفض، ارفع تذكرة إلى فريق المنصة مرفقة برسالة التدقيق.

## 5. مراقبة الجودة واختبارات الدخان

| الاختبار | الهدف | خطوات مختصرة |
| --- | --- | --- |
| `npm run -s test -- tests/utils/desktopSecurity.test.ts` | ضمان استمرار حدود التنقية على الجسر الأمني | يشغّل سيناريوهات السحب، التصدير، والإشعارات |
| تجربة التصدير البنكي يدويًا | تأكيد تدفق CSV من `BankStatementAnalyzer` | تحميل كشف تجريبي → توليد التحليل → تصدير → التحقق من اسم الملف المنقى |
| تصدير نسخة احتياطية | التأكد من تفويض JSON | من لوحة الإعدادات: تنفيذ النسخ الاحتياطي ثم تصدير النسخة الناتجة |

## 6. إرشادات تصميم الرسائل

- استخدم صيغة موجزة وواضحة: «تم إلغاء التصدير بواسطة سياسات الأمان.» مع رابط «التفاصيل» يفتح هذا الدليل مستقبلاً.
- أضف مؤشرًا بصريًا (Icon `ShieldAlert`) لأي رسالة رفض لتأكيد أن العملية حُجبت لأسباب حماية وليست خطأ عام.
- عند النجاح، لا تُظهر تنبيهًا إضافيًا؛ يكفي بدء التنزيل وترك سجل التدقيق لتأكيد العملية.

## 7. الأسئلة المتكررة

**س: لماذا نحصل على ملف CSV وليس XLSX في تحليل البنك؟**  
ج: تتم كتابة الملف بتنسيق CSV متوافق مع Excel لتقليل الاعتمادات على مكتبات ثقيلة، مع الاحتفاظ بالامتداد `.csv`. يمكن فتحه مباشرة في Excel أو Numbers.

**س: هل يمكن تجاوز سياسات الأذونات في بيئة التطوير؟**  
ج: لا. حتى في وضع التطوير تمر الطلبات عبر `authorizeExport`. في حالة انقطاع القناة يمكن تفعيل `ALLOW_UNGUARDED_DESKTOP_ACTIONS=true` أثناء تطوير معزول، لكن يحظر ذلك في النسخ الموزعة.

---

> لتحديث هذا الدليل، يرجى إضافة إدخالات changelog في قسم «إرشادات تصميم الرسائل» وتاريخ جديد أعلى الملف.
