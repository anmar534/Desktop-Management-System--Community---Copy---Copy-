# خطة تفكيك TenderPricingProcess

## نظرة عامة

- الهدف: نقل منطق تسعير العطاءات إلى وحدات أصغر وأكثر قابلية للصيانة بعد إزالة طبقة اللقطات القديمة.
- الحالة الحالية: تمت إزالة جميع مكونات snapshot، وتعمل الاختبارات بنجاح بعد التعديلات الأخيرة.

## خارطة الطريق

1. التدقيق والتحليل
   - جرد مسؤوليات `TenderPricingProcess.tsx` (الحالة، الهوكس، واجهة العرض، المزامنة).
   - حصر التبعيات والخدمات المستوردة لتحديد ما يحتاج إلى إعادة توجيه لاحقاً.
   - تسجيل النقاط الحرجة قبل البدء في التفكيك.
2. التنظيف التمهيدي
   - إزالة الوحدات/الدوال المهجورة المكتشفة أثناء التحليل.
   - التأكد من خلو التخزين من مفاتيح قديمة أخرى محتملة.
   - تحديث وثائق التغيير لتعكس الوضع الجديد.
3. هيكلة الاستيرادات
   - توحيد المسارات إلى المصادر الرسمية.
   - التأكد من مطابقة الاختبارات والقصص للهيكل الجديد.
   - تشغيل lint/tsc للتحقق قبل التفكيك.
4. تفكيك `TenderPricingProcess.tsx`
   - تقسيم الملف إلى هوكات ومكونات عرض وخدمات منفصلة.
   - نقل كل جزء إلى مجلد منظم ضمن `src/components/pricing/`.
   - إضافة اختبارات وحدات للأجزاء الجديدة.
   - ✅ استخراج العمليات الحسابية (التوتالات، المسودات، ملخص النسب) إلى الهوك `useTenderPricingCalculations`.
5. التحقق والضمان
   - تشغيل `npm run lint` و`npm run test`.
   - إجراء اختبار يدوي لتدفق التسعير.
   - تحديث التوثيق الداخلي والعمليات التشغيلية.
6. الإقفال
   - مراجعة التغييرات وإعداد الالتزام.
   - طلب مراجعة الكود مع ملخص التغييرات.

## التقدم الحالي

- إزالة منظومة snapshot بالكامل (الملفات، التخزين، المفاتيح، الاختبارات).
- تحديث `StorageManager` لتنظيف المفاتيح القديمة تلقائياً.
- نجاح `npm run -s test` بعد التعديلات الأخيرة.
- إنجاز خطوة 1.1: توثيق المسؤوليات والتبعيات الأساسية للملف.
- ✅ إحلال الأنواع الصريحة لمعالجات قوالب التسعير في `TenderPricingProcess.tsx` وإزالة تحذيرات lint المتعلقة بها.
- ✅ توحيد `PricingTemplateManager` مع الأنواع المشتركة في `@/types/templates` لوقف الازدواجية قبل أي تفكيك إضافي.

## مرحلة 2 – التنظيف التمهيدي

- ✅ إزالة تسجيلات التصحيح المباشرة في `TenderPricingProcess.tsx` وربطها بمستوى تصحيح قابل للتعطيل.
- ✅ حذف مسار الاختبارات القديم `SnapshotStorage.test.ts` واستبداله باختبار تنظيف `StorageCleanup.test.ts` للتحقق من سلوك التخزين الجديد.
- ✅ توسيع `StorageManager` لإزالة مفاتيح snapshots القديمة (`app_pricing_snapshots`, `PRICING_SNAPSHOTS`, `tender_snapshot_*`, `backup-tender-pricing-*`) مع تسجيل حدث تدقيق عند التنظيف.
- ✅ تحديث `TenderPricingProcess.tsx` والوثائق (`docs/DATA_INVENTORY.md`) لإزالة أي إشارات إلى نظام snapshots القديم وتوثيق حالة التخزين الحالية.

> الحالة: مكتملة، جاهزون للانتقال إلى مرحلة 3 الخاصة بهيكلة الاستيرادات.

## مرحلة 3 – هيكلة الاستيرادات

- ✅ توحيد استيرادات `TenderPricingProcess` والمكوّنات الداعمة (`TechnicalFilesUpload`, `PricingTemplateManager`) على مسار `@/` الرسمي لتفادي المسارات النسبية قبل التفكيك.
- ✅ تحديث اختبار `StorageCleanup.test.ts` ليتبع نفس البنية الجديدة، وضمان مطابقة الأدوات المساعدة بعد التعديلات.
- ⏳ التحقق المستمر عبر lint/tests بعد كل تعديل أثناء المرحلة لضمان الاستقرار قبل مرحلة التفكيك.

## مرحلة 1.1 – تحليل أولي لـ `TenderPricingProcess.tsx`

- **المسؤوليات الأساسية**
- إدارة دورة حياة تحرير التسعير: تحميل البيانات، متابعة التعديلات، حفظ المسودات والنسخة الرسمية، وإطلاق الحفظ الاحتياطي.
- تنسيق واجهات الاستخدام: علامات التبويب، البطاقات، النوافذ الحوارية، ونماذج إدخال القيم الافتراضية.
- ربط الخدمات المركزية: `useEditableTenderPricing`, `pricingService`, `pricingDataSyncService`, `useSystemData` لضمان تزامن بيانات الـ BOQ والتندر.
- حساب المترولوجيا المساعدة: تنسيقات الأرقام والتواريخ، نشر النسب الافتراضية، تشغيل `enrichPricingItems` للمقارنات.
- إدارة النسخ الاحتياطية والمرفقات الفنية: التكامل مع `backupManager`, تحميل الملفات التقنية، واستعادة النسخ عند الطلب.

- **التبعيات الرئيسية (حسب الفئة)**
- **خدمات التطبيق**: `pricingService`, `pricingDataSyncService`, `useEditableTenderPricing`, `useSystemData`, `getBOQRepository`.
- **مرافق التخزين/النسخ الاحتياطي**: `saveToStorage`, `loadFromStorage`, `safeLocalStorage`, وظائف `backupManager`.
- **أدوات التسعير**: `enrichPricingItems`, `PRICING_FLAGS`, `useDomainPricingEngine`, `applyDefaultsToPricingMap`.
- **واجهة المستخدم**: مكونات البطاقات، الأزرار، القوائم، علامات التبويب، الحوارات، بالإضافة إلى أيقونات `lucide-react`.
- **خدمات مساعدة**: `useCurrencyFormatter`, `formatDateValue`, `debounce`, حافلة الأحداث `APP_EVENTS`.

- **نقاط حرجة للتفكيك**
- تداخل حالة الواجهة مع منطق الأعمال (مثل إدارة المؤشرات الحالية، التبويب النشط، حالات التحذير قبل المغادرة).
- وظائف الحفظ والتزامن (المهام المتسلسلة التي تستدعي خدمات متعددة) مرشحة للنقل إلى هوك/خدمة منفصلة.
- كتل كبيرة مسؤولة عن تجهيز جداول الكميات والمخرجات الحسابية تحتاج إلى فصل ضمن وحدات مساعدة مستقلة.
