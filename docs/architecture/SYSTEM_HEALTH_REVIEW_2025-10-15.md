# مراجعة صحة معمارية النظام

**التاريخ:** 2025-10-15  
**المراجع:** GitHub Copilot (ذكاء اصطناعي)

## نطاق المراجعة ومنهجيتها

- تم التركيز على مراجعة شجرة الشيفرة التشغيلية ضمن مجلد `src/` إلى جانب أهم وثائق التشغيل في `docs/`.
- شملت الدراسة التفصيلية كلاً من `src/App.tsx`، و`src/main.tsx`، و`src/application/context/FinancialStateContext.tsx`، ومستودعات البيانات تحت `src/repository/providers/`، وأدوات التخزين في `src/utils/storage.ts`، وتهيئة Electron في `src/electron/main.cjs`، بالإضافة إلى محددات النطاق المالي في `src/domain/selectors/financialMetrics.ts`.
- تمت الاستفادة من أدلة الاختبارات الموثقة في `docs/testing/FINAL_TEST_STATUS_REPORT.md`.
- لم يتم إعادة التحقق من الملفات الثنائية الكبيرة أو المجلدات المؤرشفة بشكل تفصيلي.

## نظرة عامة على النظام

- **التقنيات الرئيسة:** React 18 وTypeScript وVite ضمن غلاف Electron (`package.json` يشير إلى `src/electron/main.cjs`). يعتمد التصميم على TailwindCSS ومكونات Radix UI ومكتبة shadcn.
- **نموذج التشغيل:** يبدأ التطبيق من `src/main.tsx` مع فرض الاتجاه من اليمين لليسار وتعيين اللغة العربية، وينتظر جاهزية التخزين قبل تحميل `App`.
- **هيكل التطبيق:** يقوم `src/App.tsx` بتجميع الواجهات من خلال `import.meta.glob` مع حقن مزودي السمات والمستودعات والملاحة والحالة المالية لتغطية الاهتمامات المشتركة.
- **تقسيم النطاق:** تُقسم الشيفرة إلى طبقات `application/` و`domain/` و`repository/` و`features/` و`utils/` بما يعكس مبادئ المعمارية النظيفة (واجهة مستخدم ← خدمات التطبيق ← المستودعات ← التخزين).
- **استمرارية البيانات:** واجهة تخزين موحدة في `src/utils/storage.ts` تربط بين `electron-store` والتخزين الآمن المدعوم بـ keytar والبديل المحلي في المتصفح. تستخدم المستودعات غلاف `safeLocalStorage` مع مفاتيح من `src/config/storageKeys.ts`.
- **الأحداث والرسائل:** حافلة أحداث خفيفة في `src/events/bus.ts` تُنسق تحديثات الحالة بين الخطافات.

## التوافق مع أفضل الممارسات

### نقاط القوة

- حدود واضحة بين الوحدات بفضل واجهات المستودعات (`src/repository/*.ts`) وسجل الخدمات القابل للتهيئة (`src/application/services/serviceRegistry.ts`).
- إدارة ناضجة لمخططات التخزين بما في ذلك الترقيات وتدقيق السجلات وتشفير الحمولات الحساسة.
- منطق المجال محفوظ في حزم محددات وخدمات تخصصية (مثل محددات المؤشرات المالية في `src/domain/selectors/financialMetrics.ts`).
- مكتبة توثيق واسعة في `docs/` تغطي النشر والأمان والتصميم والاختبارات.
- عملية Electron الأساسية تطبق ضوابط أمان (سياسة أمن المحتوى، سجلات التدقيق، تشفير التخزين، فحوصات التحديث، تأكيدات دورة الحياة).

### الفجوات

- البناء الموجّه للويب يعتمد على واجهات Electron للتخزين؛ في المتصفح ينخفض الأداء إلى تخزين في الذاكرة دون تشفير، ما يضعف تجربة المستخدم وسلامة البيانات خارج Electron.
- تطبيقات المستودعات تستخدم `safeLocalStorage` المتزامن المدعوم بذاكرة مؤقتة؛ ما يزيد خطر ضياع البيانات عند تعطل العملية ويفتقر إلى آليات فض النزاعات أو خطط ترحيل متماسكة.
- ملفات المرافق الجوهرية (`src/utils/storage.ts` و`src/electron/main.cjs`) تتجاوز ألف سطر، ما يقلل قابلية الصيانة ويرفع احتمال الأخطاء.
- التعرف على الوحدات عبر `import.meta.glob` يفتقر إلى اختبارات تحقق تضمن وجود كل مكوّن مشار إليه.
- التوثيق ما زال يشير إلى أن التطبيق "ويب خالص" (انظر `src/TECHNICAL_DOCUMENTATION.md`) بينما ما زال إطار Electron فاعلاً، ما يخلق فجوة في التوقعات.
- حزمة الاختبارات الآلية تتضمن 568 اختباراً قديماً متعطلاً بحسب `docs/testing/FINAL_TEST_STATUS_REPORT.md`، الأمر الذي يضعف موثوقية مؤشر الاختبارات رغم وجود اختبارات تكامل حديثة.

## نتائج تفصيلية

### المعمارية والتقسيم الوحدوي

- يتولى `src/App.tsx` تنظيم التنقل بين المقاطع عبر مخطط الملاحة مع تحميل كسول للمكونات؛ غياب الضمانات الزمنية للتجميع حول مسارات `node.view.module` قد يؤدي لأخطاء أثناء التشغيل.
- مزودو السياق مثل `FinancialStateProvider` و`NavigationProvider` يجمعون العمليات التجارية، لكنهم يعيدون الجلب عند التهيئة وكل حدث تخزين؛ يُنصح بإدخال طبقة تخزين مؤقت أو آلة حالات لتقليل الطلبات.
- آلية التحديث تعتمد على مستمعي `window`؛ في البيئات غير المرتبطة بـ DOM (مثل الاختبارات أو SSR) تتوقف الخطافات. يُفضَّل توفير تجريد بديل للسيناريوهات الرأسية.

### البيانات ومصدر الحقيقة

- مفاتيح التخزين موحدة في `src/config/storageKeys.ts` لضمان مصدر واحد للحقيقة.
- مزود الحالة المالية يجمع بيانات الخطافات المتخصصة (`useInvoices`، `useBudgets` ...) ويقدم المؤشرات المجمّعة وأزرار التحديث بما يتماشى مع التصميم الموجّه للمجال.
- رغم ذلك، ما زال يُستدعى `safeLocalStorage` مباشرة في توافقات متعددة مثل `src/hooks/useBOQ.ts` ومزودي المستودعات، ما يتجاوز الطبقة الخدمية ويعرض البيانات للتضارب.
- نماذج البيانات في `src/data/centralData.ts` تحتوي حقولاً موروثة وتعليقات على كيانات ملغاة؛ يلزم تنظيف إضافي لتقليل الانحراف المستقبلي.

### طبقة التخزين والاستمرارية

- يوفر `src/utils/storage.ts` قدرات واسعة (مغلفات مخطط، ترحيل آمن، أحداث تدقيق) لكنه أصبح معنيّاً بالتخزين المؤقت والترحيل والتحليلات والأحداث وأدوات التطوير في ملف واحد؛ يُستحسن تفكيكه إلى وحدات أصغر.
- جسر التخزين الآمن في `src/utils/secureStore.ts` يعود إلى التخزين في الذاكرة عند غياب واجهة Electron preload، ما يعني فقدان الاستمرارية والتشفير في نسخة الويب.
- إجراءات الترحيل تعتمد المرور التسلسلي على كل المفاتيح عند بدء التشغيل؛ البيانات الضخمة قد تؤخر الإقلاع، لذلك يُنصح بالترحيل المتدرج مع تتبع للتقدم.

### منطق المجال والحسابات

- محددات المؤشرات المالية تمزج حلقات حسابية مع خدمات مجال متخصصة، وتقبل بدائل قابلة للحقن لتسهيل الاختبارات. ينبغي ضمان تطبيع الأنواع العددية مبكراً للحد من تحويلات الطوارئ أثناء الحساب.
- مراقب التسعير في `src/main.tsx` يعتمد على أعلام من `utils/pricingHelpers` ويعمل بشكل دوري؛ يجب ضمان تحميل كسول للوظائف الاختيارية وتسجيل الأخطاء دون تعطيل الواجهة.

### الأمان والامتثال

- عملية Electron الرئيسية تشفر البيانات الحساسة باستخدام AES-GCM ومفاتيح مُدارة عبر keytar، مع مسح دوري للمفاتيح المخزنة في الذاكرة (`releaseCachedSecureKey`).
- يتم استدعاء `ipcGuard.cjs` للتحقق من سلامة حمولة IPC، ويُوصى بالتدقيق الدوري لضمان الالتزام في جميع نقاط الاتصال.
- توجد آلية لإنشاء سياسة أمن المحتوى وسجل للتدقيق، لكن لا توجد اختبارات آلية تؤكد التفعيل؛ من المهم إضافة اختبارات دخان للتأكد من سلامة العناوين وسلوك تدوير السجلات.

### الاختبارات وضمان الجودة

- حزمة Vitest التكاملية (`tests/integration/system-e2e.test.ts`) تغطي المسارات الحرجة بشكل شامل.
- وجود 568 اختباراً موروثاً متعطلاً يسبب ضوضاء كبيرة؛ من الأفضل عزلها في مجلد `_legacy` أو حذفها لاستعادة موثوقية النتائج.
- لا تتوفر تغطية آلية لترحيل التخزين أو تهيئة المستودعات أو تحقق مخطط الملاحة؛ يجب إضافة اختبارات وحدات تضمن ثبات السلوك قبل البدء في إعادة الهيكلة.

### التوثيق والعمليات

- التوثيق ثري لكنه يتضمن بيانات قديمة مثل الإشارة إلى إزالة Electron؛ الإبقاء على سجل صحي للتوثيق مرتبط بكل إصدار سيحد من التناقضات.
- سكربتات `package.json` تغطي التنسيق والـ Storybook والفحوصات الأمنية، لكن مهام تحليل الحِمل والأداء ما تزال مجرد أوامر صورية؛ ينبغي تنفيذ أدوات حقيقية أو إزالة الأوامر الوهمية.

## التوصيات التحسينية

### عاجلة (من 0 إلى أسبوعين)

1. عزل أو إزالة ملفات الاختبارات المتوقفة لإعادة المؤشر إلى اللون الأخضر وتحديث معايير التكامل المستمر.
2. إنشاء اختبار دخان آلي يتحقق من أن كل تعريف في مخطط الملاحة يرتبط بمكون فعلي.
3. توثيق قيود التخزين الآمن في وضع المتصفح وتعطيل الميزات التي تتطلب تشفيراً دائماً خارج Electron.

### قريبة المدى (من شهر إلى ثلاثة أشهر)

1. تفكيك `src/utils/storage.ts` إلى وحدات مستقلة (واجهة تخزين، جسر آمن، ترحيل، تحليلات) مع تغطية اختبارية لمسارات الترحيل والأخطاء.
2. توحيد مسارات الكتابة على البيانات عبر المستودعات؛ مراجعة جميع الاستدعاءات المباشرة لـ`safeLocalStorage` وتحويلها إلى طبقة الخدمات.
3. تحديث `src/TECHNICAL_DOCUMENTATION.md` والوثائق المرتبطة لتعكس الاعتماد الحالي على Electron.
4. إضافة اختبارات استمرارية تتحقق من دورات التشفير وفك التشفير عبر الجسر الآمن وسيناريوهات تهيئة الذاكرة المؤقتة.

### استراتيجية (من ثلاثة إلى ستة أشهر)

1. دراسة الانتقال إلى قاعدة بيانات مضمنة (مثل SQLite عبر better-sqlite3) للحصول على معاملات وضمانات استرجاع أفضل مقارنة بملفات JSON.
2. بناء طبقة إضافية لمخطط الملاحة (Module Federation أو نظام إضافات) لطرح الميزات تدريجياً مع الاعتماد على أعلام خصائص منظمة.
3. توسيع الرصد والقياس عبر دمج Sentry في الواجهة والمجالات وطبقة التشغيل مع لوحات متابعة وإصدارات مرقبة.
4. تأسيس اختبارات أمنية آلية تتضمن تحفيز قنوات IPC والتحقق من سياسة أمن المحتوى وهجمات التلاعب بالتخزين الآمن ضمن خط بناء Electron.

## الملحق أ: خريطة الوحدات الحالية

- **واجهة المستخدم:** `src/App.tsx`، ومجلدات `src/components/` و`src/features/`.
- **خدمات التطبيق:** `src/application/context/`، و`src/application/hooks/`، و`src/application/services/`.
- **طبقة المجال:** `src/domain/selectors/` و`src/domain/services/`.
- **طبقة التخزين:** `src/repository/`، و`src/utils/storage.ts`، و`src/utils/secureStore.ts`.
- **عملية Electron:** مجلد `src/electron/`.
- **التهيئة:** مجلد `src/config/`.
- **الاختبارات:** مجلد `tests/` بأنواعه (وحدات، تكامل، تكامل شامل) مع التوثيق في `docs/testing/`.

---
تعكس هذه المراجعة حالة الشيفرة بتاريخ 2025-10-15. تنفيذ التحسينات المقترحة سيدفع نظام إدارة سطح المكتب نحو التوافق مع أفضل الممارسات الحديثة من حيث القابلية للصيانة والأمان وقابلية المراقبة.
