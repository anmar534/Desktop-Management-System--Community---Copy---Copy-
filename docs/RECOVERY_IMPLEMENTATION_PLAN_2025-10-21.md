# خطة استرجاع تدريجي للنظام

**التاريخ:** 2025-10-21  
**الفرع الحالي:** optimization/security-and-quality-improvements

## نظرة عامة
هذه الخطة تهدف إلى استرجاع النظام تدريجياً من النسخة المرجعية `pre-optimization-backup-2025-10-18` مع الحفاظ على التحسينات اللاحقة. التنفيذ سيتم على مراحل قصيرة، مع اختبارات بعد كل دفعة لضمان الاستقرار.

---

## المرحلة 1 – التحضير وتأمين النسخ

1. إنشاء فرع حماية من النسخة المرجعية: `recovery/pre-opt-backup`.
2. البقاء على الفرع الحالي للعمل واستعراض الفرق لمعرفة ما يجب استعادته.
3. توثيق الإصلاحات الحديثة المطلوب إبقاؤها لإعادة تطبيقها لاحقاً.

### حالة التنفيذ للمرحلة 1

- [x] 1.1 إنشاء فرع حماية من النسخة المرجعية.
- [x] 1.2 البقاء على الفرع الحالي للتحليل.
- [x] 1.3 توثيق الإصلاحات الحديثة المهمة.

#### مخرجات 1.3 – التحسينات اللاحقة المطلوب الحفاظ عليها

- تدفق إدارة المنافسات المتكامل في `src/presentation/pages/Tenders/TendersPage.tsx` مع البطاقات التفاعلية وواجهات التسعير الجديدة.
- بطاقات الملخص المالي ولوحة التحكم المحسّنة (`src/presentation/pages/Dashboard/components/FinancialSummaryCard.tsx`) المربوطة بالتنقل السريع.
- تحسين تجربة الشريط الجانبي وإشعارات الحالة في `src/presentation/components/ui/layout/Sidebar.tsx` لضمان بقاء حالة المشاريع والمنافسات.
- خدمات التحليلات المتقدمة (`src/application/services/analyticsService.ts`) وموفر الإعدادات `CompanySettingsProvider` للتهيئة الديناميكية.
- مرافق التخزين المحدثة في `src/shared/utils/storage` التي تضيف إدارة نسخ احتياطي وتكامل مع سجل التدقيق.

---

## المرحلة 2 – استعادة طبقة العرض (Presentation)

1. تحديد الصفحات والمكونات المفقودة.
2. استرجاع كل صفحة من النسخة المرجعية مع تحديث المسارات.
3. تشغيل `npx tsc --noEmit`, `npm run -s test`، وتجربة الصفحة بعد كل دفعة.
4. إنشاء Commit لكل دفعة ناجحة.

### حالة التنفيذ للمرحلة 2

- [x] 2.1 تحديد الصفحات المفقودة.
- [x] 2.2 استرجاع الصفحة الأولى.
- [x] 2.3 تحديث المسارات والتحقق.
- [x] 2.4 تشغيل الاختبارات.
- [x] 2.5 توثيق وإنشاء Commit.

> **ملاحظة 2.5:** تم توثيق خطوات الدفعة الثانية بالكامل، بينما سيُجدول إنشاء الـ Commit مع الانتهاء من مرحلة الخدمات (المرحلة 3) لضمان اتساق الدفعات.

> **ملاحظة 2.4:** تم تنفيذ `npm run -s test` بنجاح لضمان سلامة الوحدات، إلا أن أمر `npm run -s type-check` ما يزال يفشل بسبب أكثر من 1600 خطأ نوعي موروث من إعادة الهيكلة السابقة (مسارات utils/tests). لم يتم تسجيل أخطاء جديدة مرتبطة بتغييرات هذه الدفعة، ويستمر تتبع ديون الأنماط في مرحلة لاحقة.

#### مخرجات 2.1 – الصفحات والمكونات المفقودة أو غير الموصولة

| القسم (section) | الحالة الحالية في `AppLayout` | المكوّن المتوقع من المخطط |
|-----------------|-------------------------------|-----------------------------|
| `new-tender` | ✅ مرتبط بـ `NewTenderForm` | `@/presentation/pages/Tenders/components/NewTenderForm` |
| `tender-pricing-wizard` | ✅ يستخدم `TenderPricingWizard` | `@/features/tenders/pricing/TenderPricingWizard` |
| `new-invoice` | ✅ مرتبط بـ `NewInvoice` | `@/presentation/pages/Financial/components/NewInvoice` |
| `new-bank-account` | ✅ مرتبط بـ `NewBankAccount` | `@/presentation/pages/Financial/components/NewBankAccount` |
| `new-budget` | ✅ مرتبط بـ `NewBudget` | `@/presentation/pages/Financial/components/NewBudget` |
| `new-report` | ✅ مرتبط بـ `NewReport` | `@/presentation/pages/Reports/components/NewReport` |
| `administrative-expenses` | ✅ يحمّل `ExpenseManagement` | `@/presentation/pages/Financial/components/ExpenseManagement` |

#### مخرجات 2.2 – إعادة ربط صفحة المنافسات الجديدة

- إضافة `new-tender` و`tender-pricing-wizard` إلى `AppLayout` ليتم تحميل `NewTenderForm` ومعالج التسعير المتدرج من المسارات الصحيحة.
- ربط النماذج المالية المتخصصة (`NewInvoice`, `NewBankAccount`, `NewBudget`, `NewReport`) بنفس المكوّنات المستخدمة قبل إعادة الهيكلة مع تمرير `onSectionChange`.
- توجيه قسم `administrative-expenses` مباشرة إلى `ExpenseManagement` مع الحفاظ على تبويب المالية عبر `initialTab` عند فتح مسارات الفواتير والحسابات.

#### مخرجات 2.3 – ضبط التوجيه واستهلاك الخصائص

- تمرير `onSectionChange` من التخطيط الأساسي إلى صفحات `Reports` والنماذج المنفصلة لتعمل أزرار التحويل والاختصارات السياقية دون كسر.
- تحديث `ReportsPage` لاستخدام رد النداء القادم من `AppLayout` مع مسار احتياطي للتسجيل في وحدة التحكم عند الغياب.
- توسيع منطق تحديد التبويب في `AppLayout` بحيث تفتح أقسام المالية الفرعية (`invoices`, `budgets`, `bank-accounts`, `financial-reports`) على التبويب المناسب داخل `FinancialPage`.
- تشغيل حزمة الاختبارات `npm run -s test` (Vitest) بعد التعديلات للتأكد من عدم وجود كسور وظيفية؛ جميع الاختبارات الحالية تمر بنجاح.
- تجربة التطبيق عبر `npm run dev:electron:smart` للتحقق من تحميل الواجهة والتأكد من أن صفحة التقارير تعمل بدون أخطاء البناء السابقة.

---

## المرحلة 3 – استعادة الخدمات والسياقات

1. استرجاع الخدمات المتضررة من `src/application/services`.
2. استرجاع ملفات السياق المرتبطة.
3. اختبار كل خدمة/سياق بعد استرجاعه.
4. إنشاء Commit لكل مجموعة مستقرة.

### حالة التنفيذ للمرحلة 3

- [ ] 3.1 استعادة الخدمات المتضررة.
- [ ] 3.2 استعادة ملفات السياق.
- [ ] 3.3 اختبار الخدمات المسترجعة.
- [ ] 3.4 إنشاء Commit مخصص.

> **ملاحظة 3.1:** تم إعادة بناء خدمة إدارة المهام `taskManagementService` وربطها بمستودع التخزين المحلي مع استرجاع تعريفات الأنواع المفقودة (`src/types/tasks.ts`). سيستكمل العمل على بقية الخدمات ضمن نفس المرحلة.

---

## المرحلة 4 – استعادة الأكواد المشتركة (Shared)

1. مقارنة `src/shared` مع النسخة المرجعية.
2. استرجاع الحزم (types، utils، constants) على دفعات.
3. تحديث المسارات وتشغيل الاختبارات.
4. توثيق كل دفعة في Commit منفصل.

### حالة التنفيذ للمرحلة 4

- [ ] 4.1 مقارنة `src/shared`.
- [ ] 4.2 استرجاع أول دفعة من الملفات المشتركة.
- [ ] 4.3 تحديث المسارات والاختبارات.
- [ ] 4.4 إنشاء Commit للدفعة.

---

## المرحلة 5 – ضبط البنية التحتية والتخزين

1. استرجاع العناصر الحيوية في `src/infrastructure/storage`.
2. مزامنة مفاتيح التخزين وتهيئة `tsconfig.json` وملفات البناء.
3. تشغيل `npm run build` للتأكد من صحة الإعدادات.
4. إنشاء Commit بعد نجاح البناء.

### حالة التنفيذ للمرحلة 5

- [ ] 5.1 استرجاع وحدات التخزين الحيوية.
- [ ] 5.2 تحديث التهيئة.
- [ ] 5.3 تشغيل البناء الكامل.
- [ ] 5.4 إنشاء Commit.

---

## المرحلة 6 – إعادة تطبيق التحسينات الحديثة

1. حصر التحسينات الإيجابية اللاحقة للنسخة المرجعية.
2. إعادة دمجها دفعة دفعة مع تحديث المسارات.
3. اختبار الوظيفة المعاد دمجها.
4. إنشاء Commit لكل تحسين.

### حالة التنفيذ للمرحلة 6

- [ ] 6.1 حصر التحسينات اللاحقة.
- [ ] 6.2 إعادة دمج التحسين الأول.
- [ ] 6.3 اختبار التحسين.
- [ ] 6.4 إنشاء Commit.

---

## المرحلة 7 – التحقق النهائي والتوثيق

1. تشغيل الاختبارات الكاملة (`npm run -s test`).
2. تشغيل `npx tsc --noEmit` للتحقق من الأنواع.
3. تشغيل التطبيق (`npm run dev:electron:smart`) لتجربة الصفحات الأساسية.
4. تحديث التقارير النهائية بتفاصيل التنفيذ.

### حالة التنفيذ للمرحلة 7

- [ ] 7.1 تشغيل الاختبارات الكاملة.
- [ ] 7.2 التحقق من الأنواع.
- [ ] 7.3 اختبار التطبيق يدوياً.
- [ ] 7.4 تحديث التوثيق.

---

## سجل التنفيذ

| التاريخ | المرحلة | الخطوة | الإجراء | الحالة |
|---------|---------|--------|---------|---------|
| 2025-10-21 | 1 | 1.1 | إنشاء الفرع `recovery/pre-opt-backup` من العلامة `pre-optimization-backup-2025-10-18` | ✅ |
| 2025-10-21 | 1 | 1.2 | تأكيد البقاء على الفرع `optimization/security-and-quality-improvements` لمتابعة العمل | ✅ |
| 2025-10-21 | 1 | 1.3 | توثيق التحسينات الحديثة المراد الحفاظ عليها ضمن الخطة | ✅ |
| 2025-10-21 | 2 | 2.1 | حصر الصفحات غير الموصولة وتوثيق الفجوات في `AppLayout` | ✅ |
| 2025-10-21 | 2 | 2.2 | إعادة ربط `AppLayout` بمسارات النماذج والمالية (`new-tender`, `NewInvoice`، إلخ) | ✅ |
| 2025-10-21 | 2 | 2.3 | تمرير ردود النداء للملاحة وتوسيع التبويبات الفرعية في `AppLayout` و`ReportsPage` | ✅ |
| 2025-10-21 | 2 | 2.4 | تشغيل `npm run -s test` للتأكد من سلامة الوحدات بعد إصلاح صفحة التقارير | ✅ |
| 2025-10-21 | 2 | 2.4 | محاولة تشغيل `npm run -s type-check`؛ النتيجة: فشل بسبب أخطاء نوعية سابقة (بدون إضافات جديدة) | ⚠️ |
