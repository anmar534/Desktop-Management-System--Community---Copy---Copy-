# دليل الأمان وإدارة المفاتيح

> تاريخ الإنشاء: 4 أكتوبر 2025  
> تاريخ آخر تحديث: 7 أكتوبر 2025  
> يغطي هذا الدليل سياسة إدارة المفاتيح، ممارسات التشفير، وإجراءات الطوارئ الخاصة بمنصة سطح المكتب.

## مبادئ عامة

1. **البيانات الحساسة يجب ألا تُخزن كنص صريح** على القرص. يتم تشفير جميع الحقول المحددة في نموذج التهديدات باستخدام `SecureStore`.
2. **المفاتيح السرية لا تُحفظ داخل الشفرة المصدرية أو ملفات التكوين**؛ يتم الاعتماد على `keytar` لتخزين مفاتيح AES في مخزن نظام التشغيل.
3. **كل عملية وصول للبيانات الحساسة تُسجل تلقائيًا** عبر سجل أحداث مركزي (`auditLog`) مع ختم زمني، مستوى خطورة، وبيانات إضافية قابلة للتصدير.
4. **النسخ الاحتياطية تخضع لسياسة FIFO مع حد أقصى للتخزين** ويتم إخطار المستخدم عند فشل النسخ الاحتياطي لأكثر من محاولتين.

## إدارة المفاتيح

| البند | السياسة |
| --- | --- |
| خوارزمية التشفير | AES-256-GCM مع IV بطول 12 بايت، ومُلصق مصادقة 16 بايت |
| تخزين المفاتيح | `keytar` ضمن خدمة `DesktopManagementSystem` والحساب `secure-store-master-key` (تتم إعادة استخدامه مع كل استدعاءات `SecureStore`) |
| إنشاء المفاتيح | يتم إنشاء المفتاح تلقائيًا عند تشغيل التطبيق لأول مرة بعد تطبيق S1.1 |
| تدوير المفاتيح | تدوير نصف سنوي، مع تخطيط عملية ترحيل سلسة وتوثيقها؛ يجري التنفيذ بعد S1.2 |
| نسخ احتياطي للمفاتيح | يتم تخزين نسخة مشفرة للمفتاح في مستودع آمن منفصل عن قاعدة المستخدمين (ينفذها فريق البنية التحتية) |
| الوصول إلى المفاتيح | يقتصر على العملية الرئيسية لـ Electron، ولا يتم تعريض المفتاح للعملية المرئية (renderer) |

### إجراءات فقدان المفتاح

1. محاولة استرجاع نسخة احتياطية مشفرة للمفتاح من القناة الرسمية.
2. إذا تعذر الاسترجاع، يتم إنشاء مفتاح جديد وإعادة تهيئة البيانات الحساسة من آخر نسخة احتياطية متاحة.
3. توثيق الحادثة في سجل الأمن وتقييم الأثر على البيانات.

## سياسة النسخ الاحتياطي

| عنصر | السياسة |
| --- | --- |
| نطاق النسخ | بيانات التسعير، النسخ الاحتياطية للمناقصات، الحسابات البنكية |
| التواتر | لكل عملية حفظ حرجة + جدولة ليلية (عبر قناة النظام) |
| آلية التدوير | مصفوفة احتفاظ تلقائية (حاليًا: 10 نسخ / 30 يومًا لكل مناقصة) مع تقليم فوري للأقدم |
| المراقبة | تسجيل كل محاولة في سجل التدقيق + أحداث نظام (`backup-completed`, `backup-failed`) |
| التخزين | حفظ النسخ المشفرة داخل `SecureStore`، مع إمكانية التصدير عبر سكربت `backup:export` |
| معالج التسعير | يتم إنشاء نسخة تلقائية عند كل حفظ لمراحل المعالج، وتُسجَّل في `app_tender_pricing_wizards` داخل `SecureStore` |

### أدوات النسخ الاحتياطي

- **الأتمتة المركزية**: وحدة `backupManager` تتولى إنشاء النسخ، فرض سياسات الاحتفاظ (FIFO + نافذة زمنية)، وتسجيل النتائج في سجل التدقيق.
- **أداة التصدير**: `npm run backup:export -- --output=./exports/backups.json` تنتج ملف JSON بالمحتوى الكامل للنسخ الاحتياطية بما في ذلك البيانات المشفرة.
- **التنبيهات**: عند فشل عمليتي نسخ متتاليتين يتم إطلاق حدث `backup-failure-alert` وإظهار إشعار داخل التطبيق، مع تسجيل عدد الإخفاقات المتتالية في سجل التدقيق.

### حارس قنوات IPC

- تعتمد العملية الرئيسية على الدالة `validateIpcPayload` لمطابقة كل قناة IPC مع مخطط محدد مسبقًا، ورفض أي حمولات تخرج عن الحدود المسموح بها (مثل المفاتيح غير المعتمدة، الكائنات غير القابلة للتسلسل، أو مسارات الملفات غير الموثوقة).
- يتم تسجيل كل محاولة رفض ضمن `app_security_audit_log` مع سبب الرفض ولقطة مختصرة للحمولة، مما يوفر أثرًا جنائيًا واضحًا عند محاولة إساءة استخدام القنوات.
- يغطي الملف `tests/utils/ipcGuard.test.ts` حالات القبول والرفض الأساسية لضمان عدم انزلاق تغييرات مستقبلية إلى واجهة IPC دون حراسة أمنية.
- تمت إضافة قناة موحدة لميزات سطح المكتب (`desktop-secure-action`) تُمرر عبرها جميع طلبات الإشعارات، السحب والإفلات، وعمليات التصدير. يقوم الحارس بفحص نوع العملية (`notify`, `drag-intent`, `export`) وتطبيع الحمولة قبل السماح بالمتابعة.
- تُطبق حدود صارمة على حجم الملفات (10 ميجابايت للملف المفرد، 50 ميجابايت إجمالاً) وأنواع MIME المسموح بها لعمليات السحب والإفلات الخاصة بالملفات الفنية، ويتم تسجيل أي محاولة تتجاوز الحدود مع سبب الرفض في سجل التدقيق.

### سياسة أمان المحتوى (CSP)

- يولّد `cspBuilder` Nonce ديناميكيًا لكل تحميل (`generateNonce`) ويتم إدراجه في رأس `Content-Security-Policy` عبر `buildContentSecurityPolicy`، ما يسمح برفض أي سكربتات أو أنماط غير موقعة بنفس الـ Nonce.
- تتكيّف السياسة مع بيئة التطوير عبر السماح بـ`unsafe-eval` و`ws://localhost:*` لتشغيل أدوات Vite، بينما تقصر الاتصالات في الإنتاج على `https:` وتمنع الإطارات/الكائنات الخارجية افتراضيًا.
- تتوفر واجهة `window.security.getCspNonce()` من خلال `preload` لتمكين الواجهة من إدراج الـ Nonce في علامات `<script>` أو `<style>` الحساسة عند الحاجة.
- يوثق الملف `tests/utils/cspBuilder.test.ts` اختلافات السياسة بين التطوير والإنتاج ويضمن توافر الـ Nonce في التوجيهات الحرجة.

### مراقبة الأعطال والتتبع الأمني

- يعتمد التطبيق على وحدة `telemetry.cjs` لتفعيل Sentry Electron عند توفر المتغير البيئي `SENTRY_DSN`، مع دعم `SENTRY_TRACES_SAMPLE_RATE` و`SENTRY_PROFILES_SAMPLE_RATE` للتحكم في العينات.
- يتم إدخال الحدث الأولي (`app.whenReady`) كـ breadcrumb، كما تُسجل أحداث التحديث (`update-available`, `update-downloaded`) والانهيارات (`render-process-gone`, `gpu-process-crashed`) تلقائيًا عند تفعيل التتبع.
- يجري تنظيف الرؤوس الحساسة (مثل `Authorization` و`x-api-key`) قبل إرسال الحدث إلى Sentry لضمان عدم تسرب أسرار.
- تغطي الاختبارات `tests/utils/telemetry.test.ts` حالات التكوين مع/بدون DSN للتأكد من عدم فشل التطبيق في بيئات الاختبار أو التطوير.
- يتطلب خط البناء الموقّع توفير متغيرات البيئة (`WINDOWS_CERT_PATH`, `WINDOWS_CERT_PASSWORD`, `WINDOWS_PUBLISHER_NAME`, `ELECTRON_UPDATES_URL`) قبل استدعاء `npm run build:electron` لضمان حزم موثوقة ومستودع تحديثات ثابت.

### تحديثات الأمان المؤتمتة (S1.10)

- يتم جدولة `autoUpdater` لإجراء فحص كل 6 ساعات (بالإضافة إلى فحص عند بدء التشغيل) مع تسجيل جميع الأحداث في `auditLog` تحت الفئة `auto-updater`، بما في ذلك حالات النجاح والأخطاء والتثبيت المؤجل.
- عند توفر تحديث، يتم إرسال أحداث `update-available` و`update-downloaded` إلى الواجهة عبر الجسر الآمن لعرض رسائل موجهة للمستخدم دون الحاجة للوصول المباشر من الواجهة.
- يتوفر سكربت خطي `npm run security:check` يعالج بيانات إصدارات Electron الرسمية وسجل npm لإنتاج تقرير Arabic شامل عبر الدالة `analyzeElectronReleases`. يمكن حفظ الناتج بصيغة JSON باستخدام `--json --output docs/SECURITY_UPDATE_STATUS.json`.
- يوضح الدليل التشغيلي `docs/SECURITY_UPDATE_RUNBOOK.md` خطوات التعامل مع مخرجات السكربت، السيناريوهات المحتملة (تحديث تصحيحي، تحديث رئيسي، توقف الدعم)، وخطة التواصل مع أصحاب المصلحة.
- أي تحذيرات أو أخطاء أثناء استدعاء السكربت تُرفق في الحقل `errors` ضمن التقرير ويتم ترويسها في سجل التدقيق لسهولة المراجعة المستقبلية.

## طريقة استخدام `SecureStore`

```ts
import { secureStore } from '@/utils/secureStore';

await secureStore.set('financial_bank_accounts', accountsList);
const accounts = await secureStore.getOrDefault('financial_bank_accounts', []);
await secureStore.remove('financial_bank_accounts');
```

- عند العمل داخل بيئة متصفح (بدون Electron)، يعتمد `SecureStore` على مخزن مؤقت داخل الذاكرة مع تحذير واحد في وحدة التحكم بأن البيانات غير مشفرة.
- في بيئة Electron، تُرسل جميع العمليات عبر قناة IPC (`secure-store-*`) ليتم التشفير في العملية الرئيسية قبل تخزينها في `electron-store`. يتم ترحيل القيم القديمة تلقائيًا إلى الأظرف المشفرة عند أول قراءة.
- يعتمد `src/utils/storage.ts` على `storageSchema` لتطبيع القيم وتحديث `schemaVersion` قبل إعادة التخزين، مع كتابة المفاتيح عالية الحساسية إلى `SecureStore` حصراً.
- تتوفر دالة `runStorageMigrations` (ضمن `src/utils/storage.ts`) لتشغيل فحص شامل للمفاتيح وإعادة ترميزها عند الحاجة مع تقرير زمني مفصل.

### دورة حياة التطبيق (suspend/resume)

- تقوم العملية الرئيسية بربط مستمعي `powerMonitor.suspend` و`powerMonitor.resume` لاستدعاء قناة `system-lifecycle`، ما يجبر الطبقة المرئية على تصفية جميع الكتابات المعلقة قبل النوم وإعادة تحميل التخزين بعد الاستئناف.
- يتم مسح المفتاح المخبأ في الذاكرة (`SecureStore` AES key) فور تلقي حدث التعليق، ثم يعاد تحميله بأمان عند الاستئناف عبر `ensureEncryptionKey()` قبل السماح بأي عمليات حساسة جديدة.
- يعتمد الجسر على آلية تأكيد (`lifecycle-ack`) بحيث لا يُعتبر التعليق مكتملاً إلا بعد استلام رد من العملية المرئية يحتوي على إحصائيات التصفية (عدد العناصر المحفوظة، الأخطاء) وزمن التنفيذ بالملي ثانية.
- يعاد بث حدث `system-storage-ready` بعد الاستئناف لضمان إعادة تهيئة السياقات التي تعتمد على التخزين داخل الواجهة، بينما تُسجل أي أخطاء أثناء التصفية في `app_security_audit_log` مع سبب الفشل.
- يغطي الاختبار `tests/utils/storageLifecycle.test.ts` مسار التصفية/الاستئناف لضمان عدم فقدان البيانات الحساسة أثناء دورات السكون والاستيقاظ ويمنع أي تراجع مستقبلي في سلوك دورة الحياة.

- تم تغليف ميزات سطح المكتب الحساسة عبر وحدة `desktopSecurity.ts` في الواجهة والتي تتواصل مع القناة الموحدة المذكورة أعلاه. يتم تنقية البيانات (تقييد الأطوال، إزالة المحارف الخطرة، توثيق المصدر) قبل السماح بأي تفاعل مرئي، وتتوفر اختبارات `tests/utils/desktopSecurity.test.ts` للتأكد من بقاء الضوابط فعّالة.

### استرداد مسارات معالج التسعير عند الفشل

1. **تحقق من السجلات**: راجع `app_security_audit_log` للتأكد من وجود حدث `set` أو `remove` مرتبط بـ`app_tender_pricing_wizards` بعد آخر محاولة إرسال، ويمكن الاستفادة من سيناريو Playwright `tests/e2e/desktop/tender-pricing-wizard.spec.ts` للتحقق الآلي من المسار الكامل (حفظ ↔ استئناف ↔ إرسال).
2. **تطبيع المسودات**: شغّل سكربت التنظيف `tsx scripts/migrations/cleanup-tender-wizards.ts --input <exported-file> --dry-run` لمراجعة المفاتيح غير الصالحة (مثل المسودات اليتيمة) ثم أعد التشغيل بدون `--dry-run` لتحديث الملف أو المخزن.
3. **استعادة نسخة احتياطية**: إن تعذر استرجاع المسودة من التخزين المباشر، استورد آخر نسخة احتياطية للمناقصة من `backupManager` أو من ملف التصدير الناتج عن `backup:export`، ثم أعد فتح المعالج للتأكد من إعادة تحميل المرحلة الصحيحة.
4. **توثيق الحادثة**: قيّد نتيجة الاسترداد في سجل العمليات وأرفق تقرير الاختبار (HTML/trace) الناتج عن تشغيل `npx playwright test tests/e2e/desktop/tender-pricing-wizard.spec.ts` لضمان توافر الأدلة.

## تشغيل مهاجرات التخزين

> راجع الدليل التفصيلي في `docs/STORAGE_MIGRATION_RUNBOOK.md` قبل التنفيذ في بيئة الإنتاج.

1. تأكد من إغلاق نسخة التطبيق قيد الاستخدام أو تفعيل وضع الصيانة.
2. استدعِ `runStorageMigrations()` من سياق Startup (أو سكربت الصيانة) بدون معاملات لتغطية جميع المفاتيح؛ يمكن تمرير `keys` لتحديد نطاق أصغر أثناء الاختبار.
3. احفظ تقرير النتائج (يُعاد ككائن يحوي `entries` و`failures`) ضمن سجل التدقيق.
4. في حال ظهور إدخالات `removed-invalid`، يتم الرجوع إلى أحدث نسخة احتياطية عبر الدليل التشغيلي.
5. كرر العملية بعد تدوير المفاتيح أو بعد إطلاقات تغير بنية البيانات.

## إجراءات المراقبة والتدقيق

1. **سجل الأحداث**: كل عملية `set/remove/clear/migrate` على المفاتيح الحساسة أو حدث نظام حساس (`SystemEventType`) تُسجَّل تلقائيًا عبر طبقة `auditLog` داخل المفتاح `app_security_audit_log` مع ختم زمني ونتيجة التنفيذ.
2. **نافذة الاحتفاظ**: يتم الاحتفاظ بآخر 500 حدث، مع تقليم تلقائي للأقدم لتقليل المخاطر وإبقاء السجل قابلاً للمراجعة السريعة.
3. **فحص أسبوعي**: مراجعة السجلات للتأكد من عدم وجود نشاط غير اعتيادي (قائمة مراجعة مرفقة في `docs/STORAGE_MIGRATION_RUNBOOK.md`).
4. **تنبيهات آنية**: يتم إطلاق أحداث `backup-failed` و`backup-failure-alert` عند وجود إخفاقات متتالية، مع تسجيل عدد الإخفاقات والسبب في سجل التدقيق وإظهار إشعار للمستخدم.

### استهلاك سجل التدقيق

- استخدم الدالة `getAuditEvents()` من `src/utils/auditLog.ts` لاستعراض الأحداث داخل أدوات المراقبة أو لوحة الإدارة، أو اشترك بواسطة `subscribeToAuditLog()`/`useAuditLog()` للحصول على بث لحظي داخل الواجهة.
- يمكن تنظيف السجل يدويًا عبر `clearAuditLog()` أثناء التحقيقات بعد أخذ نسخة احتياطية للسجلات.
- يُضاف حقل `metadata` تلقائيًا ليحمل تفاصيل إضافية مثل رقم الإصدار، نوع الترقية، معرف الحدث، أو رسائل الخطأ عند الفشل.
- يجري تجهيز أداة تصدير وتشغيل أوتوماتيكي ضمن مهمة S1.4 لالتقاط السجل دورياً ودمجه مع سياسة النسخ الاحتياطي.

## خطة الطوارئ

| حدث | الإجراء الفوري | المتابعة |
| --- | --- | --- |
| اكتشاف بيانات غير مشفرة | إيقاف عمليات الكتابة، تشغيل عملية الترحيل إلى `SecureStore`، إصدار تحذير للمستخدم | إضافة بند متابعة للتحقق من السبب الجذري |
| فشل الوصول إلى `keytar` | التحويل إلى وضع القراءة فقط للبيانات الحساسة | فتح تذكرة دعم مع فريق البنية التحتية لإصلاح المخزن الآمن |
| فشل النسخ الاحتياطي الدوري | إعادة المحاولة آليًا مرتين مع تأخير 5 دقائق | إرسال إشعار للمستخدم وتوثيق الحدث في سجل التدقيق |

## خارطة الطريق الأمنية (مقتطف)

1. **S1.1 – SecureStore** *(مُنجز في 4 أكتوبر 2025)*: إنشاء قناة التشفير، إعادة بناء `storage.ts`, وترحيل البيانات الحساسة إلى `SecureStore`.
2. **S1.2 – إصدار البيانات** *(مُنجز في 6 أكتوبر 2025)*: إضافة `schemaVersion`, دالة `runStorageMigrations`, واختبارات تكامل لضمان سلامة البيانات عند تغيير البنية.
3. **S1.3 – سجل التدقيق** *(مُنجز في 6 أكتوبر 2025)*: تم تفعيل طبقة `auditLog` مع حفظ الأحداث الحساسة في `SecureStore`، وربط `SystemEventType` الحساسة بالسجل، وتوفير واجهة اشتراك (`subscribeToAuditLog`/`useAuditLog`) لاستهلاك السجل داخل الواجهة.
4. **S1.4 – النسخ الاحتياطي**: تطبيق سياسة النسخ الاحتياطي المذكورة أعلاه مع واجهة لإدارة النسخ.

> يتم تحديث هذا الدليل بالتزامن مع اكتمال مهام المرحلة 1. أي تغييرات في سياسات المفاتيح أو التشفير يجب أن تُوثق هنا وتُرفق بقرار معماري (ADR).
