# خطة التحقق والدمج لنظامي التسعير والمنافسات

## 1. التحقق من نتائج المستند PRICING_VS_TENDERS_PLANS_COMPARISON.md

| الادعاء في المستند | مصدر التحقق | النتيجة |
|---------------------|--------------|---------|
| خطة التسعير تغطي 32 ملفًا بإجمالي 9,388 سطرًا وتستغرق 6 أسابيع | `PRICING_SYSTEM_ANALYSIS_REPORT.md` (قسم الملخص) و`PRICING_SYSTEM_IMPLEMENTATION_PLAN.md` (عنوان الصفحة الأولى) | ✅ مطابق |
| خطة المنافسات تغطي 34 ملفًا بإجمالي 13,342 سطرًا وتستغرق 3 أسابيع | `docs/TENDERS_SYSTEM_QUALITY_ANALYSIS.md` (الملخص التنفيذي، الجدول 1.1، القسم 6.3) | ✅ مطابق |
| التوفير في خطة التسعير يساوي 5,568 سطرًا (من 9,388 إلى 3,820) | `PRICING_SYSTEM_IMPLEMENTATION_PLAN.md` (قسم الأهداف الرئيسية) | ✅ مطابق |
| خطة المنافسات تحقق توفيرًا يقارب 2,500 سطرًا (من 13,342 إلى ~10,800) | `docs/TENDERS_SYSTEM_QUALITY_ANALYSIS.md` (الملخص التنفيذي، الجداول 7.2 و7.4) | ✅ مطابق |
| خطة التسعير تشمل توحيد محركات التسعير الثلاثة وإنشاء `UnifiedPricingEngine.ts` و`PricingEngineAdapter.ts` | `PRICING_SYSTEM_IMPLEMENTATION_PLAN.md` (الأسبوع 1) | ✅ مطابق |
| خطة المنافسات تحذف 6 ملفات إعادة تصدير (47 سطرًا) | `docs/TENDERS_SYSTEM_QUALITY_ANALYSIS.md` (القسم 1.2) | ✅ مطابق |
| خطة التسعير ترفع التغطية الاختبارية إلى 85٪ عبر 140 اختبار | `PRICING_SYSTEM_IMPLEMENTATION_PLAN.md` (الأسابيع 1، 2، 6) | ✅ مطابق |
| خطة المنافسات تعطي إرشادات اختبار عامة دون خطة قياس مفصلة | `docs/TENDERS_SYSTEM_QUALITY_ANALYSIS.md` (القسم 6) | ✅ مطابق |

## 2. الملاحظات والاختلافات

- **تباين حجم `TenderPricingPage.tsx` بعد التحسين في خطة المنافسات:**
  - القسم 1.1 يستهدف 800-1,000 سطر.
  - الجدول 7.4 يذكر هدفًا بديلًا قدره 1,600 سطر.
  - القسم 7.3 يوضح تقسيمًا ينتج إجماليًا ~2,400 سطر موزعًا على 16 ملفًا.
  - **الاستنتاج:** يجب توحيد الهدف قبل التنفيذ لتفادي تباين توقعات الفرق.
- **غياب خطة اختبار مفصلة في خطة المنافسات:** لا توجد تغطية محددة لـ Vitest أو Playwright أو اختبار التكامل؛ يوصى بإضافة خطة أدوات.
- **شمول TenderPricingWizard:** تم التأكد أن خطة التسعير تتضمن تفكيك المعالج في نهاية الأسبوع الثالث (اليومان 14-15)، ما يصحح الفهم السابق بأن الخطة تغفل ذلك الملف.

## 3. خطة مدمجة تجمع مزايا الخطتين

### نظرة عامة

| المرحلة | المدة | الهدف الرئيسي | ناتج قابل للقياس |
|---------|-------|----------------|-------------------|
| المرحلة 0 | أسبوع 0 | تجهيز الفريق والنسخ الاحتياطية وتعريف خطوط الأساس | تقرير Baselining يضم زمن التحميل (LCP)، زمن الحساب، حجم الحزم، نسب التغطية |
| المرحلة 1 | الأسابيع 1-3 | تنفيذ تحسينات واجهة المنافسات السريعة | إغلاق جميع ملفات إعادة التصدير، تقسيم الملفات الخمسة الكبيرة، استقرار UX |
| المرحلة 2 | الأسابيع 4-7 | تنفيذ توحيد محركات التسعير وإزالة التكرارات | وجود `UnifiedPricingEngine` قيد الاستخدام، حذف الدوال المكررة، رفع التغطية إلى ≥70٪ |
| المرحلة 3 | الأسبوع 8 | صقل الأداء والاختبارات والتوثيق | وصول التغطية إلى الهدف النهائي 85٪، تقرير أداء يثبت التحسن بنسبة ≥50٪ |

### المرحلة 0: التحضير (أسبوع واحد)

1. **إنشاء فرع فرعي** من `feature/tenders-system-quality-improvement` باسم `feature/pricing-tenders-hybrid`.
2. **تجميع خطوط الأساس:**
   - تشغيل `npm run test -- --coverage` وتوثيق نسبة التغطية الحالية.
   - استخدام Lighthouse أو أدوات القياس الداخلية لتسجيل زمن التحميل ووقت الحسابات لمكونات التسعير.
3. **إعداد خطة اختبار مشتركة:**
   - تحديد حزم Vitest وPlaywright والمسارات المستهدفة لكل مرحلة.
4. **توثيق التبعيات:** تحديث `PRICING_SYSTEM_INTEGRATION_ANALYSIS.md` بقائمة الأنظمة المتأثرة أثناء العمل المرحلي.

### المرحلة 1: تحسينات واجهة المنافسات (Weeks 1-3)

- **الأسبوع 1:**
  - حذف جميع ملفات إعادة التصدير الستة المذكورة في خطة المنافسات.
  - إعادة توجيه الاستيرادات المتأثرة.
  - تمكين `lazy load` للمكونات الكبيرة المذكورة في القسم 5 من خطة المنافسات.
- **الأسبوع 2:**
  - تقسيم `TenderPricingPage.tsx`، مع الاتفاق على هدف واضح (اقتراح: ملف رئيسي ≤ 250 سطرًا، إجمالي المجلد ≤ 2,000 سطر).
  - تطبيق نفس الإستراتيجية على `TenderDetails.tsx` وفق هيكل الأقسام المقترح (tabs، components، hooks).
- **الأسبوع 3:**
  - تقسيم `TenderPricingWizard.tsx`, `NewTenderForm.tsx`, و`TendersPage.tsx` كما ورد في خطة المنافسات.
  - تنفيذ اختبارات UI أساسية (Smoke tests) للتأكد من عدم كسر السلوك الحالي.

**معايير إتمام المرحلة 1:**
- لا توجد ملفات Re-export معلّمة.
- حجم أي ملف واجهة رئيسي ≤ 400 سطر.
- تسجيل اختبارات Visual Regression أو لقطات واجهة أساسية.

### المرحلة 2: توحيد نظام التسعير (Weeks 4-7)

- **الأسبوع 4:**
  - إنشاء `UnifiedPricingEngine.ts` و`PricingEngineAdapter.ts` طبقًا لما ورد في خطة التسعير.
  - ترحيل الاستدعاءات القديمة إلى الطبقة المهيكلة الجديدة مع الحفاظ على التوافق.
- **الأسبوع 5:**
  - نقل جميع دوال الحساب إلى `pricingCalculations.ts`.
  - حذف التكرارات من `TenderPricingPage.tsx`, `SummaryView.tsx`, `PricingView.tsx`, `pricingEngine.ts`, `unifiedCalculations.ts`.
  - كتابة اختبارات الوحدة للدوال المنقولة.
- **الأسبوع 6:**
  - استكمال تفكيك الملفات الكبيرة الأخرى: `SummaryView.tsx`, `PricingView.tsx`, `PricingTemplateManager.tsx`, `normalizePricing.ts` حسب خطة التسعير.
  - إدخال تحسينات الأداء (تقليل مستويات الاستدعاء، caching للنتائج المتكررة).
- **الأسبوع 7:**
  - تنفيذ اختبارات تكامل للتأكد من عمل النظام مع `projectAutoCreation`, `financialAnalyticsService`, و`boqRepository` كما ورد في `PRICING_SYSTEM_INTEGRATION_ANALYSIS.md`.
  - تحديث التوثيق الفني للأجزاء التي تغيرت.

**معايير إتمام المرحلة 2:**
- عدم وجود محركات مستقلة في مسارات `domain` و`application` خارج المحرك الموحد.
- تقليل زمن حساب التسعير إلى ≤ 200ms في بيئة الاختبار.
- تغطية اختبارية 70٪ على الأقل قبل الدخول في الأسبوع الأخير.

### المرحلة 3: الصقل والضمان (Week 8)

1. **رفع التغطية إلى الهدف النهائي (85٪):**
   - إضافة اختبارات سيناريوهات متقدمة للـ Wizard والصفحات المفككة حديثًا.
2. **اختبارات الأداء:**
   - إعادة قياس أزمنة التحميل والحساب والباندل بعد التحسين، والتأكد من تحقيق التحسن المستهدف (≥ 50٪ من الزمن الأصلي للحساب وفق خطة التسعير، وتحسن ملحوظ في حجم الحزمة وفق خطة المنافسات).
3. **توثيق التغييرات:**
   - تحديث `PRICING_SYSTEM_ANALYSIS_REPORT.md` و`docs/TENDERS_SYSTEM_QUALITY_ANALYSIS.md` ببيانات ما بعد التنفيذ.
   - تحديث دليل الترحيل وأي كتيب استخدام داخلي.
4. **مراجعة كود نهائية** ومصادقة أصحاب المصلحة قبل الدمج في الفرع الرئيسي.

## 4. المخاطر وخطط التخفيف

| الخطر | المرحلة | خطة التخفيف |
|-------|---------|--------------|
| تناقض هدف حجم الملفات في `TenderPricingPage.tsx` | المرحلة 1 | عقد ورشة قصيرة مع أصحاب المصلحة لتثبيت هدف نهائي واحد قبل كتابة الكود |
| تأثيرات غير متوقعة على مشاريع تعتمد على المحركات القديمة | المرحلة 2 | استخدام `PricingEngineAdapter` وتمديد فترة التعايش للأكواد القديمة أسبوعين مع مراقبة السجلات |
| انخفاض أداء الواجهة خلال التفكيك | المرحلة 1 | نشر التعديلات خلف Feature Flag أو Toggle داخلي واختبارها على بيئة تجريبية أولًا |
| عدم تحقيق التغطية الاختبارية المطلوبة | المرحلة 3 | بدء كتابة الاختبارات منذ المرحلة 1، وتعيين مسؤول اختبار لكل مرحلة |

## 5. مؤشرات النجاح النهائية

- **التخفيض في حجم الأكواد:** ≥ 7,500 سطر إجمالي عبر النظامين.
- **تحسين الأداء:** زمن حساب التسعير ≤ 200ms، زمن تحميل صفحة التسعير ≤ 1.5s في بيئة الاختبار.
- **الجودة:** تغطية اختبارية ≥ 85٪، صفر أخطاء حرجة في بيئة الاعتماد خلال أسبوعين بعد الإطلاق.
- **سهولة الصيانة:** لا يوجد ملف واجهة يتجاوز 400 سطر، وكل منطق تسعير مركزي موجود داخل `src/domain/services/pricing` أو `src/shared/utils/pricing` مع اختبارات مرافقة.

---

**إعداد:** GitHub Copilot  
**تاريخ الإصدار:** 22 أكتوبر 2025  
**الحالة:** ✅ جاهز للمراجعة والتنفيذ
