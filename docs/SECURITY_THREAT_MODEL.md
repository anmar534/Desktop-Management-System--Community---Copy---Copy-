# نموذج التهديدات الأمني للتخزين المحلي

> تاريخ الإنشاء: 4 أكتوبر 2025
> نطاق الجلسة: حماية البيانات الحساسة المخزنة عبر `electron-store` وطبقة التخزين المساعدة داخل التطبيق.

## الأصول الحرجة

| الأصل | الوصف | السرية | السلامة | الإتاحة | ملاحظات |
| --- | --- | --- | --- | --- | --- |
| بيانات التسعير الرسمية والمسودات | أسعار البنود، هوامش الربح، سيناريوهات التكلفة | عالية جدًا | عالية | متوسطة | مستخدمة لاتخاذ قرارات تجارية حساسة |
| الحسابات البنكية والتحويلات | أرقام حسابات، تدفقات نقدية، مستندات مرفقة | عالية جدًا | عالية | متوسطة | أي تسريب يعرض المؤسسة لمخاطر مالية وقانونية |
| نسخ BOQ والنسخ الاحتياطية | لقطات تاريخية وتسليمات المناقصات | عالية | متوسطة | متوسطة | تحتوي على تاريخ المفاوضات وثوابت الأسعار |
| علاقات المشاريع / العملاء | خرائط العلاقات، بيانات التواصل | متوسطة | متوسطة | عالية | تستخدم يوميًا داخل التطبيق، لكن لا يجب نشرها خارجياً |
| تهيئة الصلاحيات وإعدادات التطبيق | قيم التحكم في الوصول، مفاتيح الميزات | عالية | عالية | عالية | أي عبث بها يغير سلوك التطبيق ويعطل فرق العمل |

## الخصوم المحتملون

| الخصم | الدافع | مستوى المهارة | قدرات الوصول | ملاحظات |
| --- | --- | --- | --- | --- |
| موظف داخلي فضولي | الحصول على بيانات التسعير أو الحسابات | متوسط | وصول شخصي إلى الجهاز | يعتمد على ضعف كلمات المرور أو وجود الملفات بصيغ نصية |
| مهاجم خارجي يحصل على الجهاز | ابتزاز أو منافسة غير مشروعة | مرتفع | وصول مادي للجهاز/القرص | يمكنه نسخ مجلد التطبيق أو بيانات `electron-store` |
| برمجية خبيثة على الجهاز | بيع البيانات أو العبث بها | مرتفع | صلاحيات المستخدم أو مسؤول الجهاز | تستغل غياب التشفير وسجل التدقيق |
| مطور غير مخول | تعديل الإعدادات أو تسريب مفاتيح | متوسط | وصول إلى الشفرة المصدرية | يحتاج إلى ضوابط مراجعة وإرشادات واضحة |

## سيناريوهات الهجوم ذات الأولوية

1. **نسخ دليل `electron-store` من جهاز موظف** → يؤدي إلى كشف كامل لبيانات التسعير والحسابات بسبب التخزين كنص صريح.
2. **استغلال ثغرة في قناة IPC** → حقن أو قراءة بيانات حساسة عبر أوامر IPC غير محمية أو بدون تحقق من الحمولة.
3. **استرجاع النسخ الاحتياطية المؤرشفة من ملفات التطبيق** → اكتشاف التسعير التاريخي واستراتيجيات التفاوض.
4. **العبث بالإعدادات أو مفاتيح الصلاحيات** → تعطيل حراس التخزين أو تفعيل ميزات مقيدة.
5. **استبدال بيانات التسعير أثناء العمل دون سجل تدقيق** → إدخال أرقام خاطئة بلا تتبع.

## تقييم الضوابط الحالية

| الضابط | الحالة الحالية | الثغرات |
| --- | --- | --- |
| `installLegacyStorageGuard` | يمنع استخدام المفاتيح القديمة | لا يمنع الوصول إلى القيم الحساسة الحديثة |
| `safeLocalStorage` + `ElectronStoreInterface` | مصدر واحد للحقيقة | لا يتضمن أي طبقة تشفير، ولا تحكم في النسخ الاحتياطية |
| سياسة النسخ الاحتياطي | موزعة عبر خدمات التسعير | لا توجد سياسة تدوير أو تحذيرات عند الفشل |
| مراقبة الأحداث | `APP_EVENTS` تستخدم للأحداث التشغيلية | لا يوجد سجل تدقيق معتمد |
| حماية IPC | قنوات محدودة لكن بلا تحقق من الحمولة | يمكن التلاعب بالرسائل إذا تم الوصول إلى العملية المرئية |

## متطلبات التحسين المتفق عليها

1. **تشفير البيانات الحساسة قبل التخزين** باستخدام AES-256-GCM مع إدارة مفاتيح عبر `keytar`.
2. **توفير طبقة `SecureStore`** بواجهات واضحة (`get/set/remove/clear`) ودمجها في `storage.ts` للمفاتيح الحساسة.
3. **تدوين سياسات إدارة المفاتيح** (الإنشاء، التدوير، النسخ الاحتياطي) داخل `SECURITY_GUIDE.md`، مع إجراءات طارئة لفقدان المفاتيح.
4. **بناء سجل تدقيق مركزي** يسجل عمليات الإنشاء والتعديل والحذف والاستيراد مع الطابع الزمني والمستخدم.
5. **تأمين قنوات IPC** عبر التحقق من المدخلات وتوقيع الرسائل الحساسة.
6. **إدارة النسخ الاحتياطية** بسياسة FIFO وتحذيرات عند فشل النسخ أو تجاوز الحجم.

## مصفوفة الأولويات (STRIDE → عناصر الخطة)

| التهديد (STRIDE) | الأصل المتأثر | مستوى المخاطرة | الإجراء في المرحلة 1 |
| --- | --- | --- | --- |
| **S** انتحال الهوية | قنوات IPC | متوسط | حارس `validateIpcPayload` (مهمة S1.5) |
| **T** العبث | بيانات التسعير | عالٍ | تطبيق `SecureStore` + سجل التدقيق |
| **R** الإنكار | عمليات التسعير | عالٍ | سجل التدقيق وإصدارات البيانات |
| **I** الإفشاء | الحسابات البنكية والتسعير | عالٍ | تشفير البيانات، سياسة المفاتيح |
| **D** الحرمان | النسخ الاحتياطية | متوسط | سياسة النسخ الاحتياطي والإنذارات |
| **E** رفع الامتياز | إعدادات التطبيق | متوسط | تقييد قنوات IPC وتوثيق الصلاحيات |

## نتائج الجلسة والإجراءات المباشرة

- ✅ المصادقة على استخدام `AES-256-GCM` مفتاح 256 بت مع IV بطول 12 بايت وتخزين المفتاح في `keytar` تحت خدمة `DesktopManagementSystem`.
- ✅ الاتفاق على إنشاء `SecureStore` كطبقة منفصلة في الواجهة الأمامية تنسق مع قناة IPC جديدة (`secure-store-*`).
- ✅ تحديد المفاتيح الحساسة التي يجب تشفيرها فورًا:
  - `financial_bank_accounts`
  - `app_pricing_data`, `app_pricing_official`, `app_pricing_draft`
  - `app_pricing_snapshots`, `app_tender_backups`
  - `app_project_cost_envelopes`, `app_cost_variance_config`, `app_cost_variance_cache`
  - `financial_invoices`, `financial_budgets`, `financial_reports`
- ✅ إدراج تحديث `DATA_INVENTORY.md` لإضافة تصنيف السرية وتأثير الخرق.
- ⏳ إعداد سجل تدقيق موحد (S1.3) يلتقط هوية المستخدم والقناة ونتيجة العملية.
- ⏳ توثيق خطة النسخ الاحتياطي وإجراءات الطوارئ في دليل الأمان (S1.4).

## مؤشرات التقدم للمرحلة 1

1. توفر قناة IPC مؤمنة (`secure-store`) وتعمل في بيئات التطوير والإنتاج.
2. تخزين جميع البيانات الحساسة المذكورة أعلاه بصيغة مشفرة وعدم بقاء أي بقايا نصية في `electron-store`.
3. تحديثات أسبوعية مختصرة في `SECURITY_GUIDE.md` توضح حالة التشفير والنسخ الاحتياطي.
4. نجاح تشغيل أوامر التحقق بعد التعديلات (`npm run -s lint`, `npm run -s test`) مع تغطية حالات جديدة في الاختبارات التكاملية لاحقًا.

> تم اعتماد هذه الخلاصة كمرجع أساسي لتنفيذ بنود المرحلة 1، وسيتم تحديثها بعد الانتهاء من مهام S1.1–S1.4.
