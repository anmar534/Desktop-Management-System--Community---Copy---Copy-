# دليل تشغيل تحديثات الأمان (S1.10)

> تاريخ الإنشاء: 8 أكتوبر 2025  
> الغرض: توحيد مراقبة تحديثات Electron وتنسيق الاستجابة وإشعارات أصحاب المصلحة.

## 1. نظرة عامة

- تعتمد المنصة على `electron-updater` لفحص التحديثات آليًا كل 6 ساعات بالإضافة إلى فحص عند بدء التشغيل.
- يتم توثيق كل حدث في `auditLog` ضمن الفئة `auto-updater`، بما في ذلك عمليات الفحص الناجحة، الإصدارات المتاحة، والأخطاء.
- يتيح السكربت `npm run security:check` إصدار تقرير أسبوعي أو فوري عند وجود ثغرات معروفة أو تحديثات حرجة.

## 2. المتطلبات المسبقة

1. اتصال إنترنت موثوق للوصول إلى واجهات `https://releases.electronjs.org` و`https://registry.npmjs.org`.
2. الوصول إلى المستودع وبيئة التطوير مع Node.js 18 أو أحدث.
3. القدرة على الوصول إلى لوحة التدقيق (`auditLog`) للتأكد من تسجيل الأحداث.

## 3. تشغيل فحص التحديثات اليدوي

### 3.1 أمر افتراضي (مخرجات نصية)

```powershell
npm run security:check
```

- يعرض ملخصًا عربيًا يحدد الإصدار الحالي، آخر إصدار مستقر، عدد الإصدارات المتقدمة، وخطة العمل المقترحة.
- يتم تضمين أي تحذيرات شبكية داخل التقرير وتسجيلها في `auditLog` تلقائيًا.

### 3.2 الحصول على مخرجات JSON للاستخدام الآلي

```powershell
npm run security:check -- --json --output docs/SECURITY_UPDATE_STATUS.json
```

- يخزن التقرير بصيغة JSON (للاستهلاك في لوحات المتابعة) مع إبقاء نسخة مطبوعة على الطرفية.
- ستحتوي خاصية `errors` على تحذيرات مع البادئة `warning:` ليسهل التصفية.

## 4. تفسير التقرير

| خاصية | الوصف | دلالات رئيسية |
| --- | --- | --- |
| `updateLevel` | نوع التحديث المطلوب (`current`, `patch`, `minor`, `major`, `unsupported`, `unknown`) | `unsupported` تعني أن الإصدار خارج نافذة الدعم ويجب ترقيته فورًا |
| `supportWindow` | حالة الدعم بناءً على الفارق بين آخر إصدار مستقر والإصدار الحالي | `end-of-life` ⇒ رفع أولوية الحادث إلى حرجة |
| `recommendedAction` | نص إرشادي لاتخاذ القرار | يجب مشاركة النص كما هو (بعد ضبطه للسياق) في رسالة التواصل |
| `notes` | معلومات داعمة مثل عدد الإصدارات المتقدمة وتواريخ الإصدار | تساعد في تقدير الجهد المطلوب للاختبار |
| `errors` | تحذيرات أثناء الفحص (مثل فشل الشبكة) | في حال تكررت، يجب فتح تذكرة متابعة مع فريق المنصة |

## 5. مصفوفة اتخاذ القرار

| تصنيف التقرير | الإجراء التقني | التواصل مع أصحاب المصلحة | زمن الاستجابة |
| --- | --- | --- | --- |
| `current` | لا حاجة لأي تغيير، استمر في المراقبة الأسبوعية | لا يلزم إشعار | — |
| `patch` | جدولة إصدار صيانة خلال 48 ساعة، تنفيذ اختبارات دخان على مسار تحميل الملفات والتصدير | إشعار فريق المنصة ومدير الإصدار بخطة الترقية | 48 ساعة |
| `minor` | تخطيط ترقية خلال 5 أيام عمل، مراجعة سجل التغييرات الرسمي | إشعار المنتج والدعم الفني بموعد الإصدار | 5 أيام |
| `major` | إعداد خطة ترقية رئيسية (توافق واجهات، التحقق من الإضافات)، تنفيذ اختبارات E2E موسعة | إرسال بريد رسمي للمدراء التنفيذيين وفريق الدعم قبل الترقية بثلاثة أيام | 7 أيام |
| `unsupported` | ترقية عاجلة، توقيف الإصدارات القديمة، مراقبة التصحيحات الأمنية بعد الإصدار | إخطار فوري للإدارة والأمن السيبراني مع خطة الطوارئ | 24 ساعة |
| `unknown` | مراجعة يدوية لسجل الإصدارات وتحديث السكربت إذا اقتضى الأمر | إشعار مختصر للفريق الأمني لطلب الموافقة | حسب التقييم |

## 6. ربط النتائج بالمنصة

1. **طبقة Electron:** تسجل `main.cjs` جميع أحداث التحديث وتبث `update-available` و`update-downloaded` للواجهة لعرض لافتات باللغة العربية.
2. **سجل التدقيق:** يمكن البحث عن أحداث التحديث عبر `key = app_version` أو `category = auto-updater` للتأكد من الامتثال.
3. **التقارير:** يُنصح بتحديث `docs/SECURITY_UPDATE_STATUS.json` بعد كل فحص يدوي والاحتفاظ بآخر ثلاثة تقارير للمقارنة التاريخية.

## 7. خطة التواصل القياسية

1. **صيغة البريد الإلكتروني الأساسية:**
   - العنوان: `تنبيه أمني: تحديث Electron {الإصدار الجديد}`
   - المحتوى: موجز توصية التقرير + خطة التنفيذ + نافذة الصيانة المتوقعة.
2. **قنوات الدعم:** تحديث قناة الدعم الفوري (Teams/Slack) برسالة قصيرة توضح حالة التحديث والموعد المتوقع.
3. **التوثيق:** إضافة مدخل جديد إلى سجل الأمن الداخلي مع رقم الإصدار، التاريخ، والقرارات المتخذة.

## 8. التعامل مع الإخفاقات

| السيناريو | الإجراء المحلي | التصعيد |
| --- | --- | --- |
| فشل الاتصال بجميع المصادر | إعادة المحاولة بعد 10 دقائق، التحقق من جدار الحماية | فريق الشبكات إذا استمر لأكثر من ساعتين |
| ظهور `errors` من نوع `install-deferred` متكرر | مراجعة واجهة المستخدم لضمان ظهور نافذة التحديث | فريق تجربة المستخدم والأمن |
| فشل `autoUpdater` في التثبيت | مراجعة سجل `electron-updater` واستخدام التحديث اليدوي | فريق الإصدار لفتح hotfix |

## 9. الجدولة والتوثيق

- **مراجعة أسبوعية:** تشغيل السكربت كل يوم إثنين وتحديث ملف الحالة.
- **مراجعة طارئة:** عند صدور نشرة أمنية من Electron/Sentry.
- **توثيق:** تحديث هذا الدليل و`docs/SECURITY_GUIDE.md` ببيانات الإصدار بعد إتمام أي ترقية فعلية.

---

> تم إعداد هذا الدليل ليتكامل مع سياسات المرحلة S1.10. أي تعديلات على خطة التحديث يجب أن تُوثق هنا وفي `docs/SECURITY_GUIDE.md` قبل نشرها.
