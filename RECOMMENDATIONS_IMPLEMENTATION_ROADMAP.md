# Ø®Ø§Ø±Ø·Ø© Ø·Ø±ÙŠÙ‚ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆØµÙŠØ§Øª - Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³Ø¹ÙŠØ± ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù‡ÙŠÙƒÙ„Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©

**Ø§Ù„ØªØ§Ø±ÙŠØ®:** 24 Ø£ÙƒØªÙˆØ¨Ø± 2025  
**Ø§Ù„Ù‡Ø¯Ù:** ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø£Ø±Ø¨Ø¹ ÙÙŠ Ø³ÙŠØ§Ù‚ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù‡ÙŠÙƒÙ„Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©  
**Ø§Ù„Ù†Ø·Ø§Ù‚:** Ù…Ù†Ø§ÙØ³Ø§Øª â†’ Ù…Ø´Ø§Ø±ÙŠØ¹ â†’ Ù…Ø´ØªØ±ÙŠØ§Øª â†’ Ù…Ø§Ù„ÙŠØ© â†’ ØªÙ‚Ø§Ø±ÙŠØ± â†’ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…

---

## ğŸ“‹ Ù…Ù„Ø®Øµ ØªÙ†ÙÙŠØ°ÙŠ

### Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ

**Ù…Ø±Ø­Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù‡ÙŠÙƒÙ„Ø©:**

- âœ… **Ù…Ù†Ø§ÙØ³Ø§Øª:** Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„ (TenderDetails Ù…ÙØ¹Ø§Ø¯ Ù‡ÙŠÙƒÙ„ØªÙ‡ -78%)
- â³ **Ù…Ø´Ø§Ø±ÙŠØ¹:** Ø§Ù„ØªØ§Ù„ÙŠ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
- â³ **Ù…Ø´ØªØ±ÙŠØ§Øª:** Ù„Ù… ÙŠØ¨Ø¯Ø£
- â³ **Ù…Ø§Ù„ÙŠØ©:** Ù„Ù… ÙŠØ¨Ø¯Ø£
- â³ **ØªÙ‚Ø§Ø±ÙŠØ±:** Ù„Ù… ÙŠØ¨Ø¯Ø£
- â³ **Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…:** Ù„Ù… ÙŠØ¨Ø¯Ø£

**Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ´ÙØ©:**

1. âŒ Event Loop Ù„Ø§ Ù†Ù‡Ø§Ø¦ÙŠ (15 re-render)
2. âŒ useMemo re-calculation (32 Ù…Ø±Ø©)
3. âŒ "ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯Ø©" Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
4. âŒ Legacy data paths (5+ Ù…ØµØ§Ø¯Ø± Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†ÙØ³Ù‡Ø§!)

### Ø§Ù„ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø£Ø±Ø¨Ø¹

| #   | Ø§Ù„ØªÙˆØµÙŠØ©                                | Ø§Ù„ØªØ£Ø«ÙŠØ±  | Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© | Ø§Ù„ØªØ¹Ù‚ÙŠØ¯ | Ø§Ù„Ù…Ø¯Ø©    |
| --- | -------------------------------------- | -------- | -------- | ------- | -------- |
| 1   | **State Management Library (Zustand)** | ğŸ”¥ Ø«ÙˆØ±ÙŠ  | P0       | Ø¹Ø§Ù„ÙŠ    | 4 Ø£Ø³Ø§Ø¨ÙŠØ¹ |
| 2   | **Ø¥Ø²Ø§Ù„Ø© Legacy Data Paths**            | â­ ÙƒØ¨ÙŠØ±  | P1       | Ù…ØªÙˆØ³Ø·   | 2 Ø£Ø³Ø§Ø¨ÙŠØ¹ |
| 3   | **Simplify Draft System**              | âœ¨ Ù…ØªÙˆØ³Ø· | P1       | Ù…Ù†Ø®ÙØ¶   | 1 Ø£Ø³Ø¨ÙˆØ¹  |
| 4   | **Add Integration Tests**              | ğŸ›¡ï¸ ÙˆÙ‚Ø§Ø¦ÙŠ | P2       | Ù…ØªÙˆØ³Ø·   | 3 Ø£Ø³Ø§Ø¨ÙŠØ¹ |

**Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯Ø©:** 10 Ø£Ø³Ø§Ø¨ÙŠØ¹ (2.5 Ø´Ù‡Ø±) - ØªÙ†ÙÙŠØ° Ù…ØªÙˆØ§Ø²ÙŠ Ø¬Ø²Ø¦ÙŠØ§Ù‹

---

## ğŸ¯ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚

### Ø§Ù„Ù†Ù‡Ø¬ Ø§Ù„Ù…Ù‚ØªØ±Ø­: **Incremental Modernization**

Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† "Big Bang" migrationØŒ Ø³Ù†Ø·Ø¨Ù‚ Ø§Ù„ØªÙˆØµÙŠØ§Øª **ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹** Ù…Ø¹ ÙƒÙ„ module ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù‡ÙŠÙƒÙ„Ø©:

```
Ù…Ù†Ø§ÙØ³Ø§Øª (Ø§Ù„Ø­Ø§Ù„ÙŠ)
â”œâ”€ Phase 1: Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø³Ø±ÙŠØ¹Ø© (Ø£Ø³Ø¨ÙˆØ¹ 1) âœ…
â”‚  â”œâ”€ Event Loop fix
â”‚  â”œâ”€ useMemo optimization
â”‚  â””â”€ Draft system fix
â”œâ”€ Phase 2: Legacy cleanup (Ø£Ø³Ø¨ÙˆØ¹ 2-3)
â”‚  â””â”€ Ø¥Ø²Ø§Ù„Ø© tender.quantities, tender.items, etc
â”œâ”€ Phase 3: Zustand migration (Ø£Ø³Ø¨ÙˆØ¹ 4-5)
â”‚  â””â”€ TenderPricingStore + TendersStore
â””â”€ Phase 4: Integration tests (Ø£Ø³Ø¨ÙˆØ¹ 6)
   â””â”€ Pricing flow end-to-end tests

Ù…Ø´Ø§Ø±ÙŠØ¹
â”œâ”€ Phase 1: ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…Ø³ØªÙØ§Ø¯Ø© Ù…Ù† Ù…Ù†Ø§ÙØ³Ø§Øª
â”œâ”€ Phase 2: ProjectsStore Ø¨Ù€ Zustand
â””â”€ Phase 3: Integration tests

... (Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…ÙˆØ¯ulØ§Øª)
```

**Ø§Ù„ÙÙˆØ§Ø¦Ø¯:**

- âœ… ÙƒÙ„ module ÙŠØ³ØªÙÙŠØ¯ Ù…Ù† ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚
- âœ… ØªØ¹Ù„Ù… Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù‚Ø¨Ù„ Ø§Ù„ØªÙˆØ³Ø¹
- âœ… ØªØ£Ø«ÙŠØ± ØªØ¯Ø±ÙŠØ¬ÙŠ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ù…Ø®Ø§Ø·Ø±Ø© ÙƒØ¨ÙŠØ±Ø©
- âœ… Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø®Ù„Ù (rollback) Ù„ÙƒÙ„ module Ø¨Ø´ÙƒÙ„ Ù…Ø³ØªÙ‚Ù„

---

## ğŸ“Š Ø§Ù„ØªÙˆØµÙŠØ© #1: State Management Library (Zustand)

### Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„

#### Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ (React Context Hell)

**Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©:**

1. **FinancialStateContext:**

   - 241 Ø³Ø·Ø± Ù…Ù† boilerplate
   - 9 custom hooks Ù…ÙØ¯Ù…Ø¬Ø©
   - 40+ dependencies ÙÙŠ useMemo
   - Ø£ÙŠ ØªØºÙŠÙŠØ± ÙÙŠ invoice â†’ re-render Ù„ÙƒÙ„ components

2. **TenderPricing:**

   - 3 hooks Ù…ØªØ¯Ø§Ø®Ù„Ø© (useTenderPricingPersistence, useEditableTenderPricing, useUnifiedTenderPricing)
   - Event cascading: boqUpdated â†’ TENDER_UPDATED â†’ refreshTenders (loop!)
   - useMemo ÙŠÙØ¹ÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨ 32 Ù…Ø±Ø©

3. **Navigation:**
   - useMemo Ù…Ø¹ 12+ dependencies
   - ÙƒÙ„ URL change â†’ re-render sidebar

**Ø§Ù„Ø£Ø¯Ù„Ø© Ù…Ù† Ø§Ù„ÙƒÙˆØ¯:**

```typescript
// src/application/hooks/useUnifiedTenderPricing.ts:29-41
const legacyData = useMemo(() => {
  return (
    tender.quantityTable ||
    tender.quantities ||
    tender.items ||
    tender.boqItems ||
    tender.quantityItems ||
    []
  )
}, [tender.quantityTable, tender.quantities, tender.items, tender.boqItems, tender.quantityItems])
// â†‘ 5 dependencies ØªØªØºÙŠØ± Ø¨Ø§Ø³ØªÙ…Ø±Ø§Ø±!
```

**Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ© (Ù…Ù† Console Logs):**

```
useUnifiedTenderPricing.ts:130 useMemo recalculation: 32
TendersPage.tsx:462 ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ§Øª (Ã—15)
storage.ts:450 âœ… Saved to electron-store (Ã—4)
```

#### Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù‚ØªØ±Ø­: Zustand

**Ù„Ù…Ø§Ø°Ø§ Zustand Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Redux ToolkitØŸ**

| Ø§Ù„Ù…Ø¹ÙŠØ§Ø±           | Zustand           | Redux Toolkit     | Ø§Ù„Ù‚Ø±Ø§Ø±     |
| ----------------- | ----------------- | ----------------- | ---------- |
| Bundle Size       | 1.2KB             | 56KB (RTK+Redux)  | âœ… Zustand |
| Learning Curve    | 2 Ø³Ø§Ø¹Ø©            | 2 ÙŠÙˆÙ…             | âœ… Zustand |
| Boilerplate       | Ù‚Ù„ÙŠÙ„ Ø¬Ø¯Ø§Ù‹         | Ù…ØªÙˆØ³Ø·             | âœ… Zustand |
| DevTools          | âœ… Ù…Ø¯Ø¹ÙˆÙ…          | âœ… Ù…Ø¯Ø¹ÙˆÙ…          | =          |
| Re-render Control | âœ… selector-based | âœ… selector-based | =          |
| Community         | ÙƒØ¨ÙŠØ±              | Ø¶Ø®Ù…               | âš ï¸ Redux   |
| TypeScript        | âœ… Ù…Ù…ØªØ§Ø²          | âœ… Ù…Ù…ØªØ§Ø²          | =          |
| Middleware        | âœ… ÙƒØ§ÙÙŠ           | âœ… ÙˆØ§Ø³Ø¹           | âš ï¸ Redux   |

**Ø§Ù„Ù‚Ø±Ø§Ø±:** Zustand Ù„Ø£Ù†Ù‡:

1. Ø£Ø®Ù (Ù…Ù‡Ù… Ù„Ù€ Electron)
2. Ø£Ø³Ø±Ø¹ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
3. ÙŠØªÙ…Ø§Ø´Ù‰ Ù…Ø¹ Hooks pattern Ø§Ù„Ø­Ø§Ù„ÙŠ
4. ÙƒØ§ÙÙŠ Ù„Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªÙ†Ø§

### Ø®Ø·Ø© Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©

#### Week 1-2: Tender Pricing Store

**Ø§Ù„ÙŠÙˆÙ… 1: Setup & Architecture**

```bash
npm install zustand
npm install --save-dev @types/zustand
```

```typescript
// stores/tenderPricingStore.ts
import { create } from 'zustand'
import { devtools, persist } from 'zustand/middleware'
import { immer } from 'zustand/middleware/immer'

interface TenderPricingState {
  // State
  pricingData: Map<string, Map<string, PricingData>> // tenderId â†’ itemId â†’ data
  boqData: Map<string, BOQData> // tenderId â†’ BOQ
  tenderMetadata: Map<string, TenderMetadata> // tenderId â†’ metadata
  drafts: Map<string, DraftData> // tenderId â†’ draft

  // UI State
  currentTenderId: string | null
  isDirty: Map<string, boolean> // tenderId â†’ dirty flag
  isLoading: Map<string, boolean>
  lastSaved: Map<string, string> // tenderId â†’ timestamp

  // Actions
  loadPricingData: (tenderId: string) => Promise<void>
  setPricingData: (tenderId: string, itemId: string, data: PricingData) => void
  savePricing: (tenderId: string) => Promise<void>
  approvePricing: (tenderId: string) => Promise<void>

  // Draft actions
  saveDraft: (tenderId: string) => Promise<void>
  loadDraft: (tenderId: string) => Promise<void>
  clearDraft: (tenderId: string) => void

  // Getters
  getUnifiedPricing: (tenderId: string) => UnifiedPricingData
  getTenderMetadata: (tenderId: string) => TenderMetadata | null
  getPricingCompletion: (tenderId: string) => number
}

export const useTenderPricingStore = create<TenderPricingState>()(
  devtools(
    persist(
      immer((set, get) => ({
        // Initial state
        pricingData: new Map(),
        boqData: new Map(),
        tenderMetadata: new Map(),
        drafts: new Map(),
        currentTenderId: null,
        isDirty: new Map(),
        isLoading: new Map(),
        lastSaved: new Map(),

        // Load pricing data from repositories
        loadPricingData: async (tenderId) => {
          set((draft) => {
            draft.isLoading.set(tenderId, true)
          })

          try {
            // Load from repositories (NO EVENTS!)
            const [pricing, boq, metadata] = await Promise.all([
              pricingService.loadTenderPricing(tenderId),
              getBOQRepository().getByTenderId(tenderId),
              getTenderRepository().getById(tenderId),
            ])

            set((draft) => {
              if (pricing?.pricing) {
                const map = new Map()
                pricing.pricing.forEach((item) => {
                  map.set(item.id, item)
                })
                draft.pricingData.set(tenderId, map)
              }

              if (boq) {
                draft.boqData.set(tenderId, boq)
              }

              if (metadata) {
                draft.tenderMetadata.set(tenderId, {
                  status: metadata.status,
                  pricedItems: metadata.pricedItems,
                  totalItems: metadata.totalItems,
                  totalValue: metadata.totalValue,
                  completionPercentage: metadata.completionPercentage,
                })
              }

              draft.isLoading.set(tenderId, false)
            })
          } catch (error) {
            console.error('Failed to load pricing data:', error)
            set((draft) => {
              draft.isLoading.set(tenderId, false)
            })
          }
        },

        // Set pricing for specific item
        setPricingData: (tenderId, itemId, data) => {
          set((draft) => {
            let tenderMap = draft.pricingData.get(tenderId)
            if (!tenderMap) {
              tenderMap = new Map()
              draft.pricingData.set(tenderId, tenderMap)
            }
            tenderMap.set(itemId, data)
            draft.isDirty.set(tenderId, true)
          })
        },

        // Save pricing (NO EVENTS - direct state update)
        savePricing: async (tenderId) => {
          const state = get()
          const pricingMap = state.pricingData.get(tenderId)
          if (!pricingMap) return

          set((draft) => {
            draft.isLoading.set(tenderId, true)
          })

          try {
            // Convert Map to array
            const items = Array.from(pricingMap.entries()).map(([itemId, data]) => ({
              id: itemId,
              ...data,
            }))

            // Save to repositories (NO EVENTS!)
            await Promise.all([
              pricingService.saveTenderPricing(tenderId, { pricing: items }),
              getBOQRepository().createOrUpdate(
                {
                  id: `boq_tender_${tenderId}`,
                  tenderId,
                  items,
                  totalValue: items.reduce((sum, item) => sum + (item.totalPrice || 0), 0),
                  lastUpdated: new Date().toISOString(),
                },
                { skipEvent: true },
              ), // â† Ù…Ù‡Ù…: Ù…Ù†Ø¹ Events!
            ])

            // Calculate metadata
            const metadata = {
              pricedItems: items.filter((i) => (i.totalPrice || 0) > 0).length,
              totalItems: items.length,
              totalValue: items.reduce((sum, i) => sum + (i.totalPrice || 0), 0),
              completionPercentage: Math.round(
                (items.filter((i) => (i.totalPrice || 0) > 0).length / items.length) * 100,
              ),
            }

            // Save metadata
            await getTenderRepository().update(tenderId, metadata, { skipEvent: true })

            // Update local state (ONE ATOMIC UPDATE)
            set((draft) => {
              draft.boqData.set(tenderId, {
                id: `boq_tender_${tenderId}`,
                tenderId,
                items,
                totalValue: metadata.totalValue,
                lastUpdated: new Date().toISOString(),
              })

              draft.tenderMetadata.set(tenderId, metadata)
              draft.isDirty.set(tenderId, false)
              draft.lastSaved.set(tenderId, new Date().toISOString())
              draft.isLoading.set(tenderId, false)
            })

            // âœ… NO EVENTS = NO LOOPS!
            console.log('âœ… Saved pricing successfully (no events)')
          } catch (error) {
            console.error('Failed to save pricing:', error)
            set((draft) => {
              draft.isLoading.set(tenderId, false)
            })
            throw error
          }
        },

        // Approve pricing (save + clear draft)
        approvePricing: async (tenderId) => {
          await get().savePricing(tenderId)

          set((draft) => {
            draft.drafts.delete(tenderId)
            draft.isDirty.set(tenderId, false)
          })
        },

        // Save draft
        saveDraft: async (tenderId) => {
          const state = get()
          const pricingMap = state.pricingData.get(tenderId)
          if (!pricingMap) return

          const draft = {
            items: Array.from(pricingMap.entries()).map(([id, data]) => ({ id, ...data })),
            savedAt: new Date().toISOString(),
          }

          await pricingStorageAdapter.saveDraft(tenderId, draft)

          set((state) => {
            state.drafts.set(tenderId, draft)
          })
        },

        // Load draft
        loadDraft: async (tenderId) => {
          const draft = await pricingStorageAdapter.loadDraft(tenderId)
          if (draft) {
            set((state) => {
              const map = new Map()
              draft.items.forEach((item) => {
                map.set(item.id, item)
              })
              state.pricingData.set(tenderId, map)
              state.drafts.set(tenderId, draft)
              state.isDirty.set(tenderId, true)
            })
          }
        },

        // Clear draft
        clearDraft: (tenderId) => {
          set((draft) => {
            draft.drafts.delete(tenderId)
          })
          void pricingStorageAdapter.deleteDraft(tenderId)
        },

        // Get unified pricing (replaces useUnifiedTenderPricing)
        getUnifiedPricing: (tenderId) => {
          const state = get()
          const boq = state.boqData.get(tenderId)

          if (boq && boq.items.length > 0) {
            return {
              items: boq.items,
              totals: {
                totalValue: boq.totalValue,
                itemCount: boq.items.length,
              },
              source: 'central-boq' as const,
            }
          }

          // Fallback: return empty (no legacy!)
          return {
            items: [],
            totals: { totalValue: 0, itemCount: 0 },
            source: 'none' as const,
          }
        },

        // Get tender metadata
        getTenderMetadata: (tenderId) => {
          return get().tenderMetadata.get(tenderId) || null
        },

        // Get pricing completion percentage
        getPricingCompletion: (tenderId) => {
          const metadata = get().tenderMetadata.get(tenderId)
          return metadata?.completionPercentage || 0
        },
      })),
      {
        name: 'tender-pricing-storage',
        partialize: (state) => ({
          // Don't persist everything - only essential data
          lastSaved: Object.fromEntries(state.lastSaved),
        }),
      },
    ),
    { name: 'TenderPricingStore' },
  ),
)
```

**Ø§Ù„ÙŠÙˆÙ… 2-3: Migrate TenderPricingPage**

```typescript
// TenderPricingPage.tsx - BEFORE
function TenderPricingPage({ tenderId }: Props) {
  const persistence = useTenderPricingPersistence(tenderId)
  const editable = useEditableTenderPricing(tenderId)
  const unified = useUnifiedTenderPricing(tender)

  // Complex logic...
}

// TenderPricingPage.tsx - AFTER
function TenderPricingPage({ tenderId }: Props) {
  // Simple selectors
  const pricingData = useTenderPricingStore((state) => state.pricingData.get(tenderId))
  const isDirty = useTenderPricingStore((state) => state.isDirty.get(tenderId))
  const isLoading = useTenderPricingStore((state) => state.isLoading.get(tenderId))

  const savePricing = useTenderPricingStore((state) => state.savePricing)
  const approvePricing = useTenderPricingStore((state) => state.approvePricing)
  const setPricingData = useTenderPricingStore((state) => state.setPricingData)

  // Load data on mount
  useEffect(() => {
    useTenderPricingStore.getState().loadPricingData(tenderId)
  }, [tenderId])

  const handleSave = async () => {
    await savePricing(tenderId)
    toast.success('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­')
  }

  const handleApprove = async () => {
    await approvePricing(tenderId)
    toast.success('ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­')
  }

  // âœ… Much simpler!
}
```

**Ø§Ù„ÙŠÙˆÙ… 4-5: Migrate TenderDetails & QuantitiesTab**

```typescript
// TenderDetails.tsx - BEFORE
function TenderDetails({ tender }: Props) {
  const unified = useUnifiedTenderPricing(tender)
  // useMemo recalculation: 32 times!
}

// TenderDetails.tsx - AFTER
function TenderDetails({ tender }: Props) {
  const unified = useTenderPricingStore((state) => state.getUnifiedPricing(tender.id))
  // âœ… Recalculates only when BOQ changes!
}
```

**Ø§Ù„ÙŠÙˆÙ… 6-7: Migrate TendersPage**

```typescript
// TendersPage.tsx - BEFORE
useEffect(() => {
  const onUpdated = () => {
    console.log('ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ§Øª') // Ã—15 times!
    void refreshTenders()
  }
  window.addEventListener(APP_EVENTS.TENDER_UPDATED, onUpdated)
  // ...
}, [])

// TendersPage.tsx - AFTER
// NO EVENT LISTENERS!
// Just subscribe to store
const tenders = useTendersStore((state) => state.tenders)
const metadata = useTenderPricingStore((state) => state.tenderMetadata)

// âœ… Re-renders only when tenders actually change!
```

#### Week 3-4: Financial Stores

**Store Composition Pattern:**

```typescript
// stores/financialStore.ts
import { create } from 'zustand'
import { devtools } from 'zustand/middleware'

// Slices
const createInvoicesSlice = (set, get) => ({
  invoices: [],
  loadInvoices: async () => {
    /* ... */
  },
  createInvoice: async (invoice) => {
    /* ... */
  },
})

const createBudgetsSlice = (set, get) => ({
  budgets: [],
  loadBudgets: async () => {
    /* ... */
  },
})

// ... more slices

// Combine
export const useFinancialStore = create()(
  devtools(
    (set, get) => ({
      ...createInvoicesSlice(set, get),
      ...createBudgetsSlice(set, get),
      ...createReportsSlice(set, get),
      ...createProjectsSlice(set, get),
      ...createTendersSlice(set, get),
      ...createClientsSlice(set, get),

      // Computed
      getMetrics: () => {
        const state = get()
        return selectAggregatedFinancialMetrics({
          invoices: state.invoices,
          budgets: state.budgets,
          // ...
        })
      },
    }),
    { name: 'FinancialStore' },
  ),
)
```

**Migration:**

- Ø­Ø°Ù `FinancialStateContext.tsx` (241 lines â†’ 0)
- ØªØ­ÙˆÙŠÙ„ ÙƒÙ„ hook Ø¥Ù„Ù‰ slice
- ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ components Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… selectors

#### Week 5-6: Testing & Refinement

**Performance Benchmarks:**

```typescript
// tests/performance/pricing-save.bench.ts
import { bench, describe } from 'vitest'

describe('Pricing Save Performance', () => {
  bench('Context-based save (old)', async () => {
    // Simulate old save with events
    // Expected: 1200ms
  })

  bench('Zustand-based save (new)', async () => {
    // Simulate new save without events
    // Expected: 180ms (85% faster!)
  })
})
```

**Expected Results:**

| Metric       | Before | After | Improvement |
| ------------ | ------ | ----- | ----------- |
| Save time    | 1200ms | 180ms | **85% âš¡**  |
| Re-renders   | 47     | 3     | **94% ğŸ¯**  |
| Console logs | 50+    | 5     | **90% âœ¨**  |
| Memory       | 45MB   | 28MB  | **38% ğŸ’¾**  |
| Code lines   | 850    | 320   | **62% ğŸ“‰**  |

### Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Electron Storage

```typescript
// stores/middleware/electronStorage.ts
import { safeLocalStorage } from '@/shared/utils/storage/storage'
import { createJSONStorage } from 'zustand/middleware'

export const electronStorage = createJSONStorage(() => ({
  getItem: async (name) => {
    return safeLocalStorage.getItem(name)
  },
  setItem: async (name, value) => {
    safeLocalStorage.setItem(name, value)
  },
  removeItem: async (name) => {
    safeLocalStorage.removeItem(name)
  },
}))

// Usage:
persist(
  (set, get) => ({
    /* ... */
  }),
  {
    name: 'tender-pricing',
    storage: electronStorage,
  },
)
```

---

## ğŸ“Š Ø§Ù„ØªÙˆØµÙŠØ© #2: Ø¥Ø²Ø§Ù„Ø© Legacy Data Paths

### Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„

#### Ø§Ù„Ù…Ø´ÙƒÙ„Ø©

**5+ Ù…ØµØ§Ø¯Ø± Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†ÙØ³Ù‡Ø§:**

```typescript
// Ù…Ù† useUnifiedTenderPricing.ts
const legacyData = useMemo(() => {
  return (
    tender.quantityTable || // Ø§Ù„Ù…ØµØ¯Ø± 1
    tender.quantities || // Ø§Ù„Ù…ØµØ¯Ø± 2
    tender.items || // Ø§Ù„Ù…ØµØ¯Ø± 3
    tender.boqItems || // Ø§Ù„Ù…ØµØ¯Ø± 4
    tender.quantityItems || // Ø§Ù„Ù…ØµØ¯Ø± 5
    []
  )
}, [tender.quantityTable, tender.quantities, tender.items, tender.boqItems, tender.quantityItems])
```

**Ø§Ù„Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ù…ØªØ£Ø«Ø±Ø© (Ù…Ù† grep_search):**

1. `useUnifiedTenderPricing.ts` - Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† 5 Ù…ØµØ§Ø¯Ø±
2. `NewTenderForm.tsx` - Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† 6 Ù…ØµØ§Ø¯Ø± (`scope.items` Ø£ÙŠØ¶Ø§Ù‹!)
3. `parseQuantityItems.ts` - Priority list Ù…Ù† 8 Ù…ØµØ§Ø¯Ø±
4. `tender.local.ts` - Normalization ØªÙ†Ø³Ø® quantities â†’ quantityTable
5. `tenderStatusMigration.ts` - Migration code Ù‚Ø¯ÙŠÙ…

**Ø§Ù„ØªØ£Ø«ÙŠØ±:**

- âŒ Confusion: Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„ØµØ­ÙŠØ­ØŸ
- âŒ Data inconsistency: Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ `quantities` Ù„ÙƒÙ† Ù„ÙŠØ³ ÙÙŠ `quantityTable`
- âŒ Performance: ÙØ­Øµ 5+ properties ÙÙŠ ÙƒÙ„ render
- âŒ Bugs: Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ù…ÙƒØ§Ù† ÙˆØ§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† Ø¢Ø®Ø±

#### Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù‚ØªØ±Ø­

**Ù…ØµØ¯Ø± ÙˆØ§Ø­Ø¯ Ù„Ù„Ø­Ù‚ÙŠÙ‚Ø©: BOQ Repository**

```
BEFORE:
Tender {
  quantities: []       â† delete
  quantityTable: []    â† delete
  items: []           â† delete
  boqItems: []        â† delete
  quantityItems: []   â† delete
  scope: { items: [] } â† delete
}

AFTER:
Tender {
  // Metadata only
  pricedItems: number
  totalItems: number
  totalValue: number
  completionPercentage: number
}

BOQRepository {
  boq_tender_${tenderId} {
    items: []  â† SINGLE SOURCE
    totalValue: number
    lastUpdated: string
  }
}
```

### Ø®Ø·Ø© Ø§Ù„ØªÙ†ÙÙŠØ°

#### Phase 1: Migration Script (ÙŠÙˆÙ… 1-2)

```typescript
// scripts/migrateLegacyQuantitiesToBOQ.ts
import { getTenderRepository } from '@/application/services/serviceRegistry'
import { getBOQRepository } from '@/application/services/serviceRegistry'
import { buildPricingMap } from '@/shared/utils/pricing/normalizePricing'

async function migrateLegacyQuantities() {
  const tenderRepo = getTenderRepository()
  const boqRepo = getBOQRepository()

  const tenders = await tenderRepo.getAll()
  let migrated = 0
  let skipped = 0

  for (const tender of tenders) {
    // Check if BOQ already exists
    const existingBOQ = await boqRepo.getByTenderId(tender.id)
    if (existingBOQ && existingBOQ.items.length > 0) {
      console.log(`â­ï¸ Skipping ${tender.id} - BOQ exists`)
      skipped++
      continue
    }

    // Extract from legacy sources
    const legacyItems =
      tender.quantityTable ||
      tender.quantities ||
      tender.items ||
      tender.boqItems ||
      tender.quantityItems ||
      (tender as any).scope?.items ||
      []

    if (legacyItems.length === 0) {
      console.log(`â­ï¸ Skipping ${tender.id} - no legacy data`)
      skipped++
      continue
    }

    // Normalize
    const pricingMap = buildPricingMap(legacyItems)
    const normalizedItems = Array.from(pricingMap.values())

    // Create BOQ
    await boqRepo.createOrUpdate({
      id: `boq_tender_${tender.id}`,
      tenderId: tender.id,
      items: normalizedItems,
      totalValue: normalizedItems.reduce((sum, item) => sum + (item.totalPrice || 0), 0),
      lastUpdated: new Date().toISOString(),
    })

    // Update tender metadata
    await tenderRepo.update(tender.id, {
      totalItems: normalizedItems.length,
      pricedItems: normalizedItems.filter((i) => (i.totalPrice || 0) > 0).length,
      totalValue: normalizedItems.reduce((sum, i) => sum + (i.totalPrice || 0), 0),
    })

    // IMPORTANT: Delete legacy fields
    const cleaned = { ...tender }
    delete cleaned.quantities
    delete cleaned.quantityTable
    delete cleaned.items
    delete cleaned.boqItems
    delete cleaned.quantityItems
    if ((cleaned as any).scope) {
      delete (cleaned as any).scope.items
    }

    await tenderRepo.update(tender.id, cleaned)

    console.log(`âœ… Migrated ${tender.id} (${normalizedItems.length} items)`)
    migrated++
  }

  console.log(`\nâœ… Migration complete: ${migrated} migrated, ${skipped} skipped`)
}

// Run
migrateLegacyQuantities().catch(console.error)
```

**ØªØ´ØºÙŠÙ„:**

```bash
npm run migrate:quantities
```

#### Phase 2: Code Cleanup (ÙŠÙˆÙ… 3-7)

**Ù…Ù„ÙØ§Øª Ù„Ù„Ø­Ø°Ù/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:**

```typescript
// âŒ DELETE: useUnifiedTenderPricing.ts - Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¨Ù€ store getter
// âŒ DELETE: parseQuantityItems.ts - Ù„Ù… ÙŠØ¹Ø¯ Ø¶Ø±ÙˆØ±ÙŠØ§Ù‹ (source ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·)

// âœï¸ MODIFY: NewTenderForm.tsx
// BEFORE:
const sourceData =
  tender?.quantities ||
  tender?.quantityTable ||
  tender?.items ||
  tender?.boqItems ||
  tender?.quantityItems ||
  (tender as any)?.scope?.items

// AFTER:
const loadQuantities = async () => {
  if (!tender?.id) return []
  const boq = await getBOQRepository().getByTenderId(tender.id)
  return boq?.items || []
}

// âœï¸ MODIFY: tender.local.ts - Remove normalization
// BEFORE (line 48-56):
if (Array.isArray((normalized as any).quantities) && (normalized as any).quantities.length > 0) {
  if (
    !Array.isArray((normalized as any).quantityTable) ||
    (normalized as any).quantityTable.length === 0
  ) {
    ;(normalized as any).quantityTable = (normalized as any).quantities
  }
}

// AFTER:
// Delete this entire block - no longer needed

// âœï¸ MODIFY: Tender type definition
// src/data/centralData.ts
export interface Tender {
  id: string
  // ... other fields

  // Metadata only (calculated from BOQ)
  totalItems?: number
  pricedItems?: number
  totalValue?: number
  completionPercentage?: number

  // âŒ REMOVE these:
  // quantities?: QuantityItem[]
  // quantityTable?: QuantityItem[]
  // items?: any[]
  // boqItems?: any[]
  // quantityItems?: any[]
}
```

#### Phase 3: Update Components (ÙŠÙˆÙ… 8-10)

**Pattern:**

```typescript
// BEFORE: Read from tender object
const items = tender.quantities || tender.quantityTable || []

// AFTER: Read from BOQ Repository
const boq = useTenderPricingStore((state) => state.boqData.get(tender.id))
const items = boq?.items || []
```

**Affected files (estimate: 15-20 files):**

- TenderDetails.tsx
- QuantitiesTab.tsx
- TenderPricingPage.tsx
- NewTenderForm.tsx
- EnhancedTenderCard.tsx
- EnhancedProjectDetails.tsx
- projectAutoCreation.ts
- ... more

#### Phase 4: Validation & Testing (ÙŠÙˆÙ… 11-14)

```typescript
// tests/migration/legacy-cleanup.test.ts
describe('Legacy Data Cleanup', () => {
  it('should not have legacy quantity fields', async () => {
    const tenders = await getTenderRepository().getAll()

    for (const tender of tenders) {
      expect(tender).not.toHaveProperty('quantities')
      expect(tender).not.toHaveProperty('quantityTable')
      expect(tender).not.toHaveProperty('items')
      expect(tender).not.toHaveProperty('boqItems')
      expect(tender).not.toHaveProperty('quantityItems')
    }
  })

  it('should have BOQ for tenders with items', async () => {
    const tenders = await getTenderRepository().getAll()
    const boqRepo = getBOQRepository()

    for (const tender of tenders) {
      if (tender.totalItems && tender.totalItems > 0) {
        const boq = await boqRepo.getByTenderId(tender.id)
        expect(boq).toBeDefined()
        expect(boq!.items.length).toBeGreaterThan(0)
      }
    }
  })
})
```

### Expected Benefits

| Benefit          | Before                 | After                |
| ---------------- | ---------------------- | -------------------- |
| Data sources     | 5-8 sources            | 1 source (BOQ)       |
| Code complexity  | High (fallback chains) | Low (direct access)  |
| Data consistency | âš ï¸ Risk of mismatch    | âœ… Guaranteed        |
| Performance      | 5+ property checks     | 1 lookup             |
| Maintenance      | Hard (which source?)   | Easy (single source) |

---

## ğŸ“Š Ø§Ù„ØªÙˆØµÙŠØ© #3: Simplify Draft System

### Ø§Ù„ØªØ­Ù„ÙŠÙ„

#### Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©

**Dual Storage (official + draft):**

```typescript
// useEditableTenderPricing.ts - Current
interface EditableState {
  items: PricingSnapshotItem[]
  totals: PricingSnapshotTotals | null
  source: 'official' | 'draft' | 'none'
  hasDraft: boolean
  isDraftNewer: boolean // â† PROBLEM: never resets!
  dirty: boolean
  officialAt: string | undefined
  draftAt: string | undefined
}

// Logic:
if (draft && (!official || draft.meta.savedAt > official.meta.savedAt)) {
  setIsDraftNewer(!!official) // â† Stays true after approval!
  setDirty(!!official)
}
```

**Issues:**

1. âŒ `isDraftNewer` never resets after `saveOfficial()`
2. âŒ Draft not deleted after approval
3. âŒ Auto-save continues after approval
4. âŒ User sees "unsaved changes" warning even after saving

#### Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù‚ØªØ±Ø­

**Single State with isDirty Flag:**

```typescript
// In Zustand store
interface SimplifiedDraftState {
  items: PricingSnapshotItem[]
  totals: PricingSnapshotTotals | null
  isDirty: boolean
  lastSaved: string | null
  lastModified: string | null
}

// No more:
// - hasDraft
// - isDraftNewer
// - source
// - officialAt
// - draftAt
```

### Ø®Ø·Ø© Ø§Ù„ØªÙ†ÙÙŠØ°

#### Week 1: Zustand Integration

```typescript
// Already included in TenderPricingStore above!
const useTenderPricingStore = create()(
  devtools((set, get) => ({
    // State
    pricingData: new Map<string, Map<string, PricingData>>(),
    isDirty: new Map<string, boolean>(),
    lastSaved: new Map<string, string>(),

    // Actions
    setPricingData: (tenderId, itemId, data) => {
      set((draft) => {
        // Update data
        const map = draft.pricingData.get(tenderId) || new Map()
        map.set(itemId, data)
        draft.pricingData.set(tenderId, map)

        // Set dirty flag
        draft.isDirty.set(tenderId, true)

        // âœ… Simple! No draft/official confusion
      })
    },

    savePricing: async (tenderId) => {
      // ... save logic

      set((draft) => {
        draft.isDirty.set(tenderId, false)
        draft.lastSaved.set(tenderId, new Date().toISOString())
      })

      // âœ… isDirty automatically reset!
    },

    // Auto-save (debounced)
    autoSave: debounce(async (tenderId) => {
      const state = get()
      if (state.isDirty.get(tenderId)) {
        await state.savePricing(tenderId)
      }
    }, 2000),
  })),
)
```

**Component Usage:**

```typescript
// TenderPricingPage.tsx
function TenderPricingPage({ tenderId }: Props) {
  const isDirty = useTenderPricingStore((state) => state.isDirty.get(tenderId))

  // Warning on leave
  useEffect(() => {
    if (!isDirty) return

    const handler = (e: BeforeUnloadEvent) => {
      e.preventDefault()
      e.returnValue = 'Ù„Ø¯ÙŠÙƒ ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©'
    }

    window.addEventListener('beforeunload', handler)
    return () => window.removeEventListener('beforeunload', handler)
  }, [isDirty])

  // âœ… Warning only shows when ACTUALLY dirty!
  // âœ… Automatically disappears after save!
}
```

#### Cleanup

**Delete files:**

- `useEditableTenderPricing.ts` - logic moved to store
- `pricingStorageAdapter.ts` - no more dual storage

**Expected Benefits:**

| Metric           | Before                    | After        |
| ---------------- | ------------------------- | ------------ |
| State complexity | High (7 flags)            | Low (1 flag) |
| Code lines       | ~200                      | ~50          |
| User confusion   | "Why warning after save?" | No confusion |
| Bugs             | isDraftNewer stuck        | No bugs      |

---

## ğŸ“Š Ø§Ù„ØªÙˆØµÙŠØ© #4: Add Integration Tests

### Ø§Ù„Ø£Ù‡Ù…ÙŠØ©

**Why Integration Tests?**

Ù…Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© (Zustand + Legacy cleanup + Draft simplification)ØŒ Ù†Ø­ØªØ§Ø¬:

1. âœ… Confidence Ø£Ù† ÙƒÙ„ Ø´ÙŠØ¡ ÙŠØ¹Ù…Ù„ end-to-end
2. âœ… Regression prevention Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©
3. âœ… Documentation Ø­ÙŠØ© Ù„Ù€ flows Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©

### Ø®Ø·Ø© Ø§Ù„ØªÙ†ÙÙŠØ°

#### Week 1-2: Pricing Flow Tests

```typescript
// tests/integration/pricing-flow.test.ts
import { describe, it, expect, beforeEach } from 'vitest'
import { render, screen, waitFor } from '@testing-library/react'
import userEvent from '@testing-library/user-event'
import { useTenderPricingStore } from '@/stores/tenderPricingStore'

describe('Tender Pricing Flow (End-to-End)', () => {
  beforeEach(() => {
    // Reset store
    useTenderPricingStore.setState({
      pricingData: new Map(),
      isDirty: new Map(),
      // ...
    })
  })

  it('should complete full pricing flow: load â†’ edit â†’ save â†’ approve', async () => {
    const user = userEvent.setup()

    // 1. Load tender pricing page
    render(<TenderPricingPage tenderId="tender-123" />)

    // Wait for data to load
    await waitFor(() => {
      expect(screen.getByText(/Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙƒÙ…ÙŠØ§Øª/)).toBeInTheDocument()
    })

    // 2. Edit an item
    const priceInput = screen.getByLabelText(/Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©/)
    await user.clear(priceInput)
    await user.type(priceInput, '1000')

    // Verify dirty flag
    const state = useTenderPricingStore.getState()
    expect(state.isDirty.get('tender-123')).toBe(true)

    // 3. Save
    const saveButton = screen.getByRole('button', { name: /Ø­ÙØ¸/ })
    await user.click(saveButton)

    // Wait for save
    await waitFor(() => {
      expect(screen.getByText(/ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­/)).toBeInTheDocument()
    })

    // Verify dirty flag reset
    expect(state.isDirty.get('tender-123')).toBe(false)

    // 4. Navigate away (no warning should appear)
    window.dispatchEvent(new Event('beforeunload'))
    // Should NOT prevent navigation

    // 5. Go back and approve
    const approveButton = screen.getByRole('button', { name: /Ø§Ø¹ØªÙ…Ø§Ø¯/ })
    await user.click(approveButton)

    // Verify BOQ created
    const boq = state.boqData.get('tender-123')
    expect(boq).toBeDefined()
    expect(boq!.items.length).toBeGreaterThan(0)

    // Verify metadata updated
    const metadata = state.tenderMetadata.get('tender-123')
    expect(metadata).toBeDefined()
    expect(metadata!.totalValue).toBeGreaterThan(0)
  })

  it('should NOT show warning after save', async () => {
    const user = userEvent.setup()

    render(<TenderPricingPage tenderId="tender-123" />)

    // Edit
    const priceInput = screen.getByLabelText(/Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©/)
    await user.type(priceInput, '500')

    // Save
    await user.click(screen.getByRole('button', { name: /Ø­ÙØ¸/ }))
    await waitFor(() => {
      expect(screen.getByText(/ØªÙ… Ø§Ù„Ø­ÙØ¸/)).toBeInTheDocument()
    })

    // Try to leave
    const event = new Event('beforeunload', { cancelable: true })
    window.dispatchEvent(event)

    // Should NOT be prevented
    expect(event.defaultPrevented).toBe(false)
  })

  it('should prevent data loss on refresh (auto-save)', async () => {
    // Mock window.addEventListener
    const listeners = new Map()
    vi.spyOn(window, 'addEventListener').mockImplementation((event, handler) => {
      listeners.set(event, handler)
    })

    const user = userEvent.setup()

    render(<TenderPricingPage tenderId="tender-123" />)

    // Edit multiple items
    const inputs = screen.getAllByLabelText(/Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©/)
    for (const input of inputs) {
      await user.type(input, '100')
    }

    // Wait for auto-save (2 seconds debounce)
    await waitFor(() => {
      const state = useTenderPricingStore.getState()
      expect(state.isDirty.get('tender-123')).toBe(false)
    }, { timeout: 3000 })

    // Simulate refresh
    const beforeunloadHandler = listeners.get('beforeunload')
    const event = new Event('beforeunload', { cancelable: true })
    beforeunloadHandler?.(event)

    // Should NOT prevent (already saved)
    expect(event.defaultPrevented).toBe(false)
  })
})
```

#### Week 3: Performance Tests

```typescript
// tests/integration/pricing-performance.test.ts
describe('Pricing Performance (No Event Loops)', () => {
  it('should save without excessive re-renders', async () => {
    let renderCount = 0

    const TestComponent = () => {
      renderCount++
      const pricingData = useTenderPricingStore(state => state.pricingData.get('tender-123'))
      return <div>{pricingData ? 'Loaded' : 'Empty'}</div>
    }

    render(<TestComponent />)

    // Reset count
    renderCount = 0

    // Save pricing
    await useTenderPricingStore.getState().savePricing('tender-123')

    // Should trigger only 1-2 re-renders (not 30+!)
    expect(renderCount).toBeLessThan(5)
  })

  it('should update TendersPage without mass refresh', async () => {
    let refreshCount = 0

    const TestTendersPage = () => {
      const metadata = useTenderPricingStore(state => state.tenderMetadata)

      useEffect(() => {
        refreshCount++
      }, [metadata])

      return <div>Tenders</div>
    }

    render(<TestTendersPage />)

    refreshCount = 0

    // Update one tender
    await useTenderPricingStore.getState().savePricing('tender-123')

    // Should trigger only 1 refresh (not 15!)
    expect(refreshCount).toBe(1)
  })
})
```

---

## ğŸ—“ï¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„

### Phase 1: Tender System (10 weeks)

```
Week 1-2: Quick Fixes + Planning
â”œâ”€ Day 1-2: Event Loop fix (debounce + guard)
â”œâ”€ Day 3-4: useMemo optimization
â”œâ”€ Day 5-7: Draft system fix
â”œâ”€ Day 8-10: Planning & Architecture design
â””â”€ Deliverable: 3/4 Ù…Ø´Ø§ÙƒÙ„ Ù…Ø­Ù„ÙˆÙ„Ø©

Week 3-4: Zustand Migration - Pricing
â”œâ”€ Day 1: Setup + TenderPricingStore
â”œâ”€ Day 2-3: Migrate TenderPricingPage
â”œâ”€ Day 4-5: Migrate TenderDetails
â”œâ”€ Day 6-7: Migrate TendersPage
â””â”€ Deliverable: Pricing system Ø¹Ù„Ù‰ Zustand

Week 5-6: Legacy Data Cleanup
â”œâ”€ Day 1-2: Migration script
â”œâ”€ Day 3-5: Run migration + verification
â”œâ”€ Day 6-7: Code cleanup (delete legacy paths)
â”œâ”€ Day 8-10: Update components
â””â”€ Deliverable: Single source (BOQ only)

Week 7-8: Zustand Migration - Tenders List
â”œâ”€ Day 1-3: TendersStore (CRUD operations)
â”œâ”€ Day 4-6: Migrate TendersPage
â”œâ”€ Day 7-10: Migrate NewTenderForm
â””â”€ Deliverable: Full tenders system on Zustand

Week 9-10: Integration Tests
â”œâ”€ Day 1-5: Pricing flow tests
â”œâ”€ Day 6-8: Performance tests
â”œâ”€ Day 9-10: Regression suite
â””â”€ Deliverable: Test coverage 80%+
```

### Phase 2: Projects System (6 weeks)

```
Week 11-12: Apply Lessons Learned
â”œâ”€ ProjectsStore creation
â”œâ”€ Migrate EnhancedProjectDetails
â””â”€ BOQ integration

Week 13-14: Purchase Orders Integration
â”œâ”€ PurchaseOrdersStore
â”œâ”€ BOQ sync with POs
â””â”€ Cost tracking

Week 15-16: Integration Tests
â””â”€ Project creation â†’ BOQ â†’ POs flow
```

### Phase 3-6: Remaining Systems (16 weeks)

```
Ù…Ø´ØªØ±ÙŠØ§Øª (4 weeks)
â”œâ”€ PurchasesStore
â”œâ”€ Suppliers management
â””â”€ Purchase orders

Ù…Ø§Ù„ÙŠØ© (5 weeks)
â”œâ”€ FinancialStore (already designed!)
â”œâ”€ Invoices, Budgets, Reports slices
â””â”€ Currency integration

ØªÙ‚Ø§Ø±ÙŠØ± (3 weeks)
â”œâ”€ ReportsStore
â”œâ”€ Report generation
â””â”€ Export functionality

Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (4 weeks)
â”œâ”€ DashboardStore
â”œâ”€ Metrics aggregation
â””â”€ Real-time updates
```

---

## ğŸ“Š Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø­Ù„ÙˆÙ„

### Option A: Big Bang (NOT RECOMMENDED)

**Ø§Ù„Ù†Ù‡Ø¬:** ØªØ·Ø¨ÙŠÙ‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØµÙŠØ§Øª Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¯ulØ§Øª

**Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª:**

- âœ… Ø³Ø±Ø¹Ø© ÙÙŠ Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ø¸Ø±ÙŠØ©

**Ø§Ù„Ø¹ÙŠÙˆØ¨:**

- âŒ Ø®Ø·Ø± ÙƒØ¨ÙŠØ± (Ù‚Ø¯ ÙŠØªØ¹Ø·Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„)
- âŒ ØµØ¹ÙˆØ¨Ø© Ø§Ù„Ù€ rollback
- âŒ testing Ø´Ø§Ù…Ù„ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚
- âŒ Ø§Ù„ØªØ¹Ù„Ù… Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù…ØªØ£Ø®Ø± Ø¬Ø¯Ø§Ù‹

**Ø§Ù„Ù…Ø¯Ø©:** 6-8 Ø£Ø³Ø§Ø¨ÙŠØ¹ (Ø¨Ø®Ø·Ø± Ø¹Ø§Ù„ÙŠ)

---

### Option B: Incremental (RECOMMENDED âœ…)

**Ø§Ù„Ù†Ù‡Ø¬:** module by module Ù…Ø¹ ØªØ·Ø¨ÙŠÙ‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØµÙŠØ§Øª Ù„ÙƒÙ„ module

**Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª:**

- âœ… ØªØ¹Ù„Ù… Ù…Ù† ÙƒÙ„ module
- âœ… Rollback Ø³Ù‡Ù„
- âœ… Testing Ù…Ø³ØªÙ…Ø±
- âœ… ØªØ­Ø³ÙŠÙ†Ø§Øª ØªØ¯Ø±ÙŠØ¬ÙŠØ© Ù…Ù„Ù…ÙˆØ³Ø©

**Ø§Ù„Ø¹ÙŠÙˆØ¨:**

- âš ï¸ Ø£Ø·ÙˆÙ„ ÙÙŠ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©

**Ø§Ù„Ù…Ø¯Ø©:** 32 Ø£Ø³Ø¨ÙˆØ¹ (8 Ø´Ù‡ÙˆØ±) - Ù„ÙƒÙ† Ø£ÙƒØ«Ø± Ø£Ù…Ø§Ù†Ø§Ù‹

**Ø§Ù„Ø¬Ø¯ÙˆÙ„:**

```
Month 1-2: Tenders (10 weeks)
Month 3: Projects (6 weeks)
Month 4: Purchases (4 weeks)
Month 5-6: Financial (5 weeks)
Month 7: Reports (3 weeks)
Month 8: Dashboard (4 weeks)
```

---

### Option C: Hybrid (BEST CHOICE ğŸŒŸ)

**Ø§Ù„Ù†Ù‡Ø¬:** ØªØ·Ø¨ÙŠÙ‚ Ø³Ø±ÙŠØ¹ Ù„Ù„Ù€ Tenders + ØªØ­Ø³ÙŠÙ†Ø§Øª ØªØ¯Ø±ÙŠØ¬ÙŠØ© Ù„Ù„Ø¨Ø§Ù‚ÙŠ

**Phase 1 (Fast): Tenders System (6 weeks)**

- Week 1: Quick fixes (Event Loop + useMemo + Draft)
- Week 2-3: Zustand migration
- Week 4: Legacy cleanup
- Week 5-6: Integration tests

**Phase 2 (Medium): Projects + Purchases (8 weeks)**

- Week 7-10: Projects with Zustand
- Week 11-14: Purchases with Zustand

**Phase 3 (Planned): Financial + Reports + Dashboard (12 weeks)**

- Week 15-20: Financial system
- Week 21-24: Reports
- Week 25-26: Dashboard

**Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª:**

- âœ… Ø³Ø±Ø¹Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù‡Ù… (Tenders)
- âœ… ØªØ¹Ù„Ù… ÙˆØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ù‚ÙŠ
- âœ… ØªÙˆØ§Ø²Ù† Ø¨ÙŠÙ† Ø§Ù„Ø³Ø±Ø¹Ø© ÙˆØ§Ù„Ø£Ù…Ø§Ù†

**Ø§Ù„Ù…Ø¯Ø©:** 26 Ø£Ø³Ø¨ÙˆØ¹ (6.5 Ø´Ù‡Ø±)

---

## ğŸ¯ Ø§Ù„ØªÙˆØµÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©

### Ø§Ø®ØªØ±: **Option C (Hybrid)**

**Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨:**

1. **Tenders Ù‡Ùˆ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:** Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø­Ø±Ø¬Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù‡Ù†Ø§
2. **ROI Ø³Ø±ÙŠØ¹:** 6 Ø£Ø³Ø§Ø¨ÙŠØ¹ Ù„Ù„Ø­Ù„ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ø£Ù‡Ù… Ù†Ø¸Ø§Ù…
3. **Risk management:** Ø¨Ø¯Ø¡ ØµØºÙŠØ±ØŒ ØªÙˆØ³Ø¹ ØªØ¯Ø±ÙŠØ¬ÙŠ
4. **Team learning:** Ø§Ù„ÙØ±ÙŠÙ‚ ÙŠØªØ¹Ù„Ù… Zustand Ø¹Ù„Ù‰ module ÙˆØ§Ø­Ø¯ Ø£ÙˆÙ„Ø§Ù‹

### Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙÙˆØ±ÙŠØ©

**Week 1 (Ø§Ù„Ø¢Ù†):**

```
Day 1: âœ… Install Zustand + setup stores folder
Day 2: âœ… Create TenderPricingStore (basic)
Day 3: âœ… Event Loop fix + useMemo fix
Day 4-5: âœ… Migrate TenderPricingPage
Day 6-7: âœ… Testing + refinement
```

**Week 2:**

```
Day 1-3: Migrate TenderDetails + QuantitiesTab
Day 4-5: Migrate TendersPage
Day 6-7: Integration tests
```

**Week 3-4:**

```
Legacy cleanup:
- Migration script
- Run on all tenders
- Verify data integrity
- Delete old code paths
```

**Week 5-6:**

```
Finalize + document:
- Performance benchmarks
- User acceptance testing
- Documentation
- Team training
```

---

## ğŸ“ˆ Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ù†Ø¬Ø§Ø­

### KPIs Ù„Ù„ØªØªØ¨Ø¹

| Ø§Ù„Ù…Ù‚ÙŠØ§Ø³               | Ø§Ù„Ù‡Ø¯Ù           | ÙƒÙŠÙ Ù†Ù‚ÙŠØ³                           |
| --------------------- | --------------- | ---------------------------------- |
| **Save Time**         | <200ms          | Performance.now() ÙÙŠ savePricing() |
| **Re-renders**        | <5 per save     | React DevTools Profiler            |
| **Console Logs**      | <10 per save    | Count ÙÙŠ Console                   |
| **Memory Usage**      | <30MB           | Chrome DevTools Memory             |
| **Code Reduction**    | -50%            | Line count comparison              |
| **Test Coverage**     | >80%            | Vitest coverage report             |
| **User Satisfaction** | "Ù„Ø§ ÙŠÙˆØ¬Ø¯ flash" | User testing                       |

### Acceptance Criteria

```typescript
// tests/acceptance/pricing-system.test.ts
describe('Pricing System - Acceptance Criteria', () => {
  it('âœ… should save in less than 200ms', async () => {
    const start = performance.now()
    await useTenderPricingStore.getState().savePricing('tender-123')
    const duration = performance.now() - start

    expect(duration).toBeLessThan(200)
  })

  it('âœ… should not show flash during save', async () => {
    // Visual regression test
    const screenshot1 = await page.screenshot()
    await page.click('[data-testid="save-button"]')
    await page.waitForTimeout(100)
    const screenshot2 = await page.screenshot()

    // Should be identical (no flash)
    const diff = await compareImages(screenshot1, screenshot2)
    expect(diff).toBeLessThan(0.01) // <1% difference
  })

  it('âœ… should not show warning after approval', async () => {
    await useTenderPricingStore.getState().approvePricing('tender-123')

    const event = new Event('beforeunload', { cancelable: true })
    window.dispatchEvent(event)

    expect(event.defaultPrevented).toBe(false)
  })
})
```

---

## ğŸš¨ Ø§Ù„Ù…Ø®Ø§Ø·Ø± ÙˆØ§Ù„ØªØ®ÙÙŠÙ

### Risk Matrix

| Ø§Ù„Ø®Ø·Ø±                          | Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„ | Ø§Ù„ØªØ£Ø«ÙŠØ± | Ø§Ù„Ø®Ø·Ø©                      |
| ------------------------------ | -------- | ------- | -------------------------- |
| **Data loss Ø£Ø«Ù†Ø§Ø¡ Migration**  | Ù…ØªÙˆØ³Ø·    | Ø¹Ø§Ù„ÙŠ    | âœ… Backup Ù‚Ø¨Ù„ ÙƒÙ„ migration |
| **Performance regression**     | Ù…Ù†Ø®ÙØ¶    | Ø¹Ø§Ù„ÙŠ    | âœ… Benchmark tests Ù‚Ø¨Ù„/Ø¨Ø¹Ø¯ |
| **Team resistance to Zustand** | Ù…ØªÙˆØ³Ø·    | Ù…ØªÙˆØ³Ø·   | âœ… Training session + docs |
| **Integration bugs**           | Ø¹Ø§Ù„ÙŠ     | Ù…ØªÙˆØ³Ø·   | âœ… Comprehensive tests     |
| **Timeline overrun**           | Ù…ØªÙˆØ³Ø·    | Ù…ØªÙˆØ³Ø·   | âœ… Buffer ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„        |

### Mitigation Plans

**1. Data Loss Prevention:**

```typescript
// Before migration
await createBackup('pre-zustand-migration')

// After migration
await verifyDataIntegrity()

// If failed
await rollbackFromBackup('pre-zustand-migration')
```

**2. Performance Monitoring:**

```typescript
// Performance tracking wrapper
const withPerformanceTracking =
  (fn) =>
  async (...args) => {
    const start = performance.now()
    const result = await fn(...args)
    const duration = performance.now() - start

    console.log(`[Perf] ${fn.name}: ${duration}ms`)

    if (duration > 500) {
      console.warn(`âš ï¸ Performance regression detected!`)
    }

    return result
  }
```

**3. Gradual Rollout:**

```typescript
// Feature flag
const ENABLE_ZUSTAND = process.env.VITE_ENABLE_ZUSTAND === 'true'

// Conditional store usage
const pricingData = ENABLE_ZUSTAND
  ? useTenderPricingStore((state) => state.pricingData)
  : useTenderPricingPersistence() // Old way

// Allow quick rollback if issues
```

---

## ğŸ“š Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ ÙˆØ§Ù„ØªÙˆØ«ÙŠÙ‚

### Documentation to Create

1. **ZUSTAND_GUIDE_AR.md** - Ø¯Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ
2. **MIGRATION_PLAYBOOK.md** - Ø®Ø·ÙˆØ§Øª Migration Ù„ÙƒÙ„ module
3. **STORE_ARCHITECTURE.md** - Ø¨Ù†ÙŠØ© Stores ÙˆÙ‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªØµÙ…ÙŠÙ…
4. **TESTING_STRATEGY.md** - Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
5. **ROLLBACK_PROCEDURES.md** - Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø®Ù„Ù

### Team Training

```
Session 1 (4 hours): Zustand Fundamentals
â”œâ”€ Why Zustand?
â”œâ”€ Basic store creation
â”œâ”€ Selectors & re-render optimization
â”œâ”€ Middleware (devtools, persist)
â””â”€ Hands-on exercises

Session 2 (4 hours): Migration Patterns
â”œâ”€ Context to Zustand conversion
â”œâ”€ Event system removal
â”œâ”€ Testing Zustand stores
â””â”€ Real migration (Tenders example)

Session 3 (2 hours): Q&A + Best Practices
â”œâ”€ Common pitfalls
â”œâ”€ Performance optimization
â””â”€ Debugging with DevTools
```

---

## âœ… Next Steps (Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹)

### Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ©

**ÙŠÙˆÙ… 1 (Ø§Ù„ÙŠÙˆÙ…):**

```bash
# 1. Install dependencies
npm install zustand
npm install immer

# 2. Create stores folder
mkdir -p src/stores

# 3. Create first store (skeleton)
touch src/stores/tenderPricingStore.ts

# 4. Apply quick fixes
# - Edit TendersPage.tsx (Event Loop fix)
# - Edit useUnifiedTenderPricing.ts (useMemo fix)
```

**ÙŠÙˆÙ… 2-3:**

```typescript
// Implement TenderPricingStore (full)
// See code above in "Week 1-2: Tender Pricing Store"
```

**ÙŠÙˆÙ… 4-5:**

```typescript
// Migrate TenderPricingPage to use store
// Test thoroughly
```

**ÙŠÙˆÙ… 6-7:**

```typescript
// Write integration tests
// Performance benchmarks
// User testing
```

---

**Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:** 24 Ø£ÙƒØªÙˆØ¨Ø± 2025  
**Ø§Ù„Ù…Ø¤Ù„Ù:** GitHub Copilot (Ø®Ø¨ÙŠØ± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù‡ÙŠÙƒÙ„Ø©)  
**Ø§Ù„Ø­Ø§Ù„Ø©:** Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙ†ÙÙŠØ°
