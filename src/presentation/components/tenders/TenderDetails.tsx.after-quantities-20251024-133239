// TenderDetails renders the full tender workspace with tabs, documents, and workflow.
/* eslint-disable @typescript-eslint/no-explicit-any */
/* eslint-disable @typescript-eslint/consistent-indexed-object-style */
import React, { useState, useEffect, useMemo, useCallback } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '@/presentation/components/ui/card'
import { Button } from '@/presentation/components/ui/button'
import { Badge } from '@/presentation/components/ui/badge'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/presentation/components/ui/tabs'
import { EmptyState } from '@/presentation/components/layout/PageLayout'
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/presentation/components/ui/alert-dialog'
import { TenderResultsManager } from '@/presentation/pages/Tenders/components/TenderResultsManager'
import { TenderQuickResults } from '@/presentation/pages/Tenders/components/TenderQuickResults'
import {
  Calendar,
  DollarSign,
  ArrowRight,
  Building2,
  MapPin,
  Eye,
  FileText,
  Paperclip,
  Grid3X3,
  Info,
  Download,
  ExternalLink,
  Clock,
  CheckCircle,
  AlertCircle,
  Send,
  ChevronDown,
  ChevronUp,
} from 'lucide-react'
import { toast } from 'sonner'
import { TenderStatusManager } from '@/presentation/pages/Tenders/components/TenderStatusManager'
import { APP_EVENTS } from '@/events/bus'
import { FileUploadService } from '@/shared/utils/fileUploadService'
// (legacy pricingService import removed â€“ unified hook supplies data)
// Removed pricingDataSyncService (legacy dual-write path)
// Removed normalizeAndEnrich / dedupePricingItems legacy enrichment utilities â€“ unified hook supplies final items
import { safeLocalStorage } from '@/shared/utils/storage/storage'
// Removed direct snapshot utilities & metrics â€“ unified hook manages snapshot reading
// Removed useTenderPricing (legacy hook) â€“ unified hook is now sole source of truth here
import { useUnifiedTenderPricing } from '@/application/hooks/useUnifiedTenderPricing'
import { getStatusColor } from '@/shared/utils/ui/statusColors'
import { getTenderRepository } from '@/application/services/serviceRegistry'
import { useCurrencyFormatter } from '@/application/hooks/useCurrencyFormatter'
// Import extracted tabs
import { GeneralInfoTab, QuantitiesTab, AttachmentsTab, TimelineTab, WorkflowTab } from './TenderDetails/tabs'
/**
 * Phase 1 Pricing Engine Adoption (READ PATH ONLY)
 * ------------------------------------------------
 * This component now supports an engine-based enrichment path guarded by PRICING_FLAGS.USE_ENGINE_DETAILS.
 * Quick rollback: set PRICING_FLAGS.USE_ENGINE_DETAILS = false in pricingHelpers.ts to restore legacy reconstruction.
 * Diff logging: enabled via PRICING_FLAGS.DIFF_LOGGING; threshold configurable (DIFF_THRESHOLD_PERCENT).
 * Removal plan: once diffs remain stable (<0.5%) for a full release cycle, delete legacyReconstruct() and related code.
 */
// legacy normalizePricing utilities removed (buildPricingMap no longer needed after snapshot adoption)

export function TenderDetails({ tender, onBack }: { tender: any; onBack: () => void }) {
  const [activeTab, setActiveTab] = useState('general')
  const [showSubmitDialog, setShowSubmitDialog] = useState(false)
  const [localTender, setLocalTender] = useState(tender)
  // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø­Ø§Ù„Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ snapshot Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© â€“ ÙŠØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¹Ù„Ù‰ useUnifiedTenderPricing
  // Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø·ÙŠ Ù„Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
  const [collapsedSections, setCollapsedSections] = useState<{
    [key: string]: {
      materials: boolean
      labor: boolean
      equipment: boolean
      subcontractors: boolean
    }
  }>({})

  // Ø¯Ø§Ù„Ø© Ù„ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙŠ Ù„Ù‚Ø³Ù… Ù…Ø¹ÙŠÙ† ÙÙŠ Ø¨Ù†Ø¯ Ù…Ø¹ÙŠÙ†
  const toggleCollapse = (
    itemId: string,
    section: 'materials' | 'labor' | 'equipment' | 'subcontractors',
  ) => {
    setCollapsedSections((prev) => ({
      ...prev,
      [itemId]: {
        ...prev[itemId],
        [section]: !prev[itemId]?.[section],
      },
    }))
  }

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± tender
  useEffect(() => {
    setLocalTender(tender)
  }, [tender])

  // Ø£Ø²ÙŠÙ„ Ù…Ø³ØªÙ…Ø¹ pricingSnapshotUpdated (Ø§Ù„Ù€ unified hook ÙŠØ³ØªÙ…Ø¹ Ø¨Ø§Ù„ÙØ¹Ù„ ÙˆÙŠÙØ­Ø¯ÙÙ‘Ø« Ø¨ÙŠØ§Ù†Ø§ØªÙ‡).

  // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø£Ø­Ø¯Ø§Ø« ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© (Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ)
  useEffect(() => {
    if (typeof window === 'undefined') {
      return undefined
    }

    let cancelled = false
    const repository = getTenderRepository()

    const syncTender = async () => {
      try {
        const updated = await repository.getById(tender.id)
        if (!cancelled && updated) {
          setLocalTender(updated)
        }
      } catch (error) {
        if (!cancelled) {
          console.warn('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø¯Ø«:', error)
        }
      }
    }

    void syncTender()

    const handler = () => {
      void syncTender()
    }

    window.addEventListener(APP_EVENTS.TENDER_UPDATED, handler as EventListener)

    return () => {
      cancelled = true
      window.removeEventListener(APP_EVENTS.TENDER_UPDATED, handler as EventListener)
    }
  }, [tender.id])

  // Ø£Ø²ÙŠÙ„ Ù…Ø³Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„/Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ snapshot Ø§Ù„ÙŠØ¯ÙˆÙŠ â€“ Ù…ØµØ¯Ø± Ù…ÙˆØ­Ø¯ ÙÙ‚Ø·.

  // Ø£Ø²ÙŠÙ„ Ù…Ø³ØªÙ…Ø¹ pricingDataUpdated ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ snapshot â€“ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ ØªØ²Ø§Ù…Ù† Ù…Ø±ÙƒØ²ÙŠ Ù„Ø§Ø­Ù‚ (Ø¥Ù† Ù„Ø²Ù…) Ø¹Ø¨Ø± unified hook.

  const unified = useUnifiedTenderPricing(tender)
  const { formatCurrencyValue } = useCurrencyFormatter()
  const quantityFormatter = useMemo(
    () =>
      new Intl.NumberFormat('ar-SA', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2,
      }),
    [],
  )
  const formatQuantity = useCallback(
    (value: number | null | undefined, options?: Intl.NumberFormatOptions) => {
      const numeric = typeof value === 'number' ? value : Number(value ?? 0)
      const safeValue = Number.isFinite(numeric) ? numeric : 0
      if (!options) {
        return quantityFormatter.format(safeValue)
      }
      return new Intl.NumberFormat('ar-SA', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2,
        ...options,
      }).format(safeValue)
    },
    [quantityFormatter],
  )
  // ØªØ´Ø®ÙŠØµ Ù…Ø¨Ø³Ø· Ù„Ù„Ù…ØµØ¯Ø± Ø§Ù„Ù…ÙˆØ­Ø¯ ÙÙ‚Ø·
  useEffect(() => {
    console.log('[TenderDetails] Unified pricing diagnostic', {
      tenderId: tender?.id,
      unifiedStatus: unified.status,
      unifiedSource: unified.source,
      items: unified.items.length,
      hasTotals: !!unified.totals,
    })
  }, [unified.status, unified.source, unified.items.length, unified.totals, tender?.id])

  if (!localTender) return null

  // Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ© ÙˆÙÙ‚ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ
  const isPricingCompleted =
    (localTender?.pricedItems || 0) > 0 &&
    (localTender?.totalItems || 0) > 0 &&
    (localTender?.pricedItems || 0) >= (localTender?.totalItems || 0)
  const isTechnicalFilesUploaded =
    !!localTender?.technicalFilesUploaded ||
    FileUploadService.getFilesByTender(tender.id).length > 0
  const isReadyToSubmit = isPricingCompleted && isTechnicalFilesUploaded

  // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø­ÙˆØ§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ù„ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø¹Ø±Ø¶
  const handleSubmitTender = () => {
    setShowSubmitDialog(true)
  }

  // Ø¯Ø§Ù„Ø© Ù„ØªØ£ÙƒÙŠØ¯ ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø¹Ø±Ø¶
  const handleConfirmSubmit = async () => {
    setShowSubmitDialog(false)

    try {
      const currentTender = localTender ?? tender
      console.log('ğŸš€ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©:', currentTender.id)

      const { tenderSubmissionService } = await import(
        '@/application/services/tenderSubmissionService'
      )
      const result = await tenderSubmissionService.submit(currentTender)

      setLocalTender(result.tender)

      const { created, purchaseOrder, bookletExpense, counts } = result

      console.log('âœ… ØªÙ… Ø§Ø³ØªÙƒÙ…Ø§Ù„ ØªØ¯ÙÙ‚ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', {
        tenderId: result.tender.id,
        purchaseOrderId: purchaseOrder.id,
        bookletExpenseId: bookletExpense?.id ?? null,
        created,
        counts,
      })

      const summary: string[] = []
      if (created.purchaseOrder) {
        summary.push('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø£Ù…Ø± Ø´Ø±Ø§Ø¡ Ù„Ù„Ù…Ù†Ø§ÙØ³Ø©')
      } else if (counts.after.ordersCount > 0) {
        summary.push('Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹')
      }

      if (bookletExpense) {
        const amount = formatCurrencyValue(bookletExpense.amount, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        })
        if (created.bookletExpense) {
          summary.push(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…ØµØ±ÙˆÙ Ø§Ù„ÙƒØ±Ø§Ø³Ø© Ø¨Ù‚ÙŠÙ…Ø© ${amount}`)
        } else {
          summary.push(`Ù…ØµØ±ÙˆÙ Ø§Ù„ÙƒØ±Ø§Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ ${amount}`)
        }
      } else if (created.bookletExpense) {
        summary.push('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ Ø§Ù„ÙƒØ±Ø§Ø³Ø©')
      } else if (counts.after.expensesCount > 0) {
        summary.push('Ù…ØµØ±ÙˆÙ Ø§Ù„ÙƒØ±Ø§Ø³Ø© Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹')
      }

      if (summary.length === 0) {
        summary.push('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­')
      }

      toast.success('ØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ù†Ø¬Ø§Ø­', {
        description: summary.join(' â€¢ '),
      })
    } catch (error) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©:', error)
      toast.error('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø¹Ø±Ø¶')
    }
  }

  // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…ÙØ³Ø¹ÙÙ‘Ø±
  const renderQuantityTable = () => {
    const finalQuantityData = unified.items || []
    const hasPricingData = finalQuantityData.some(
      (it: any) => typeof it.unitPrice === 'number' || typeof it.totalPrice === 'number',
    )
    const sourceLabelMap: Record<string, string> = {
      'central-boq': 'Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ (BOQ)',
      snapshot: 'Ù„Ù‚Ø·Ø© Ø§Ù„ØªØ³Ø¹ÙŠØ± (Snapshot)',
      hook: 'Ù‡ÙˆÙƒ Ø§Ù„ØªØ³Ø¹ÙŠØ±',
      legacy: 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©',
      none: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª',
    }
    console.log(
      '[TenderDetails] Unified hook source',
      unified.source,
      'items',
      finalQuantityData.length,
    )

    return (
      <div className="space-y-4" dir="rtl">
        {unified.status === 'loading' && (
          <div className="p-4 rounded-md bg-muted/40 text-sm text-muted-foreground border">
            Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ³Ø¹ÙŠØ±...
          </div>
        )}
        {unified.status === 'empty' && (
          <EmptyState
            icon={AlertCircle}
            title="Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¹ÙŠØ±"
            description="Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø³Ø¹Ø§Ø± Ù„Ù„Ø¨Ù†ÙˆØ¯ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†. Ù‚Ù… Ø¨Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªØ³Ø¹ÙŠØ± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©."
            actionLabel="ÙØªØ­ ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¹ÙŠØ±"
            onAction={() => window.open(`/pricing/${tender.id}`, '_blank')}
          />
        )}
        {/* divergence UI removed */}
        <div className="flex items-center justify-between">
          <p className="text-sm text-muted-foreground">Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù†ÙˆØ¯: {finalQuantityData.length}</p>
          <div className="flex gap-2 items-center">
            <Badge className="bg-info/10 text-info border-info/30">
              {sourceLabelMap[unified.source]}
            </Badge>
            {hasPricingData && (
              <Badge className="bg-success/10 text-success border-success/30">ÙŠØªØ¶Ù…Ù† Ø£Ø³Ø¹Ø§Ø±</Badge>
            )}
            <Button
              size="sm"
              variant="outline"
              onClick={() => window.open(`/pricing/${tender.id}`, '_blank')}
              className="flex items-center gap-1"
            >
              <ExternalLink className="w-3 h-3" /> ÙØªØ­ ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¹ÙŠØ±
            </Button>
          </div>
        </div>

        {/* Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†ÙØ³ ØªØµÙ…ÙŠÙ… ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ù„Ø®Øµ Ù…Ø¹ Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ */}
        {unified.status !== 'loading' && (
          <div className="overflow-x-auto border rounded-lg">
            <table className="w-full min-w-[1200px] border-collapse">
              <colgroup>
                <col className="w-[8%]" />
                <col className="w-[35%]" />
                <col className="w-[8%]" />
                <col className="w-[8%]" />
                {hasPricingData && (
                  <>
                    <col className="w-[12%]" />
                    <col className="w-[15%]" />
                  </>
                )}
                <col className="w-[8%]" />
                <col className="w-[6%]" />
              </colgroup>
              <thead className="sticky top-0 bg-background z-10">
                <tr className="bg-muted/40 border-b border-border">
                  <th className="border border-border p-2 text-right font-semibold text-sm">
                    Ø±Ù‚Ù… Ø§Ù„Ø¨Ù†Ø¯
                  </th>
                  <th className="border border-border p-2 text-right font-semibold text-sm">
                    ÙˆØµÙ Ø§Ù„Ø¨Ù†Ø¯
                  </th>
                  <th className="border border-border p-2 text-center font-semibold text-sm">
                    Ø§Ù„ÙˆØ­Ø¯Ø©
                  </th>
                  <th className="border border-border p-2 text-center font-semibold text-sm">
                    Ø§Ù„ÙƒÙ…ÙŠØ©
                  </th>
                  {hasPricingData && (
                    <>
                      <th className="border border-border p-2 text-center font-semibold text-sm">
                        Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©
                      </th>
                      <th className="border border-border p-2 text-center font-semibold text-sm">
                        Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©
                      </th>
                    </>
                  )}
                  <th className="border border-border p-2 text-center font-semibold text-sm">
                    Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¹ÙŠØ±
                  </th>
                  <th className="border border-border p-2 text-center font-semibold text-sm">
                    Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
                  </th>
                </tr>
              </thead>
              <tbody>
                {/* Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…ÙƒØ±Ø±Ø©:
                  ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø­Ø§Ù„Ø§Øª ØªØµÙ„Ù†Ø§ Ø¹Ù†Ø§ØµØ± Ø¨Ø¨Ù†ÙØ³ id (Ù…Ø«Ù„Ø§Ù‹ Ù†ØªÙŠØ¬Ø© Ø¯Ù…Ø¬ Ù…ØµØ§Ø¯Ø± Ø£Ùˆ ØªÙƒØ±Ø§Ø± ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ†)
                  Ù…Ù…Ø§ ÙŠÙ†ØªØ¬ Ø¹Ù†Ù‡ ØªØ­Ø°ÙŠØ± React: Encountered two children with the same key
                  Ø§Ù„Ø­Ù„ Ù‡Ù†Ø§: ØªÙˆÙ„ÙŠØ¯ Ù…ÙØªØ§Ø­ Ø¹Ø±Ø¶ renderKey ÙØ±ÙŠØ¯ Ø­ØªÙ‰ Ù„Ùˆ ØªÙƒØ±Ø± id Ø§Ù„Ø£ØµÙ„ÙŠ */}
                {(() => {
                  const keyUsage: Record<string, number> = {}
                  return finalQuantityData.map((item: any, index: number) => {
                    const baseKey = item?.id != null ? String(item.id) : String(index)
                    const occurrence = (keyUsage[baseKey] = (keyUsage[baseKey] || 0) + 1)
                    const renderKey =
                      occurrence === 1 ? baseKey : `${baseKey}__dup${occurrence - 1}`
                    const isCompleted = !!(item.unitPrice && item.totalPrice && item.unitPrice > 0)
                    const isInProgress = !!(item.unitPrice || item.totalPrice) && !isCompleted

                    // ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø­Ù‚Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© ÙÙ‚Ø·

                    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©
                    const finalHasBreakdownData = !!(
                      item.materials?.length > 0 ||
                      item.labor?.length > 0 ||
                      item.equipment?.length > 0 ||
                      item.subcontractors?.length > 0 ||
                      (item.breakdown &&
                        (item.breakdown.materials > 0 ||
                          item.breakdown.labor > 0 ||
                          item.breakdown.equipment > 0 ||
                          item.breakdown.subcontractors > 0 ||
                          item.breakdown.administrative > 0 ||
                          item.breakdown.operational > 0 ||
                          item.breakdown.profit > 0))
                    )

                    console.log(
                      `Item ${item.id || index}: finalHasBreakdownData = ${finalHasBreakdownData}`,
                      {
                        materials: item.materials?.length || 0,
                        labor: item.labor?.length || 0,
                        equipment: item.equipment?.length || 0,
                        subcontractors: item.subcontractors?.length || 0,
                        breakdown: item.breakdown,
                      },
                    )

                    if (occurrence > 1 && occurrence === 2) {
                      console.warn(
                        '[TenderDetails] Duplicate item id detected, generating unique key:',
                        {
                          id: baseKey,
                          renderKey,
                          occurrence,
                        },
                      )
                    }
                    return (
                      <React.Fragment key={renderKey}>
                        <tr
                          className={`hover:bg-muted/40 ${isCompleted ? 'bg-success/10' : isInProgress ? 'bg-warning/10' : 'bg-destructive/10'}`}
                        >
                          <td className="border border-border p-2 font-medium text-right text-sm">
                            {item.itemNumber || item.number || String(index + 1).padStart(2, '0')}
                          </td>
                          <td className="border border-border p-2 text-right">
                            <div>
                              {/* Ø§Ù„ÙˆØµÙ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ */}
                              <div className="font-medium text-sm whitespace-pre-line leading-relaxed">
                                {item.canonicalDescription ||
                                  item.description ||
                                  item.desc ||
                                  item.name ||
                                  item.title ||
                                  item.itemName ||
                                  item.specifications ||
                                  'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                              </div>
                              {/* Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆØµÙ Ø§Ù„Ø£ØµÙ„ÙŠ Ù…Ø®ØªÙ„ÙØ§Ù‹ Ø¹Ù† Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ ÙˆØ£Ø·ÙˆÙ„/Ø£Ù‚ØµØ± Ù†Ø¹Ø±Ø¶Ù‡ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© */}
                              {item.canonicalDescription &&
                                item.description &&
                                item.canonicalDescription !== item.description && (
                                  <div className="text-xs text-muted-foreground mt-1">
                                    <span className="font-semibold">Ø§Ù„ÙˆØµÙ Ø§Ù„Ø£ØµÙ„ÙŠ:</span>{' '}
                                    {item.description}
                                  </div>
                                )}
                              {/* Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ù…Ù† Ù…ØµØ§Ø¯Ø± Ù…ØªØ¹Ø¯Ø¯Ø© */}
                              {(item.specifications ||
                                item.spec ||
                                item.notes ||
                                item.technicalNotes) && (
                                <div className="text-xs text-muted-foreground mt-1 leading-relaxed whitespace-pre-line">
                                  {item.specifications ||
                                    item.spec ||
                                    item.notes ||
                                    item.technicalNotes}
                                </div>
                              )}
                              {/* ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ */}
                              {item.detailedDescription && (
                                <div className="text-xs text-info mt-1 italic whitespace-pre-line">
                                  {item.detailedDescription}
                                </div>
                              )}
                            </div>
                          </td>
                          <td className="border border-border p-2 text-center font-medium text-sm">
                            {item.unit || item.uom || '-'}
                          </td>
                          <td className="border border-border p-2 text-center font-bold text-sm">
                            {item.quantity !== undefined && item.quantity !== null
                              ? formatQuantity(item.quantity)
                              : '-'}
                          </td>
                          {hasPricingData && (
                            <>
                              <td className="border border-border p-2 text-center">
                                {isCompleted || isInProgress ? (
                                  <span className="font-bold text-info text-sm">
                                    {formatCurrencyValue(item.unitPrice, {
                                      minimumFractionDigits: 2,
                                      maximumFractionDigits: 2,
                                    })}
                                  </span>
                                ) : (
                                  <span className="text-muted-foreground text-sm opacity-80">
                                    -
                                  </span>
                                )}
                              </td>
                              <td className="border border-border p-2 text-center">
                                {isCompleted || isInProgress ? (
                                  <span className="font-bold text-success text-sm">
                                    {formatCurrencyValue(item.totalPrice, {
                                      minimumFractionDigits: 0,
                                      maximumFractionDigits: 0,
                                    })}
                                  </span>
                                ) : (
                                  <span className="text-muted-foreground text-sm opacity-80">
                                    -
                                  </span>
                                )}
                              </td>
                            </>
                          )}
                          <td className="border border-border p-2 text-center">
                            {isCompleted ? (
                              <Badge className="bg-success/10 text-success border-success/30 text-xs">
                                <CheckCircle className="w-3 h-3 ml-1" />
                                ØªÙ… Ø§Ù„ØªØ³Ø¹ÙŠØ±
                              </Badge>
                            ) : isInProgress ? (
                              <Badge className="bg-warning/10 text-warning border-warning/30 text-xs">
                                Ù‚ÙŠØ¯ Ø§Ù„ØªØ³Ø¹ÙŠØ±
                              </Badge>
                            ) : (
                              <Badge className="bg-destructive/10 text-destructive border-destructive/30 text-xs">
                                <AlertCircle className="w-3 h-3 ml-1" />
                                Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ³Ø¹ÙŠØ±
                              </Badge>
                            )}
                          </td>
                          <td className="border border-border p-2 text-center">
                            <Button
                              size="sm"
                              variant="outline"
                              onClick={() => {
                                try {
                                  // ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„ÙŠØªÙ… Ø§Ù„ØªÙ‚Ø§Ø·Ù‡ ÙÙŠ ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¹ÙŠØ±
                                  safeLocalStorage.setItem('pricing:selectedItemId', item.id)
                                  // Ø¨Ø« Ø­Ø¯Ø« Ù…Ø®ØµØµ Ù„ÙƒÙŠ ØªØºÙŠÙ‘Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø·Ø§Ø¡Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ø¥Ù„Ù‰ ÙˆØ¶Ø¹ Ø§Ù„ØªØ³Ø¹ÙŠØ±
                                  const evt = new CustomEvent('openPricingForTender', {
                                    detail: { tenderId: tender.id, itemId: item.id },
                                  })
                                  window.dispatchEvent(evt)
                                  toast.info('ÙØªØ­ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ³Ø¹ÙŠØ± Ù„Ù„Ø¨Ù†Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯', { duration: 2500 })
                                } catch (e) {
                                  console.error('ÙØ´Ù„ ØªÙØ¹ÙŠÙ„ Ù…Ø³Ø§Ø± Ø§Ù„ØªØ­Ø±ÙŠØ±', e)
                                  alert('ØªØ¹Ø°Ø± ÙØªØ­ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ³Ø¹ÙŠØ±ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹')
                                }
                              }}
                              className="flex items-center gap-1 text-xs"
                            >
                              <ExternalLink className="w-3 h-3" />
                              {isCompleted || isInProgress ? 'ØªØ¹Ø¯ÙŠÙ„' : 'ØªØ³Ø¹ÙŠØ±'}
                            </Button>
                          </td>
                        </tr>

                        {/* Ø¬Ø¯Ø§ÙˆÙ„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙƒÙ„ÙØ© ØªØ­Øª ÙƒÙ„ Ø¨Ù†Ø¯ - Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ù„Ø®Øµ */}
                        {finalHasBreakdownData && (
                          <tr className="bg-card">
                            <td colSpan={hasPricingData ? 8 : 6} className="p-2 border-b">
                              <div className="space-y-2">
                                {/* Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø© */}
                                {!item.materials?.length &&
                                  !item.labor?.length &&
                                  !item.equipment?.length &&
                                  !item.subcontractors?.length &&
                                  item.breakdown && (
                                    <div className="bg-muted/40 p-3 rounded-lg border border-border">
                                      <div className="text-xs font-semibold text-foreground mb-3 flex items-center gap-2">
                                        <div className="w-2 h-2 bg-info rounded-full"></div>
                                        Ù…Ù„Ø®Øµ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙƒÙ„ÙØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯
                                      </div>

                                      {/* Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */}
                                      <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs mb-3">
                                        {item.breakdown.materials > 0 && (
                                          <div className="bg-info/10 p-2 rounded border border-info/30">
                                            <div className="text-info text-xs mb-1">Ø§Ù„Ù…ÙˆØ§Ø¯</div>
                                            <div className="font-bold text-info">
                                              {formatCurrencyValue(item.breakdown.materials, {
                                                maximumFractionDigits: 0,
                                              })}
                                            </div>
                                          </div>
                                        )}
                                        {item.breakdown.labor > 0 && (
                                          <div className="bg-success/10 p-2 rounded border border-success/30">
                                            <div className="text-success text-xs mb-1">Ø§Ù„Ø¹Ù…Ø§Ù„Ø©</div>
                                            <div className="font-bold text-success">
                                              {formatCurrencyValue(item.breakdown.labor, {
                                                maximumFractionDigits: 0,
                                              })}
                                            </div>
                                          </div>
                                        )}
                                        {item.breakdown.equipment > 0 && (
                                          <div className="bg-warning/10 p-2 rounded border border-warning/30">
                                            <div className="text-warning text-xs mb-1">Ø§Ù„Ù…Ø¹Ø¯Ø§Øª</div>
                                            <div className="font-bold text-warning">
                                              {formatCurrencyValue(item.breakdown.equipment, {
                                                maximumFractionDigits: 0,
                                              })}
                                            </div>
                                          </div>
                                        )}
                                        {item.breakdown.subcontractors > 0 && (
                                          <div className="bg-accent/10 p-2 rounded border border-accent/30">
                                            <div className="text-accent text-xs mb-1">
                                              Ù…Ù‚Ø§ÙˆÙ„Ùˆ Ø§Ù„Ø¨Ø§Ø·Ù†
                                            </div>
                                            <div className="font-bold text-accent">
                                              {formatCurrencyValue(item.breakdown.subcontractors, {
                                                maximumFractionDigits: 0,
                                              })}
                                            </div>
                                          </div>
                                        )}
                                      </div>

                                      {/* Ø§Ù„Ù†Ø³Ø¨ ÙˆØ§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© */}
                                      <div className="grid grid-cols-1 md:grid-cols-3 gap-2 text-xs pt-2 border-t border-border">
                                        {item.breakdown.administrative > 0 && (
                                          <div className="bg-destructive/10 p-2 rounded border border-destructive/30">
                                            <div className="text-destructive text-xs mb-1">
                                              ØªÙƒØ§Ù„ÙŠÙ Ø¥Ø¯Ø§Ø±ÙŠØ©
                                            </div>
                                            <div className="font-bold text-destructive">
                                              {formatCurrencyValue(item.breakdown.administrative, {
                                                maximumFractionDigits: 0,
                                              })}
                                            </div>
                                          </div>
                                        )}
                                        {item.breakdown.operational > 0 && (
                                          <div className="bg-warning/10 p-2 rounded border border-warning/30">
                                            <div className="text-warning text-xs mb-1">
                                              ØªÙƒØ§Ù„ÙŠÙ ØªØ´ØºÙŠÙ„ÙŠØ©
                                            </div>
                                            <div className="font-bold text-warning">
                                              {formatCurrencyValue(item.breakdown.operational, {
                                                maximumFractionDigits: 0,
                                              })}
                                            </div>
                                          </div>
                                        )}
                                        {item.breakdown.profit > 0 && (
                                          <div className="bg-success/10 p-2 rounded border border-success/30">
                                            <div className="text-success text-xs mb-1">
                                              Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­
                                            </div>
                                            <div className="font-bold text-success">
                                              {formatCurrencyValue(item.breakdown.profit, {
                                                maximumFractionDigits: 0,
                                              })}
                                            </div>
                                          </div>
                                        )}
                                      </div>

                                      {/* Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù†Ø¯ */}
                                      <div className="mt-3 pt-2 border-t border-border/60">
                                        <div className="bg-muted p-2 rounded flex justify-between items-center">
                                          <span className="text-foreground font-semibold text-sm">
                                            Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù†Ø¯:
                                          </span>
                                          <span className="font-bold text-foreground text-sm">
                                            {formatCurrencyValue(
                                              (item.breakdown.materials || 0) +
                                                (item.breakdown.labor || 0) +
                                                (item.breakdown.equipment || 0) +
                                                (item.breakdown.subcontractors || 0) +
                                                (item.breakdown.administrative || 0) +
                                                (item.breakdown.operational || 0) +
                                                (item.breakdown.profit || 0),
                                              { maximumFractionDigits: 0 },
                                            )}
                                          </span>
                                        </div>
                                      </div>
                                    </div>
                                  )}

                                {/* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ */}
                                {item.materials?.length ? (
                                  <div>
                                    <div
                                      className="flex items-center justify-between cursor-pointer hover:bg-info/10 p-2 rounded-md border border-info/30"
                                      onClick={() =>
                                        toggleCollapse(item.id || index.toString(), 'materials')
                                      }
                                    >
                                      <div className="flex items-center gap-3">
                                        <div className="w-3 h-3 bg-info rounded-full"></div>
                                        <div className="text-sm font-semibold text-info">
                                          Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø®Ø§Ù…Ø§Øª ({item.materials.length} ØµÙ†Ù)
                                        </div>
                                        <Badge
                                          variant="outline"
                                          className="text-info border-info/30 text-xs bg-info/10"
                                        >
                                          Ø¥Ø¬Ù…Ø§Ù„ÙŠ:{' '}
                                          {formatCurrencyValue(
                                            item.materials.reduce(
                                              (sum: number, m: any) => sum + (m.total || 0),
                                              0,
                                            ),
                                            { maximumFractionDigits: 0 },
                                          )}
                                        </Badge>
                                      </div>
                                      {collapsedSections[item.id || index.toString()]?.materials ? (
                                        <ChevronUp className="w-5 h-5 text-info" />
                                      ) : (
                                        <ChevronDown className="w-5 h-5 text-info" />
                                      )}
                                    </div>
                                    {!collapsedSections[item.id || index.toString()]?.materials && (
                                      <div className="mt-2 overflow-x-auto border rounded-lg shadow-sm">
                                        <table className="w-full text-xs bg-card">
                                          <colgroup>
                                            <col className="w-[40%]" />
                                            <col className="w-[10%]" />
                                            <col className="w-[12%]" />
                                            <col className="w-[15%]" />
                                            <col className="w-[15%]" />
                                            <col className="w-[8%]" />
                                          </colgroup>
                                          <thead>
                                            <tr className="text-foreground bg-info/20 border-b-2 border-info/30">
                                              <th className="text-right p-2 font-semibold">
                                                Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© / Ø§Ù„ÙˆØµÙ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ
                                              </th>
                                              <th className="text-center p-2 font-semibold">
                                                Ø§Ù„ÙˆØ­Ø¯Ø©
                                              </th>
                                              <th className="text-center p-2 font-semibold">
                                                Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
                                              </th>
                                              <th className="text-center p-2 font-semibold">
                                                Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© (Ø±.Ø³)
                                              </th>
                                              <th className="text-center p-2 font-semibold">
                                                Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø±.Ø³)
                                              </th>
                                              <th className="text-center p-2 font-semibold">
                                                Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                                              </th>
                                            </tr>
                                          </thead>
                                          <tbody>
                                            {item.materials.map((m: any, mIndex: number) => (
                                              <tr
                                                key={m.id || mIndex}
                                                className="odd:bg-card even:bg-muted/40 hover:bg-info/10 border-b border-border"
                                              >
                                                <td className="p-2 text-right">
                                                  <div className="font-medium text-foreground">
                                                    {m.name || m.description || 'Ù…Ø§Ø¯Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©'}
                                                  </div>
                                                  {m.specifications && (
                                                    <div className="text-xs text-muted-foreground mt-1">
                                                      {m.specifications}
                                                    </div>
                                                  )}
                                                  {m.brand && (
                                                    <div className="text-xs text-info mt-1">
                                                      Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©: {m.brand}
                                                    </div>
                                                  )}
                                                </td>
                                                <td className="p-2 text-center font-medium">
                                                  {m.unit || m.uom || '-'}
                                                </td>
                                                <td className="p-2 text-center font-bold text-info">
                                                  {typeof m.quantity === 'number'
                                                    ? formatQuantity(m.quantity, {
                                                        maximumFractionDigits: 2,
                                                      })
                                                    : m.quantity || '-'}
                                                </td>
                                                <td className="p-2 text-center font-medium text-success">
                                                  {m.price !== undefined &&
                                                  m.price !== null &&
                                                  m.price !== ''
                                                    ? formatCurrencyValue(m.price, {
                                                        minimumFractionDigits: 2,
                                                        maximumFractionDigits: 2,
                                                      })
                                                    : '-'}
                                                </td>
                                                <td className="p-2 text-center font-bold text-success bg-success/10">
                                                  {m.total !== undefined &&
                                                  m.total !== null &&
                                                  m.total !== ''
                                                    ? formatCurrencyValue(m.total, {
                                                        minimumFractionDigits: 2,
                                                        maximumFractionDigits: 2,
                                                      })
                                                    : '-'}
                                                </td>
                                                <td className="p-2 text-center text-xs text-muted-foreground">
                                                  {m.notes || m.remarks || '-'}
                                                </td>
                                              </tr>
                                            ))}
                                            <tr className="bg-info/20 border-t-2 border-info/30 font-bold">
                                              <td colSpan={4} className="p-2 text-right text-info">
                                                Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯:
                                              </td>
                                              <td className="p-2 text-center text-info bg-info/10">
                                                {formatCurrencyValue(
                                                  item.materials.reduce(
                                                    (sum: number, m: any) => sum + (m.total || 0),
                                                    0,
                                                  ),
                                                  {
                                                    minimumFractionDigits: 2,
                                                    maximumFractionDigits: 2,
                                                  },
                                                )}
                                              </td>
                                              <td className="p-2"></td>
                                            </tr>
                                          </tbody>
                                        </table>
                                      </div>
                                    )}
                                  </div>
                                ) : null}

                                {/* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ø§Ù„Ø© */}
                                {item.labor?.length ? (
                                  <div>
                                    <div
                                      className="flex items-center justify-between cursor-pointer hover:bg-success/10 p-2 rounded-md border border-success/30"
                                      onClick={() =>
                                        toggleCollapse(item.id || index.toString(), 'labor')
                                      }
                                    >
                                      <div className="flex items-center gap-3">
                                        <div className="w-3 h-3 bg-success rounded-full"></div>
                                        <div className="text-sm font-semibold text-success">
                                          Ø§Ù„Ø¹Ù…Ø§Ù„Ø© ÙˆØ§Ù„Ø£ÙŠØ¯ÙŠ Ø§Ù„Ø¹Ø§Ù…Ù„Ø© ({item.labor.length} Ù†ÙˆØ¹)
                                        </div>
                                        <Badge
                                          variant="outline"
                                          className="text-success border-success/30 text-xs bg-success/10"
                                        >
                                          Ø¥Ø¬Ù…Ø§Ù„ÙŠ:{' '}
                                          {formatCurrencyValue(
                                            item.labor.reduce(
                                              (sum: number, l: any) => sum + (l.total || 0),
                                              0,
                                            ),
                                            { maximumFractionDigits: 0 },
                                          )}
                                        </Badge>
                                      </div>
                                      {collapsedSections[item.id || index.toString()]?.labor ? (
                                        <ChevronUp className="w-5 h-5 text-success" />
                                      ) : (
                                        <ChevronDown className="w-5 h-5 text-success" />
                                      )}
                                    </div>
                                    {!collapsedSections[item.id || index.toString()]?.labor && (
                                      <div className="mt-2 overflow-x-auto border rounded-lg shadow-sm">
                                        <table className="w-full text-xs bg-card">
                                          <colgroup>
                                            <col className="w-[40%]" />
                                            <col className="w-[10%]" />
                                            <col className="w-[12%]" />
                                            <col className="w-[15%]" />
                                            <col className="w-[15%]" />
                                            <col className="w-[8%]" />
                                          </colgroup>
                                          <thead>
                                            <tr className="text-foreground bg-success/20 border-b-2 border-success/30">
                                              <th className="text-right p-2 font-semibold">
                                                Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ø§Ù„Ø© / Ø§Ù„ØªØ®ØµØµ
                                              </th>
                                              <th className="text-center p-2 font-semibold">
                                                Ø§Ù„ÙˆØ­Ø¯Ø©
                                              </th>
                                              <th className="text-center p-2 font-semibold">
                                                Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª/Ø§Ù„Ø£ÙŠØ§Ù…
                                              </th>
                                              <th className="text-center p-2 font-semibold">
                                                Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø£Ø¬Ø± (Ø±.Ø³)
                                              </th>
                                              <th className="text-center p-2 font-semibold">
                                                Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø±.Ø³)
                                              </th>
                                              <th className="text-center p-2 font-semibold">
                                                Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                                              </th>
                                            </tr>
                                          </thead>
                                          <tbody>
                                            {item.labor.map((l: any, lIndex: number) => (
                                              <tr
                                                key={l.id || lIndex}
                                                className="odd:bg-card even:bg-muted/40 hover:bg-success/10 border-b border-border"
                                              >
                                                <td className="p-2 text-right">
                                                  <div className="font-medium text-foreground">
                                                    {l.description || l.type || 'Ø¹Ù…Ø§Ù„Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©'}
                                                  </div>
                                                  {l.skill && (
                                                    <div className="text-xs text-muted-foreground mt-1">
                                                      Ø§Ù„Ù…Ù‡Ø§Ø±Ø©: {l.skill}
                                                    </div>
                                                  )}
                                                  {l.experience && (
                                                    <div className="text-xs text-success mt-1">
                                                      Ø§Ù„Ø®Ø¨Ø±Ø©: {l.experience}
                                                    </div>
                                                  )}
                                                </td>
                                                <td className="p-2 text-center font-medium">
                                                  {l.unit || l.uom || 'Ø³Ø§Ø¹Ø©'}
                                                </td>
                                                <td className="p-2 text-center font-bold text-success">
                                                  {typeof l.quantity === 'number'
                                                    ? formatQuantity(l.quantity, {
                                                        maximumFractionDigits: 1,
                                                      })
                                                    : l.quantity || '-'}
                                                </td>
                                                <td className="p-2 text-center font-medium text-success">
                                                  {l.price !== undefined &&
                                                  l.price !== null &&
                                                  l.price !== ''
                                                    ? formatCurrencyValue(l.price, {
                                                        minimumFractionDigits: 2,
                                                        maximumFractionDigits: 2,
                                                      })
                                                    : '-'}
                                                </td>
                                                <td className="p-2 text-center font-bold text-success bg-success/10">
                                                  {l.total !== undefined &&
                                                  l.total !== null &&
                                                  l.total !== ''
                                                    ? formatCurrencyValue(l.total, {
                                                        minimumFractionDigits: 2,
                                                        maximumFractionDigits: 2,
                                                      })
                                                    : '-'}
                                                </td>
                                                <td className="p-2 text-center text-xs text-muted-foreground">
                                                  {l.notes || l.remarks || '-'}
                                                </td>
                                              </tr>
                                            ))}
                                            <tr className="bg-success/20 border-t-2 border-success/40 font-bold">
                                              <td
                                                colSpan={4}
                                                className="p-2 text-right text-success"
                                              >
                                                Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù…Ø§Ù„Ø©:
                                              </td>
                                              <td className="p-2 text-center text-success bg-success/10">
                                                {formatCurrencyValue(
                                                  item.labor.reduce(
                                                    (sum: number, l: any) => sum + (l.total || 0),
                                                    0,
                                                  ),
                                                  {
                                                    minimumFractionDigits: 2,
                                                    maximumFractionDigits: 2,
                                                  },
                                                )}
                                              </td>
                                              <td className="p-2"></td>
                                            </tr>
                                          </tbody>
                                        </table>
                                      </div>
                                    )}
                                  </div>
                                ) : null}

                                {/* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª */}
                                {item.equipment?.length ? (
                                  <div>
                                    <div
                                      className="flex items-center justify-between cursor-pointer hover:bg-warning/10 p-2 rounded-md border border-warning/30"
                                      onClick={() =>
                                        toggleCollapse(item.id || index.toString(), 'equipment')
                                      }
                                    >
                                      <div className="flex items-center gap-3">
                                        <div className="w-3 h-3 bg-warning rounded-full"></div>
                                        <div className="text-sm font-semibold text-warning">
                                          Ø§Ù„Ù…Ø¹Ø¯Ø§Øª ÙˆØ§Ù„Ø¢Ù„Ø§Øª ({item.equipment.length} Ù…Ø¹Ø¯Ø©)
                                        </div>
                                        <Badge
                                          variant="outline"
                                          className="text-warning border-warning/30 text-xs bg-warning/10"
                                        >
                                          Ø¥Ø¬Ù…Ø§Ù„ÙŠ:{' '}
                                          {formatCurrencyValue(
                                            item.equipment.reduce(
                                              (sum: number, e: any) => sum + (e.total || 0),
                                              0,
                                            ),
                                            { maximumFractionDigits: 0 },
                                          )}
                                        </Badge>
                                      </div>
                                      {collapsedSections[item.id || index.toString()]?.equipment ? (
                                        <ChevronUp className="w-5 h-5 text-warning" />
                                      ) : (
                                        <ChevronDown className="w-5 h-5 text-warning" />
                                      )}
                                    </div>
                                    {!collapsedSections[item.id || index.toString()]?.equipment && (
                                      <div className="mt-2 overflow-x-auto border rounded-lg shadow-sm">
                                        <table className="w-full text-xs bg-card">
                                          <colgroup>
                                            <col className="w-[40%]" />
                                            <col className="w-[10%]" />
                                            <col className="w-[12%]" />
                                            <col className="w-[15%]" />
                                            <col className="w-[15%]" />
                                            <col className="w-[8%]" />
                                          </colgroup>
                                          <thead>
                                            <tr className="text-foreground bg-warning/20 border-b-2 border-warning/30">
                                              <th className="text-right p-2 font-semibold">
                                                Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø¯Ø© / Ø§Ù„ÙˆØµÙ Ø§Ù„ØªÙ‚Ù†ÙŠ
                                              </th>
                                              <th className="text-center p-2 font-semibold">
                                                Ø§Ù„ÙˆØ­Ø¯Ø©
                                              </th>
                                              <th className="text-center p-2 font-semibold">
                                                Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª/Ø§Ù„Ø£ÙŠØ§Ù…
                                              </th>
                                              <th className="text-center p-2 font-semibold">
                                                ØªÙƒÙ„ÙØ© Ø§Ù„Ø³Ø§Ø¹Ø© (Ø±.Ø³)
                                              </th>
                                              <th className="text-center p-2 font-semibold">
                                                Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø±.Ø³)
                                              </th>
                                              <th className="text-center p-2 font-semibold">
                                                Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                                              </th>
                                            </tr>
                                          </thead>
                                          <tbody>
                                            {item.equipment.map((e: any, eIndex: number) => (
                                              <tr
                                                key={e.id || eIndex}
                                                className="odd:bg-card even:bg-muted/40 hover:bg-warning/10 border-b border-border"
                                              >
                                                <td className="p-2 text-right">
                                                  <div className="font-medium text-foreground">
                                                    {e.description || e.name || 'Ù…Ø¹Ø¯Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©'}
                                                  </div>
                                                  {e.model && (
                                                    <div className="text-xs text-muted-foreground mt-1">
                                                      Ø§Ù„Ø·Ø±Ø§Ø²: {e.model}
                                                    </div>
                                                  )}
                                                  {e.capacity && (
                                                    <div className="text-xs text-warning mt-1">
                                                      Ø§Ù„Ø³Ø¹Ø©: {e.capacity}
                                                    </div>
                                                  )}
                                                </td>
                                                <td className="p-2 text-center font-medium">
                                                  {e.unit || e.uom || 'Ø³Ø§Ø¹Ø©'}
                                                </td>
                                                <td className="p-2 text-center font-bold text-warning">
                                                  {typeof e.quantity === 'number'
                                                    ? formatQuantity(e.quantity, {
                                                        maximumFractionDigits: 1,
                                                      })
                                                    : e.quantity || '-'}
                                                </td>
                                                <td className="p-2 text-center font-medium text-success">
                                                  {e.price !== undefined &&
                                                  e.price !== null &&
                                                  e.price !== ''
                                                    ? formatCurrencyValue(e.price, {
                                                        minimumFractionDigits: 2,
                                                        maximumFractionDigits: 2,
                                                      })
                                                    : '-'}
                                                </td>
                                                <td className="p-2 text-center font-bold text-success bg-success/10">
                                                  {e.total !== undefined &&
                                                  e.total !== null &&
                                                  e.total !== ''
                                                    ? formatCurrencyValue(e.total, {
                                                        minimumFractionDigits: 2,
                                                        maximumFractionDigits: 2,
                                                      })
                                                    : '-'}
                                                </td>
                                                <td className="p-2 text-center text-xs text-muted-foreground">
                                                  {e.notes || e.remarks || '-'}
                                                </td>
                                              </tr>
                                            ))}
                                            <tr className="bg-warning/20 border-t-2 border-warning/40 font-bold">
                                              <td
                                                colSpan={4}
                                                className="p-2 text-right text-warning"
                                              >
                                                Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª:
                                              </td>
                                              <td className="p-2 text-center text-warning bg-warning/10">
                                                {formatCurrencyValue(
                                                  item.equipment.reduce(
                                                    (sum: number, e: any) => sum + (e.total || 0),
                                                    0,
                                                  ),
                                                  {
                                                    minimumFractionDigits: 2,
                                                    maximumFractionDigits: 2,
                                                  },
                                                )}
                                              </td>
                                              <td className="p-2"></td>
                                            </tr>
                                          </tbody>
                                        </table>
                                      </div>
                                    )}
                                  </div>
                                ) : null}

                                {/* Ø¬Ø¯ÙˆÙ„ Ù…Ù‚Ø§ÙˆÙ„Ùˆ Ø§Ù„Ø¨Ø§Ø·Ù† */}
                                {item.subcontractors?.length ? (
                                  <div>
                                    <div
                                      className="flex items-center justify-between cursor-pointer hover:bg-accent/10 p-2 rounded-md border border-accent/30"
                                      onClick={() =>
                                        toggleCollapse(
                                          item.id || index.toString(),
                                          'subcontractors',
                                        )
                                      }
                                    >
                                      <div className="flex items-center gap-3">
                                        <div className="w-3 h-3 bg-accent rounded-full"></div>
                                        <div className="text-sm font-semibold text-accent">
                                          Ù…Ù‚Ø§ÙˆÙ„Ùˆ Ø§Ù„Ø¨Ø§Ø·Ù† ÙˆØ§Ù„Ù…ØªØ®ØµØµÙˆÙ† ({item.subcontractors.length}{' '}
                                          Ù…Ù‚Ø§ÙˆÙ„)
                                        </div>
                                        <Badge
                                          variant="outline"
                                          className="text-accent border-accent/30 text-xs bg-accent/10"
                                        >
                                          Ø¥Ø¬Ù…Ø§Ù„ÙŠ:{' '}
                                          {formatCurrencyValue(
                                            item.subcontractors.reduce(
                                              (sum: number, s: any) => sum + (s.total || 0),
                                              0,
                                            ),
                                            { maximumFractionDigits: 0 },
                                          )}
                                        </Badge>
                                      </div>
                                      {collapsedSections[item.id || index.toString()]
                                        ?.subcontractors ? (
                                        <ChevronUp className="w-5 h-5 text-accent" />
                                      ) : (
                                        <ChevronDown className="w-5 h-5 text-accent" />
                                      )}
                                    </div>
                                    {!collapsedSections[item.id || index.toString()]
                                      ?.subcontractors && (
                                      <div className="mt-2 overflow-x-auto border rounded-lg shadow-sm">
                                        <table className="w-full text-xs bg-card">
                                          <colgroup>
                                            <col className="w-[40%]" />
                                            <col className="w-[10%]" />
                                            <col className="w-[12%]" />
                                            <col className="w-[15%]" />
                                            <col className="w-[15%]" />
                                            <col className="w-[8%]" />
                                          </colgroup>
                                          <thead>
                                            <tr className="text-foreground bg-accent/20 border-b-2 border-accent/30">
                                              <th className="text-right p-2 font-semibold">
                                                Ø§Ø³Ù… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ / Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©
                                              </th>
                                              <th className="text-center p-2 font-semibold">
                                                Ø§Ù„ÙˆØ­Ø¯Ø©
                                              </th>
                                              <th className="text-center p-2 font-semibold">
                                                Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
                                              </th>
                                              <th className="text-center p-2 font-semibold">
                                                Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© (Ø±.Ø³)
                                              </th>
                                              <th className="text-center p-2 font-semibold">
                                                Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø±.Ø³)
                                              </th>
                                              <th className="text-center p-2 font-semibold">
                                                Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                                              </th>
                                            </tr>
                                          </thead>
                                          <tbody>
                                            {item.subcontractors.map((s: any, sIndex: number) => (
                                              <tr
                                                key={s.id || sIndex}
                                                className="odd:bg-card even:bg-muted/40 hover:bg-accent/10 border-b border-border"
                                              >
                                                <td className="p-2 text-right">
                                                  <div className="font-medium text-foreground">
                                                    {s.description ||
                                                      s.name ||
                                                      s.contractor ||
                                                      'Ù…Ù‚Ø§ÙˆÙ„ ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                                                  </div>
                                                  {s.specialty && (
                                                    <div className="text-xs text-muted-foreground mt-1">
                                                      Ø§Ù„ØªØ®ØµØµ: {s.specialty}
                                                    </div>
                                                  )}
                                                  {s.company && (
                                                    <div className="text-xs text-accent mt-1">
                                                      Ø§Ù„Ø´Ø±ÙƒØ©: {s.company}
                                                    </div>
                                                  )}
                                                </td>
                                                <td className="p-2 text-center font-medium">
                                                  {s.unit || s.uom || 'Ù…Ù‚Ø·ÙˆØ¹ÙŠØ©'}
                                                </td>
                                                <td className="p-2 text-center font-bold text-accent">
                                                  {typeof s.quantity === 'number'
                                                    ? formatQuantity(s.quantity, {
                                                        maximumFractionDigits: 2,
                                                      })
                                                    : s.quantity || '-'}
                                                </td>
                                                <td className="p-2 text-center font-medium text-success">
                                                  {s.price !== undefined &&
                                                  s.price !== null &&
                                                  s.price !== ''
                                                    ? formatCurrencyValue(s.price, {
                                                        minimumFractionDigits: 2,
                                                        maximumFractionDigits: 2,
                                                      })
                                                    : '-'}
                                                </td>
                                                <td className="p-2 text-center font-bold text-success bg-success/10">
                                                  {s.total !== undefined &&
                                                  s.total !== null &&
                                                  s.total !== ''
                                                    ? formatCurrencyValue(s.total, {
                                                        minimumFractionDigits: 2,
                                                        maximumFractionDigits: 2,
                                                      })
                                                    : '-'}
                                                </td>
                                                <td className="p-2 text-center text-xs text-muted-foreground">
                                                  {s.notes || s.remarks || '-'}
                                                </td>
                                              </tr>
                                            ))}
                                            <tr className="bg-accent/20 border-t-2 border-accent/40 font-bold">
                                              <td
                                                colSpan={4}
                                                className="p-2 text-right text-accent"
                                              >
                                                Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ù…Ù‚Ø§ÙˆÙ„ÙŠ Ø§Ù„Ø¨Ø§Ø·Ù†:
                                              </td>
                                              <td className="p-2 text-center text-accent bg-accent/10">
                                                {formatCurrencyValue(
                                                  item.subcontractors.reduce(
                                                    (sum: number, s: any) => sum + (s.total || 0),
                                                    0,
                                                  ),
                                                  {
                                                    minimumFractionDigits: 2,
                                                    maximumFractionDigits: 2,
                                                  },
                                                )}
                                              </td>
                                              <td className="p-2"></td>
                                            </tr>
                                          </tbody>
                                        </table>
                                      </div>
                                    )}
                                  </div>
                                ) : null}
                              </div>
                            </td>
                          </tr>
                        )}
                      </React.Fragment>
                    )
                  })
                })()}
              </tbody>
              {hasPricingData && unified?.totals && (
                <tfoot>
                  <tr className="bg-muted font-bold">
                    <td
                      colSpan={hasPricingData ? 6 : 4}
                      className="border border-border p-2 text-right text-sm"
                    >
                      Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù… (Ù…Ù† ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¹ÙŠØ±):
                    </td>
                    <td className="border border-border p-2 text-center text-success text-sm font-bold">
                      {formatCurrencyValue(unified.totals.totalValue ?? 0, {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0,
                      })}
                    </td>
                    <td className="border border-border p-2"></td>
                    <td className="border border-border p-2"></td>
                  </tr>
                </tfoot>
              )}
            </table>
          </div>
        )}

        <div className="text-sm text-muted-foreground text-center mt-4">
          Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù†ÙˆØ¯: {finalQuantityData.length} â€¢ Ø§Ù„Ù…ØµØ¯Ø±: {sourceLabelMap[unified.source]}
        </div>
      </div>
    )
  }

  // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
  const renderAttachments = () => {
    // 1. Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©
    const originalAttachments = tender.attachments || []

    // 2. Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙÙ†ÙŠØ© Ù…Ù† Ø®Ø¯Ù…Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª (Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙÙ†ÙŠ)
    let technicalFiles: any[] = []

    try {
      technicalFiles = FileUploadService.getFilesByTender(tender.id).map((file) => ({
        ...file,
        source: 'technical',
        type: 'technical',
      })) as any[]
    } catch (error) {
      console.log('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙÙ†ÙŠØ©:', error)
    }

    console.log('Checking for attachments for tender:', tender.id)
    console.log('Original attachments:', originalAttachments)
    console.log('Technical files found:', technicalFiles)

    // 3. Ø¯Ù…Ø¬ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù…Ø¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙÙ†ÙŠØ©
    const allAttachments = [...originalAttachments, ...technicalFiles]

    console.log('All attachments (original + technical):', allAttachments)

    // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§ØªØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø¹Ø±Ø¶
    if (allAttachments.length === 0) {
      allAttachments.push(
        {
          name: 'ÙƒØ±Ø§Ø³Ø© Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ù…ÙˆØ§ØµÙØ§Øª.pdf',
          type: 'specifications',
          size: '2.5 MB',
          uploadDate: '2024-08-15',
          source: 'original',
        },
        {
          name: 'Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙƒÙ…ÙŠØ§Øª.xlsx',
          type: 'quantity',
          size: '1.2 MB',
          uploadDate: '2024-08-15',
          source: 'original',
        },
        {
          name: 'Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ©.dwg',
          type: 'drawings',
          size: '8.7 MB',
          uploadDate: '2024-08-15',
          source: 'original',
        },
        {
          name: 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹.pdf',
          type: 'report',
          size: '3.1 MB',
          uploadDate: '2024-08-15',
          source: 'original',
        },
        {
          name: 'Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙÙ†ÙŠ ÙˆØ§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ©.pdf',
          type: 'technical',
          size: '4.8 MB',
          uploadDate: '2024-08-20',
          source: 'technical',
        },
      )
    }

    const getFileIcon = (type: string) => {
      switch (type) {
        case 'pdf':
        case 'specifications':
        case 'report':
          return <FileText className="w-5 h-5 text-destructive" />
        case 'excel':
        case 'quantity':
          return <Grid3X3 className="w-5 h-5 text-success" />
        case 'dwg':
        case 'drawings':
          return <Building2 className="w-5 h-5 text-info" />
        case 'technical':
          return <CheckCircle className="w-5 h-5 text-accent" />
        default:
          return <FileText className="w-5 h-5 text-muted-foreground" />
      }
    }

    const handlePreview = (attachment: any) => {
      if (attachment.source === 'technical') {
        alert(`Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„ÙÙ†ÙŠ: ${attachment.name}\n\nÙ‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ØªÙ… Ø±ÙØ¹Ù‡ Ù…Ù† Ø®Ù„Ø§Ù„ ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¹ÙŠØ±`)
      } else {
        alert(`Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù„Ù: ${attachment.name}\n\nÙ‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ø³ØªÙƒÙˆÙ† Ù…ØªØ§Ø­Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹`)
      }
    }

    const handleDownload = (attachment: any) => {
      if (attachment.source === 'technical') {
        alert(`ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„ÙÙ†ÙŠ: ${attachment.name}\n\nÙ‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ØªÙ… Ø±ÙØ¹Ù‡ Ù…Ù† Ø®Ù„Ø§Ù„ ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¹ÙŠØ±`)
      } else {
        alert(`ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: ${attachment.name}\n\nÙ‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ø³ØªÙƒÙˆÙ† Ù…ØªØ§Ø­Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹`)
      }
    }

    return (
      <div className="space-y-4">
        {technicalFiles.length > 0 && (
          <div className="p-4 bg-accent/10 border border-accent/30 rounded-lg">
            <div className="flex items-center gap-2 text-accent">
              <CheckCircle className="w-5 h-5 text-accent" />
              <p className="font-medium">Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙÙ†ÙŠØ© Ù…Ù† Ø§Ù„ØªØ³Ø¹ÙŠØ±</p>
            </div>
            <p className="text-sm text-accent mt-1">
              ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ {technicalFiles.length} Ù…Ù„Ù ÙÙ†ÙŠ ØªÙ… Ø±ÙØ¹Ù‡ Ù…Ù† Ø®Ù„Ø§Ù„ ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¹ÙŠØ±.
            </p>
          </div>
        )}

        {allAttachments.map((attachment: any, index: number) => (
          <Card key={index}>
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-muted rounded-lg">{getFileIcon(attachment.type)}</div>
                  <div>
                    <div className="flex items-center gap-2">
                      <p className="font-medium">{attachment.name || `Ù…Ø±ÙÙ‚ ${index + 1}`}</p>
                      <Badge
                        variant={attachment.source === 'technical' ? 'secondary' : 'outline'}
                        className={
                          attachment.source === 'technical'
                            ? 'bg-accent/10 text-accent border-accent/30'
                            : ''
                        }
                      >
                        {attachment.source === 'technical' ? 'Ù…Ù„Ù ÙÙ†ÙŠ' : 'Ù…Ø±ÙÙ‚ Ø£Ø³Ø§Ø³ÙŠ'}
                      </Badge>
                    </div>
                    <p className="text-sm text-muted-foreground">
                      {attachment.type && `Ù†ÙˆØ¹: ${attachment.type}`}
                      {attachment.size && ` â€¢ Ø­Ø¬Ù…: ${attachment.size}`}
                      {attachment.uploadDate && ` â€¢ ØªØ§Ø±ÙŠØ®: ${attachment.uploadDate}`}
                      {attachment.source === 'pricing' && ` â€¢ Ù…Ù† Ø§Ù„ØªØ³Ø¹ÙŠØ±`}
                    </p>
                  </div>
                </div>
                <div className="flex gap-2">
                  <Button
                    variant="outline"
                    size="sm"
                    className="gap-2"
                    onClick={() => handlePreview(attachment)}
                  >
                    <Eye className="w-4 h-4" />
                    Ù…Ø¹Ø§ÙŠÙ†Ø©
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    className="gap-2"
                    onClick={() => handleDownload(attachment)}
                  >
                    <Download className="w-4 h-4" />
                    ØªØ­Ù…ÙŠÙ„
                  </Button>
                </div>
              </div>
            </CardContent>
          </Card>
        ))}
      </div>
    )
  }

  // (import moved to top-level)

  const getStatusText = (status: string) => {
    switch (status) {
      case 'new':
      case 'preparing':
        return 'Ø¬Ø¯ÙŠØ¯Ø©'
      case 'under_action':
      case 'active':
        return 'ØªØ­Øª Ø§Ù„ØªÙ†ÙÙŠØ°/Ø§Ù„ØªØ³Ø¹ÙŠØ±'
      case 'ready_to_submit':
      case 'under_review':
        return 'Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„'
      case 'pricing_in_progress':
        return 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¹ÙŠØ±'
      case 'pricing_completed':
        return 'ØªÙ… Ø§Ù„ØªØ³Ø¹ÙŠØ±'
      case 'submitted':
        return 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬'
      case 'won':
        return 'ÙØ§Ø¦Ø²Ø©'
      case 'lost':
        return 'Ø®Ø§Ø³Ø±Ø©'
      case 'expired':
        return 'Ù…Ù†ØªÙ‡ÙŠØ©'
      case 'cancelled':
        return 'ØªÙ… Ø¥Ù„ØºØ§Ø¤Ù‡Ø§'
      default:
        return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'
    }
  }

  return (
    <div className="p-4 lg:p-6 min-h-screen bg-muted overflow-y-auto" dir="rtl">
      <div className="max-w-7xl mx-auto">
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-3">
            <Button variant="outline" onClick={onBack} className="gap-2">
              <ArrowRight className="h-4 w-4" /> Ø§Ù„Ø¹ÙˆØ¯Ø©
            </Button>
            <div>
              <h1 className="text-xl lg:text-2xl font-bold">{tender.name}</h1>
              <p className="text-sm text-muted-foreground">
                {tender.client || tender.ownerEntity || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
              </p>
            </div>
          </div>
          <div className="flex items-center gap-3">
            {/* Ø²Ø± ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø¹Ø±Ø¶ - ÙŠØ¸Ù‡Ø± Ù„Ù„Ù…Ù†Ø§ÙØ³Ø§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© ØªÙ…Ø§Ù…Ø§Ù‹ */}
            {(tender.status === 'ready_to_submit' || isReadyToSubmit) && (
              <Button
                onClick={handleSubmitTender}
                className="gap-2 bg-success text-success-foreground hover:bg-success/90"
              >
                <Send className="h-4 w-4" />
                Ø§Ø±Ø³Ø§Ù„
              </Button>
            )}

            {/* Ù…Ø¯ÙŠØ± Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© - ÙŠØ¸Ù‡Ø± Ù„Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© */}
            {tender.status === 'submitted' && <TenderStatusManager tender={tender} />}

            <Badge className={`px-3 py-1 ${getStatusColor(tender.status)}`}>
              {getStatusText(tender.status)}
            </Badge>

            {/* Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø­ÙˆÙ„ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© */}
            {isReadyToSubmit && tender.status !== 'submitted' && (
              <Badge className="bg-success/10 text-success border-success/30">Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„</Badge>
            )}
            {isPricingCompleted && !isTechnicalFilesUploaded && tender.status !== 'submitted' && (
              <Badge className="bg-warning/10 text-warning border-warning/30">
                ÙŠØ­ØªØ§Ø¬ Ù…Ù„ÙØ§Øª ÙÙ†ÙŠØ©
              </Badge>
            )}
          </div>
        </div>

        {/* Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¯Ø§Ø®Ù„ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ù„Ø¶Ù…Ø§Ù† ØªØ·Ø§Ø¨Ù‚ ØªØµÙ…ÙŠÙ… Ø§Ù„ØµÙˆØ±Ø© */}

        <Tabs value={activeTab} onValueChange={setActiveTab} className="w-full">
          <div className="flex justify-center mb-4">
            <TabsList className="grid grid-cols-5 w-full max-w-4xl" dir="rtl">
              <TabsTrigger value="general" className="text-sm flex items-center gap-2">
                <Info className="w-4 h-4" />
                Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø©
              </TabsTrigger>
              <TabsTrigger value="quantity" className="text-sm flex items-center gap-2">
                <Grid3X3 className="w-4 h-4" />
                Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙƒÙ…ÙŠØ§Øª
              </TabsTrigger>
              <TabsTrigger value="attachments" className="text-sm flex items-center gap-2">
                <Paperclip className="w-4 h-4" />
                Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
              </TabsTrigger>
              <TabsTrigger value="workflow" className="text-sm flex items-center gap-2">
                <FileText className="w-4 h-4" />
                Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
              </TabsTrigger>
              <TabsTrigger value="timeline" className="text-sm flex items-center gap-2">
                <Calendar className="w-4 h-4" />
                Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ
              </TabsTrigger>
            </TabsList>
          </div>

          <div className="pb-6">
            <TabsContent value="general" className="mt-6" dir="rtl">
              <GeneralInfoTab
                tender={tender}
                isReadyToSubmit={isReadyToSubmit}
                isPricingCompleted={isPricingCompleted}
                isTechnicalFilesUploaded={isTechnicalFilesUploaded}
                formatCurrencyValue={formatCurrencyValue}
              />
            </TabsContent>

            <TabsContent value="quantity" className="mt-6" dir="rtl">
              <QuantitiesTab
                tender={tender}
                unified={unified}
                formatCurrencyValue={formatCurrencyValue}
                formatQuantity={formatQuantity}
                collapsedSections={collapsedSections}
                toggleCollapse={toggleCollapse}
              />
            </TabsContent>

            <TabsContent value="attachments" className="mt-6" dir="rtl">
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <Paperclip className="h-5 w-5" />
                    Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙˆØ§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª
                  </CardTitle>
                </CardHeader>
                <CardContent>{renderAttachments()}</CardContent>
              </Card>
            </TabsContent>

            <TabsContent value="timeline" className="mt-6" dir="rtl">
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <Calendar className="h-5 w-5" />
                    Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ Ù„Ù„Ù…Ù†Ø§ÙØ³Ø©
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="space-y-4">
                    <div className="flex items-start gap-4 p-4 bg-info/10 rounded-lg">
                      <div className="p-2 bg-info/20 rounded-full">
                        <Calendar className="w-4 h-4 text-info" />
                      </div>
                      <div>
                        <p className="font-medium">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø±</p>
                        <p className="text-sm text-muted-foreground">
                          {tender.publishDate || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                        </p>
                      </div>
                    </div>

                    <div className="flex items-start gap-4 p-4 bg-warning/10 rounded-lg">
                      <div className="p-2 bg-warning/20 rounded-full">
                        <ExternalLink className="w-4 h-4 text-warning" />
                      </div>
                      <div>
                        <p className="font-medium">Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯ Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª</p>
                        <p className="text-sm text-muted-foreground">
                          {tender.inquiryDeadline || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                        </p>
                      </div>
                    </div>

                    <div className="flex items-start gap-4 p-4 bg-destructive/10 rounded-lg">
                      <div className="p-2 bg-destructive/20 rounded-full">
                        <Clock className="w-4 h-4 text-destructive" />
                      </div>
                      <div>
                        <p className="font-medium">Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯ Ù„Ù„ØªÙ‚Ø¯ÙŠÙ…</p>
                        <p className="text-sm text-muted-foreground">
                          {tender.deadline || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                        </p>
                      </div>
                    </div>

                    <div className="flex items-start gap-4 p-4 bg-success/10 rounded-lg">
                      <div className="p-2 bg-success/20 rounded-full">
                        <CheckCircle className="w-4 h-4 text-success" />
                      </div>
                      <div>
                        <p className="font-medium">ØªØ§Ø±ÙŠØ® Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬</p>
                        <p className="text-sm text-muted-foreground">
                          {tender.resultDate || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                        </p>
                      </div>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </TabsContent>

            {/* ØªØ¨ÙˆÙŠØ¨ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */}
            <TabsContent value="workflow" className="mt-6" dir="rtl">
              <div className="space-y-6">
                {/* Ø·Ø±ÙŠÙ‚Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø³Ø±ÙŠØ¹Ø© */}
                <TenderQuickResults
                  tender={localTender}
                  onUpdate={() => {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
                    void import('@/events/bus').then(({ APP_EVENTS, emit }) =>
                      emit(APP_EVENTS.TENDER_UPDATED),
                    )
                  }}
                />

                {/* Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */}
                <TenderResultsManager
                  tender={localTender}
                  onUpdate={() => {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
                    void import('@/events/bus').then(({ APP_EVENTS, emit }) =>
                      emit(APP_EVENTS.TENDER_UPDATED),
                    )
                  }}
                />
              </div>
            </TabsContent>
          </div>
        </Tabs>
      </div>

      {/* Ø­ÙˆØ§Ø± ØªØ£ÙƒÙŠØ¯ ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø¹Ø±Ø¶ */}
      <AlertDialog open={showSubmitDialog} onOpenChange={setShowSubmitDialog}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle className="flex items-center gap-2">
              <Send className="h-5 w-5 text-success" />
              ØªØ£ÙƒÙŠØ¯ ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø¹Ø±Ø¶
            </AlertDialogTitle>
            <AlertDialogDescription>
              Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ù…Ù†Ø§ÙØ³Ø© &quot;{tender.name}&quot;ØŸ
              <br />
              Ø³ÙŠØªÙ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© Ø¥Ù„Ù‰ &quot;ØªÙ… Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…&quot; ÙˆÙ„Ù† ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Ø¥Ù„ØºØ§Ø¡</AlertDialogCancel>
            <AlertDialogAction
              onClick={handleConfirmSubmit}
              className="bg-success text-success-foreground hover:bg-success/90"
            >
              ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø±Ø³Ø§Ù„
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  )
}
